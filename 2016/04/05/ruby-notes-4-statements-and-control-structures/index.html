<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bing WebMaster -->
  <meta name="msvalidate.01" content="AB2FFF876C37F59D9121882CC8395DE5" />

  <title>Ruby Notes 4 Statements and Control Structures</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://blog.codefarm.me/2016/04/05/ruby-notes-4-statements-and-control-structures/">
  <link rel="alternate" type="application/rss+xml" title="CODE FARM" href="https://blog.codefarm.me/feed.xml">

  <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->
<script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>

  
<!-- Google Analytics Website tracking -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83971182-1', 'auto');
  ga('send', 'pageview');

</script>


  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SN88FJ18E5');
</script>



</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
    <h2 class="site-title">
      <a class="site-title" href="/">CODE FARM</a>
    </h2>

     <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
        <div class="trigger">
            <ul>
                <li><a href="/">home</a>
                <li><a href="/category">category</a>
                <li><a href="/tag">tag</a>
                <li><a href="/archive">archive</a>
                <li><a href="/about">about</a>
                <li><a href="https://resume.github.io/?qqbuby" target="_blank">R&eacute;sum&eacute;</a>
            </ul>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Ruby Notes 4 Statements and Control Structures</h1>
    
    
    <p class="post-meta"><time datetime="2016-04-05T04:37:29+08:00" itemprop="datePublished">Apr 5, 2016</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>A sequential program that are executed one line of code after the other without branching or repetition.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>x = ARGV[0].to_f # Convert first argument to a number
y = ARGV[1].to_f # Convert second argument to a number
sum = x + y      # Add the arguments
puts sum         # Print the sum
</code></pre></div></div>

<p>Alter the sequential execution, or <em>flow-of-control</em>, of a program with Ruby’s <strong>control structures</strong>.</p>

<ul>
  <li>Conditionals</li>
  <li>Loops</li>
  <li>Iterators and blocks</li>
  <li>Flow-altering satements like <strong>return</strong> and <strong>break</strong></li>
  <li>Exceptions</li>
  <li>The special-case BEGIN and END statements</li>
  <li>The esoteric control structures known as <strong>fibers</strong> and <strong>continuations</strong></li>
</ul>

<h3 id="conditionals">Conditionals</h3>

<ol>
  <li>
    <p>if</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> if expression
     code
 end
</code></pre></div>    </div>

    <p>The <code class="language-plaintext highlighter-rouge">code</code> between <code class="language-plaintext highlighter-rouge">if</code> and <code class="language-plaintext highlighter-rouge">end</code> is executed if (and only if) the <code class="language-plaintext highlighter-rouge">expression</code> evaluates to something other than <code class="language-plaintext highlighter-rouge">false</code> or <code class="language-plaintext highlighter-rouge">nil</code>.</p>

    <p>The <code class="language-plaintext highlighter-rouge">code</code> must be separated from the <code class="language-plaintext highlighter-rouge">expression</code> with a <em>newline</em> or <em>semicolon</em> or the keyword <code class="language-plaintext highlighter-rouge">then</code>.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    # If x is less than 10, increment it

    if x &lt; 10 # newline separator
    x += 1
    end
       
    if x &lt; 10 then x += 1 end # then separator
       
    if x &lt; 10 then
        x += 1
    end
</code></pre></div>    </div>

    <ul>
      <li>
        <p><strong>else</strong></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  if expression
      code
  else
      code
  end
</code></pre></div>        </div>
      </li>
      <li>
        <p><strong>elsif</strong></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  if expression1
      code1
  elsif expression2
      code2
      .
      .
      .
  elsif expressionN
      codeN
  else
      code
  end
</code></pre></div>        </div>
      </li>
      <li>
        <p><strong>Return value</strong></p>

        <p>The return value of an <code class="language-plaintext highlighter-rouge">if</code> “statement” (i.e., the value that results from evaluating an if expression) is <em>the value of the last expression</em> in the code that was executed, or <code class="language-plaintext highlighter-rouge">nil</code> if no block of code was executed.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>if As a Modifer</p>

    <p>Instead of writing:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> if expression then code end
</code></pre></div>    </div>

    <p>we can simply write:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> code if expression
</code></pre></div>    </div>
  </li>
  <li>
    <p>unless</p>

    <p><code class="language-plaintext highlighter-rouge">unless</code>, as a statement or a modifier, is the opposite of <code class="language-plaintext highlighter-rouge">if</code>: it executes code only if an associated expression evaluates to <code class="language-plaintext highlighter-rouge">false</code> or <code class="language-plaintext highlighter-rouge">nil</code>. Its syntax is just like <code class="language-plaintext highlighter-rouge">if</code>, except that <code class="language-plaintext highlighter-rouge">elsif</code> clauses are <em>not</em> allowed:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> # single-way unless statement
 unless condition
     code
 end
    
 # two-way unless statement
 unless condition
     code
 else
     code
 end
    
 # unless modifier
 code unless condition
</code></pre></div>    </div>
  </li>
  <li>
    <p>case</p>

    <p>The <code class="language-plaintext highlighter-rouge">case</code> statement is a multiway conditional. There are two forms of this statement.</p>

    <ul>
      <li>
        <p><em>if/elsif/else</em></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  name = case                             name =
  when x == 1 then "one"                  if x == 1 then "one" 
  when x == 2 then "two"                  elsif x == 2 then "two"
  when x == 3 then "three"                elsif x == 3 then "three"
  when x == 4 then "four"                 elsif x == 4 then "four"
  else "many"                             else "many"
  end                                     end
</code></pre></div>        </div>

        <p><em>the <code class="language-plaintext highlighter-rouge">then</code> keyword replaced with a newline or semicolon</em></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  case
  when x == 1
      "one"
  when x == 2
      "two"
  when x == 3
      "three"
  end
</code></pre></div>        </div>
      </li>
      <li>
        <p><em>case equality</em></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  name = 
  case x
  when 1              # Just the value to compare to x
      "one"
  when 2 then "two"   # Then keyword instead of newline
  when 3; "three"     # Semicolon instead of newline
  else "many"         # Optional else clause at end
  end
</code></pre></div>        </div>

        <p><em>same as</em></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  name = case
  when 1 === x then "one"
  when 2 === x then "two" 
  when 3 === x then "three" 
  else "many"
  end
</code></pre></div>        </div>

        <p><em>eg.1</em></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  # Take different actions depending on the class of x 
  puts case x
  when String then "string"
  when Numeric then "number"
  when TrueClass, FalseClass then "boolean"
  else "other"
  end
</code></pre></div>        </div>

        <p><em>eg.2</em></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  # Compute 2006 U.S. income tax using case and Range objects
  tax = case income
        when 0..7550
            income * 0.1
        when 7550..30650
            755 + (income-7550)*0.15
        when 30650..74200
            4220 + (income-30655)*0.25
        when 74200..154800
            15107.5 + (income-74201)*0.28
        when 154800..336550
            37675.5 + (income-154800)*0.33
        else
            97653 + (income-336550)*0.35
        end
</code></pre></div>        </div>

        <p><em>eg.3</em></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  # Get user's input and process it, ignoring comments and exiting
  # when the user enters the word "quit"
  while line=gets.chomp do    # Loop, asking the user for input each time
      case line
      when /^\s*#/            # If input looks like a comment...
          next                # skip to the next line.
      when /^quit$/i          # If input is "quit" (case insensitive)...
          break               # exit the loop.
      else                    # Otherwise...
          puts line.reverse   # reverse the user's input and print it.
      end
  end
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<h4 id="loops">Loops</h4>

<ol>
  <li>while and until
    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">while</code></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  x = 10          # Initialize a loop counter variable
  while x &gt;= 0 do # Loop while x is greater than or equal to 0
      puts x      # Print out the value of x
      x = x - 1    # Subtract 1 from x
  end             # The loop ends here
</code></pre></div>        </div>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">until</code></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  # Count back up to 10 using an until loop
  x = 0           # Start at 0 (instead of -1)
  until x &gt; 10 do # Loop until x is greater than 10
      puts x
      x = x + 1 
  end             # Loop ends here
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>while and until As Modifiers</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">while</code></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  x = 0                       # Initialize loop variable
  puts x = x + 1 while x &lt; 10 # Output and increment in a single expression
</code></pre></div>        </div>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">until</code></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  a = [1,2,3]                 # Initialize an array
  puts a.pop until a.empty?   # Pop elements from array until empty
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>The for/in Loop</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> for var in collection do
     body
 end
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="altering-control-flow">Altering Control Flow</h3>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">return</code></p>

    <p>Causes a method to exit and return a value to its caller.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">break</code></p>

    <p>Causes a loop (or iterator) to exit.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">next</code></p>

    <p>Causes a loop (or iterator) to skip the rest of the current iteration and move on to the next iteration.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">redo</code></p>

    <p>Restarts a loop or iterator from the begining.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">retry</code></p>

    <p>Restarts an iterator, reevaluating the entire expression. The <code class="language-plaintext highlighter-rouge">retry</code> keyword can aslo be used in exception handling.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">throw/catch</code></p>

    <p>A very general control struture that is named like and works like an exception progagation and handling mechanism. <code class="language-plaintext highlighter-rouge">throw</code> and <code class="language-plaintext highlighter-rouge">catch</code> are not Ruby’s primary exception mechanism (that would be <code class="language-plaintext highlighter-rouge">raise</code> and <code class="language-plaintext highlighter-rouge">rescue</code>). Instead, they are used as a kind of multilevel or labeled <code class="language-plaintext highlighter-rouge">break</code>.</p>
  </li>
</ul>

<h3 id="exceptions-and-exception-handling">Exceptions and Exception Handling</h3>

<ol>
  <li>
    <p>Exception Classes and Exception Objects</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Object
     +--Exception
         +--NoMemoryError
         +--ScriptError
         | +--LoadError
         | +--NotImplementedError
         | +--SyntaxError
     +--SecurityError        # Was a StandardError in 1.8
     +--SignalException
     | +--Interrupt
     +--SystemExit
     +--SystemStackError     # Was a StandardError in 1.8
     +--StandardError
         +--ArgumentError
         +--FiberError       # New in 1.9
         +--IOError
         | +--EOFError
         +--IndexError
         | +--KeyError       # New in 1.9
         | +--StopIteration  # New in 1.9
         +--LocalJumpError
         +--NameError
         | +--NoMethodError
         +--RangeError
         | +--FloatDomainError
         +--RegexpError
         +--RuntimeError
         +--SystemCallError
         +--ThreadError
         +--TypeError
         +--ZeroDivisionError
</code></pre></div>    </div>

    <p><em>The Ruby Exception Class Hierarchy</em></p>

    <ul>
      <li>
        <p><strong>The methods of exception objects</strong></p>

        <ul>
          <li>
            <p><code class="language-plaintext highlighter-rouge">message</code></p>

            <p>The <code class="language-plaintext highlighter-rouge">message</code> method returns a string that my provide human-readable details about what went wrong.</p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">backtrace</code></p>

            <p>The <code class="language-plaintext highlighter-rouge">backtrace</code> method returns an array of strings that represents the call stack at the point that exception was raised.</p>

            <p>Each element of the array is a string of the form:</p>

            <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  filename:linenumber:in `methodname'
</code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Raising Exceptions with <code class="language-plaintext highlighter-rouge">raise</code></p>

    <p>The <em>Kernel</em> method <code class="language-plaintext highlighter-rouge">raise</code> raises an exception. <code class="language-plaintext highlighter-rouge">fail</code> is a synonym that is sometimes used when the exceptation is that the exception will cause the program to exit.</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">raise</code> with on arguments</p>

        <p>If <code class="language-plaintext highlighter-rouge">raise</code> is called with no arguments, it creates a new <code class="language-plaintext highlighter-rouge">RuntimeError</code> object (with no message) and raises it. Or, if <code class="language-plaintext highlighter-rouge">raise</code> is used with no arguments inside a <code class="language-plaintext highlighter-rouge">rescue</code> clause, it simply re-raises the exception that was being handled.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">raise</code> with a single <code class="language-plaintext highlighter-rouge">Exception</code> object</p>

        <p>If <code class="language-plaintext highlighter-rouge">raise</code> is called with a single <code class="language-plaintext highlighter-rouge">Exception</code> object as its argument, it raises that exception. Despite its simplicity, this is <em>not actually a common way</em> to use <code class="language-plaintext highlighter-rouge">raise</code>.</p>
      </li>
      <li>
        <p>‘raise` with a single string argument</p>

        <p>If <code class="language-plaintext highlighter-rouge">raise</code> is called with a single string argument, it creates a new <code class="language-plaintext highlighter-rouge">RuntimeError</code> exception object, with the specified string as its message, and raises that exception. This is a <em>very common way</em> to use <code class="language-plaintext highlighter-rouge">raise</code>.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">raise</code> with an object that has an <code class="language-plaintext highlighter-rouge">exception</code> method</p>

        <p>If the first argument to <code class="language-plaintext highlighter-rouge">raise</code> is an object that has an <code class="language-plaintext highlighter-rouge">exception</code> method, then <code class="language-plaintext highlighter-rouge">raise</code> invokes that method and raises the <code class="language-plaintext highlighter-rouge">Exception</code> object that its returns. The <code class="language-plaintext highlighter-rouge">Exception</code> class defines an <code class="language-plaintext highlighter-rouge">exception</code> method, so you can specify the class object for any kind of exception as the first argument to <code class="language-plaintext highlighter-rouge">raise</code>.</p>

        <p><code class="language-plaintext highlighter-rouge">raise</code> accepts a string as its optional second argument to use as the exception message.</p>

        <p><code class="language-plaintext highlighter-rouge">raise</code> also accepts an optional third argument. An array of strings may be specified here, and they will be used as the backtrace for the exception object. If this third argument is not specified, <code class="language-plaintext highlighter-rouge">raise</code> sets the backtrace of the exception itself (using the <em>Kernel</em> method <code class="language-plaintext highlighter-rouge">caller</code>).</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Handling Exceptions with <code class="language-plaintext highlighter-rouge">rescue</code></p>

    <p><code class="language-plaintext highlighter-rouge">raise</code> is a <em>Kernel</em> method.</p>

    <p>A <code class="language-plaintext highlighter-rouge">rescue</code> clause, by contrast, is a fundamental part of the Ruby language.</p>

    <p><code class="language-plaintext highlighter-rouge">rescue</code> is not a statement in its own right, but rather a clause that can be attached to other Ruby statements.</p>

    <p>Most commonly, a <code class="language-plaintext highlighter-rouge">rescue</code> clause is attached to a <code class="language-plaintext highlighter-rouge">begin</code> statement.</p>

    <p>The <code class="language-plaintext highlighter-rouge">begin</code> statement exists simply to delimit the block of code within which exceptions are to be handled.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> begin
     # Any number of Ruby statements go here.
     # Usually, they are executed without exceptions and # execution continues after the end statement.
 rescue
     # This is the rescue clause; exception-handling code goes here.
     # If an exception is raised by the code above, or propagates up
     # from one of the methods called above, then execution jumps here.
 end
</code></pre></div>    </div>

    <ul>
      <li>
        <p><strong>Naming the exception object</strong></p>

        <p>In a <code class="language-plaintext highlighter-rouge">rescue</code> clause, the global variable <code class="language-plaintext highlighter-rouge">$!</code> refers to the <code class="language-plaintext highlighter-rouge">Exception</code> object that is being handled.</p>

        <p>If your program includes the line:</p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  require 'English'
</code></pre></div>        </div>

        <p>then you can use the global variable <code class="language-plaintext highlighter-rouge">$ERROR_INFO</code> instead.</p>

        <p>A better alternative to <code class="language-plaintext highlighter-rouge">$!</code> or <code class="language-plaintext highlighter-rouge">$ERROR_INFO</code> is to specify a variable name for the exception object in the <code class="language-plaintext highlighter-rouge">rescue</code> itself:</p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  rescue =&gt; ex
</code></pre></div>        </div>

        <p>The statements of this <code class="language-plaintext highlighter-rouge">rescue</code> clause can now use the varible <code class="language-plaintext highlighter-rouge">ex</code> to refer to the <code class="language-plaintext highlighter-rouge">Exception</code> object that describes the exception.</p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  begin                                 # Handle exceptions in this block
      x = factorial(-1)                 # Note illegal argument
  rescue =&gt; ex                          # Store exception in variable ex
      puts "#{ex.class}: #{ex.message}" # Handle exception by printing message
  end                                   # End the begin/rescue block
</code></pre></div>        </div>
      </li>
      <li>
        <p><strong>Handling exceptions by type</strong></p>

        <p>The <code class="language-plaintext highlighter-rouge">rescue</code> clause show here handle any exception that is a <code class="language-plaintext highlighter-rouge">StandardError</code> (or subclass) and ignore any <code class="language-plaintext highlighter-rouge">Exception</code> object that is not <code class="language-plaintext highlighter-rouge">StandardError</code>.</p>

        <p>If you want to handle nonstandard exceptions outside the <code class="language-plaintext highlighter-rouge">StandardError</code> hierarchy, or if you want to handle only specific types of exceptions, you must include one or more exception classes in the <code class="language-plaintext highlighter-rouge">rescue</code> clause.</p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  rescue Exception

  rescue ArgumentError =&gt; e

  rescue ArgumentError, TypeError =&gt; error
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">else</code> Clause</p>

    <p>The <code class="language-plaintext highlighter-rouge">else</code> clause is an alternative to the <code class="language-plaintext highlighter-rouge">rescue</code> clauses; it is used if none of the <code class="language-plaintext highlighter-rouge">rescue</code> clauses are needed.</p>

    <p>The code in an <code class="language-plaintext highlighter-rouge">else</code> clause is executed if the code in the body of the begin statement runs to completion <em>without exceptions</em>.</p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">ensure</code> Clause</p>

    <p>The <code class="language-plaintext highlighter-rouge">ensure</code> clause contains code that always runs, no matter what happens with the code following <code class="language-plaintext highlighter-rouge">begin</code>:</p>

    <ul>
      <li>
        <p>If the code <em>runs to completion</em>, then control jumps to the <code class="language-plaintext highlighter-rouge">else</code> clause—if there is one—and then to the <code class="language-plaintext highlighter-rouge">ensure</code> clause.</p>
      </li>
      <li>
        <p>If the code executes a <code class="language-plaintext highlighter-rouge">return</code> statement, then the execution skip the <code class="language-plaintext highlighter-rouge">else</code> clause and jump directly to the <code class="language-plaintext highlighter-rouge">ensure</code> clause before returing.</p>
      </li>
      <li>
        <p>If the code following <code class="language-plaintext highlighter-rouge">begin</code> raises an exception, then control jumps to the appropriate <code class="language-plaintext highlighter-rouge">rescue</code> clause, then to the <code class="language-plaintext highlighter-rouge">ensure</code> clause.</p>
      </li>
      <li>
        <p>If there no <code class="language-plaintext highlighter-rouge">rescue</code> clause, or if no <code class="language-plaintext highlighter-rouge">rescue</code> clause can handle the exception, then control jumps directly to the <code class="language-plaintext highlighter-rouge">ensure</code> clause. The code in the <code class="language-plaintext highlighter-rouge">ensure</code> clause is executed before the exception propagates out to containing blocks or up the call stack.</p>
      </li>
    </ul>

    <p>The purpose of the <code class="language-plaintext highlighter-rouge">ensure</code> clause is to ensure that housekeeping details such as closing files, disconnecting database connections, and committing or aborting transactions get taken care of.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">rescue</code> As a Statement Modifier</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> # Compute factorial of x, or use 0 if the method raises an exception 
 y = factorial(x) rescue 0
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="begin-and-end">BEGIN and END</h3>

<p><code class="language-plaintext highlighter-rouge">BEGIN</code> and <code class="language-plaintext highlighter-rouge">END</code> are reserved words in Ruby that declare code to be executed at the very beginning and very end of a Ruby program.</p>

<p>If there is more than one <code class="language-plaintext highlighter-rouge">BEGIN</code> statement in a program, they are executed in the order which the interpreter encounters them.</p>

<p>If there is more than one <code class="language-plaintext highlighter-rouge">END</code> statement, they are executed in the reverse of the order in which they are encountered—that is, the first one is executed last.</p>

<p>These statements are not commonly used in Ruby. They are inherited from Perl, which in turn inherited them from the awk text-processing language.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    BEGIN { # The curly braces are required
        # Global initialization code goes here
    }
    
    END {
        # Global shutdown code goes here
    }
</code></pre></div></div>

<h3 id="threads-fibers-and-continuations">Threads, Fibers, and Continuations</h3>

<ol>
  <li>
    <p>Threads for Concurrency</p>

    <p>A <em>thread of execution</em> is a sequence of Ruby statements that run (or apear to run) in parallel with the main sequence of statements that the interpreter is running.</p>

    <p>Threads are represented by <code class="language-plaintext highlighter-rouge">Thread</code> objects, but they can also be thought of as control structures for concurrency.</p>

    <p>Call <code class="language-plaintext highlighter-rouge">Thread.new</code> and associate a block with it to create new threads that will start running the code in the block.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> # This method expects an array of filenames.
 # It returns an array of strings holding the content of the named files.
 # The method creates one thread for each named file.
 def readfiles(filenames)
     # Create an array of threads from the array of filenames.
     # Each thread starts reading a file.
     threads = filenames.map do |f|
         Thread.new { File.read(f) }
     end
    
     # Now create an array of file contents by calling the value 
     # method of each thread. This method blocks, if necessary, 
     # until the thread exits with a value.
     threads.map {|t| t.value }
 end
</code></pre></div>    </div>
  </li>
  <li>
    <p>Fibers for Coroutines</p>

    <p>The name “fiber” has been used elsewhere for a kind of lightweight thread, but Ruby’s fibers are better described as <em>coroutines</em> or, more accurately, <em>semi-coroutines</em>.</p>

    <p>The most common use for coroutines is to implement <em>generators</em>: objects that can compute a partial result, <em>yield</em> the result back to the caller, and save the state of the computaiton so that the caller can <em>resume</em> that compuation to obtain the next result.</p>

    <p>In Ruby, the <code class="language-plaintext highlighter-rouge">Fiber</code> class is used to enable the automatic conversion of internal iterators, such as the <code class="language-plaintext highlighter-rouge">each</code> method, into enumerators or external iterators.</p>

    <p>Create a fiber with <code class="language-plaintext highlighter-rouge">Fiber.new</code>, and associate a block with it to specify the code that the fiber to run.</p>

    <p>Unlike a thread, the body of a fiber does not start executing right away.</p>

    <p>To run a fiber, call the <code class="language-plaintext highlighter-rouge">resume</code> method of the <code class="language-plaintext highlighter-rouge">Fiber</code> object that represent it.</p>

    <p>The first time <code class="language-plaintext highlighter-rouge">resume</code> is called on a fiber, control is transferred to the begining of the fiber body.</p>

    <p>That fiber then runs unitl it reachs the end of the body, or unitl it executes the class method <code class="language-plaintext highlighter-rouge">Fiber.yield</code>.</p>

    <p>The <code class="language-plaintext highlighter-rouge">Fiber.yield</code> method transfer control back to the caller and makes the call to <code class="language-plaintext highlighter-rouge">resume</code> return. It also saves the state of the fiber, so that the next call to <code class="language-plaintext highlighter-rouge">resume</code> makes the fiber pick up where it left off.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     f = Fiber.new {                 # Line 1: Create a new fiber
         puts "Fiber says Hello"     # Line 2:
         Fiber.yield                 # Line 3:
         puts "Fiber says Goodbye"   # Line 4: goto line 11
     }                               # Line 5:
                                     # Line 6:
     puts "Caller says Hello"        # Line 7:
     f.resume                        # Line 8: goto line 2
     puts "Caller says Goodbye"      # Line 9:
     f.resume                        # Line 10: goto line 4
                                     # Line 11:
</code></pre></div>    </div>

    <ul>
      <li>
        <p><strong>Fiber arguments and return values</strong></p>

        <p>Fibers and their callers can exchange data through the arguments and return values of <code class="language-plaintext highlighter-rouge">resume</code> and <code class="language-plaintext highlighter-rouge">yield</code>.</p>

        <p>The arguments to the first call to <code class="language-plaintext highlighter-rouge">resume</code> are passed to the block associated with the fiber: they become the values of the block parameters.</p>

        <p>On subsequent calls, the arguments to <code class="language-plaintext highlighter-rouge">resume</code> become the return value of <code class="language-plaintext highlighter-rouge">Fiber.yield</code>.</p>

        <p>Conversely, any arguments to <code class="language-plaintext highlighter-rouge">Fiber.yield</code> become the return value of <code class="language-plaintext highlighter-rouge">resume</code>.</p>

        <p>And when the block exits, the value of the <em>last expression</em> evaluated also becomes the return value of <em>resume</em>.</p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  f = Fiber.new do |message|
      puts "Caller said: #{message}" 
      message2 = Fiber.yield("Hello") # "Hello" returned by first resume
      puts "Caller said: #{message2}"
      "Fine"                          # "Fine" returned by second resume
  end
        
  response = f.resume("Hello")         # "Hello" passed to block
  puts "Fiber said: #{response}"
  response2 = f.resume("How are you?") # "How are you?" returned by Fiber.yield 
  puts "Fiber said: #{response2}"
</code></pre></div>        </div>
      </li>
      <li>
        <p><strong>Implementing generators with fibers</strong></p>

        <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  class FibonacciGenerator
      def initialize
          @x,@y = 0,1
          @fiber = Fiber.new do
              loop do
                  @x,@y = @y, @x+@y
                  Fiber.yield @x
              end
          end
      end
        
      def next    # Return the next Fibonacci number
          @fiber.resume
      end
        
      def rewind  # Restart the sequence
          @x,@y = 0,1
      end
  end
        
  g = FibonacciGenerator.new     # Create a generator
  10.times { print g.next, " " } # Print first 10 numbers
  g.rewind; puts                 # Start over, on a new line
  10.times { print g.next, " " } # Print first 10 again
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Continuations</p>
  </li>
</ol>

<p>A <code class="language-plaintext highlighter-rouge">continuation</code> is another complex and obscure control structure that most programmers will <em>never need to use</em>.</p>

<p>A <code class="language-plaintext highlighter-rouge">continuation</code> takes the form of the Kernel method callcc and the <code class="language-plaintext highlighter-rouge">Continuation</code> object.</p>

<p>Continuations are part of the core platformin Ruby 1.8, but they have been replaced by fibers and moved to the standard library in Ruby 1.9.</p>

<hr />

<h4 id="references">References</h4>

<ul>
  <li><a href="http://www.amazon.com/Ruby-Programming-Language-David-Flanagan/dp/0596516177/ref=sr_1_1?ie=UTF8&amp;qid=1459784613&amp;sr=8-1&amp;keywords=The+Ruby+Programming+Language">The Ruby Programming Language by David Flanagan and Yukihiro Matsumoto</a></li>
</ul>

  </div>

  <ul class="post-navigation">
    <li>
      
      <a href="/2016/04/05/ruby-notes-3-expression-and-operators/">&laquo; Ruby Notes 3 Expression and Operators</a>
      
    </li>
    <li>
      
      <a href="/2016/04/05/ruby-notes-5-methods-procs-lambdas-and-closures/">Ruby Notes 5 Methods, Procs, Lambdas, and Closures &raquo;</a>
      
    </li>
  </ul>
</article>

      </div>
    </div>

    <footer class="site-footer">
  <div class="license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details open>
    <summary>Extral Links</summary>
    <div>
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>


<!-- https://github.com/bryanbraun/anchorjs -->
<script src="/js/anchor.min.js"></script>
<script>
  anchors.add();
  anchors.remove(".site-title");
</script>




  </body>

</html>

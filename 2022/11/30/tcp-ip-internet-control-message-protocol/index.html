<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bing WebMaster -->
  <meta name="msvalidate.01" content="AB2FFF876C37F59D9121882CC8395DE5" />

  <title>TCP/IP: Internet Control Message Protocol</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://blog.codefarm.me/2022/11/30/tcp-ip-internet-control-message-protocol/">
  <link rel="alternate" type="application/rss+xml" title="CODE FARM" href="https://blog.codefarm.me/feed.xml">

  <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->
<script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>

  
<!-- Google Analytics Website tracking -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83971182-1', 'auto');
  ga('send', 'pageview');

</script>


  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SN88FJ18E5');
</script>



</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
    <h2 class="site-title">
      <a class="site-title" href="/">CODE FARM</a>
    </h2>

     <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
        <div class="trigger">
            <ul>
                <li><a href="/">home</a>
                <li><a href="/category">category</a>
                <li><a href="/tag">tag</a>
                <li><a href="/archive">archive</a>
                <li><a href="/about">about</a>
                <li><a href="https://resume.github.io/?qqbuby" target="_blank">R&eacute;sum&eacute;</a>
            </ul>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">TCP/IP: Internet Control Message Protocol</h1>
    
    
    <p class="post-meta"><time datetime="2022-11-30T11:44:23+08:00" itemprop="datePublished">Nov 30, 2022</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The IP protocol alone provides no direct way for an end system to learn the fate of IP packets that fail to make it to their destinations.</p>
</div>
<div class="paragraph">
<p>In addition, IP provides no direct way of obtaining diagnostic information (e.g., which routers are used along a path or a method to estimate the round-trip time).</p>
</div>
<div class="paragraph">
<p>To address these deficiencies, a special protocol called the <strong>Internet Control Message Protocol</strong> (<strong>ICMP</strong>) [RFC0792] [RFC4443] is used in conjunction with IP to provide <em>diagnostics</em> and <em>control</em> information related to the configuration of the IP protocol layer and the disposition of IP packets.</p>
</div>
<div class="paragraph">
<p>ICMP is often considered part of the IP layer itself, and it is required to be present with any IP implementation. It uses the IP protocol for transport.</p>
</div>
<div class="paragraph">
<p>ICMP provides for the delivery of error and control messages that may require attention.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ICMP messages are usually acted on by the IP layer itself, by higher-layer transport protocols (e.g., TCP or UDP), and in some cases by user applications.</p>
</li>
<li>
<p>Note that ICMP does not provide reliability for IP.</p>
<div class="paragraph">
<p>Rather, it indicates certain classes of failures and configuration information.</p>
</div>
</li>
<li>
<p>The most common cause of packet drops (buffer overrun at a router) does not elicit any ICMP information.</p>
<div class="paragraph">
<p>Other protocols, such as TCP, handle such situations.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Because of the ability of ICMP to affect the operation of important system functions and obtain configuration information, hackers have used ICMP messages in a large number of attacks. As a result of concerns about such attacks, network administrators often arrange to <em>block ICMP messages with firewalls</em>, especially at border routers. If ICMP is blocked, however, a number of common diagnostic utilities (e.g., <em>ping</em>, <em>traceroute</em>) do not work properly [RFC4890].</p>
</div>
<div class="paragraph">
<p>In IPv6, ICMPv6 is used for several purposes beyond simple error reporting and signaling.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is used for <em>Neighbor Discovery (ND)</em> [RFC4861], which plays the same role as <em>ARP</em> does for IPv4.</p>
</li>
<li>
<p>It also includes the <em>Router Discovery</em> function used for configuring hosts and <em>multicast address management</em>.</p>
</li>
<li>
<p>Finally, it is also used to help manage handoffs in <em>Mobile IPv6</em>.</p>
</li>
</ul>
</div>
</div>
<div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#encapsulation-in-ipv4-and-ipv6">1. Encapsulation in IPv4 and IPv6</a></li>
<li><a href="#icmp-messages">2. ICMP Messages</a>
<ul class="sectlevel2">
<li><a href="#icmpv4-messages">2.1. ICMPv4 Messages</a></li>
<li><a href="#icmpv6-messages">2.2. ICMPv6 Messages</a></li>
<li><a href="#processing-of-icmp-messages">2.3. Processing of ICMP Messages</a></li>
</ul>
</li>
<li><a href="#icmp-error-messages">3. ICMP Error Messages</a>
<ul class="sectlevel2">
<li><a href="#destination-unreachable-icmpv4-type-3-icmpv6-type-1-and-packet-too-big-icmpv6-type-2">3.1. Destination Unreachable (ICMPv4 Type 3, ICMPv6 Type 1) and Packet Too Big (ICMPv6 Type 2)</a>
<ul class="sectlevel3">
<li><a href="#icmpv4-host-unreachable-code-1-and-icmpv6-address-unreachable-code-3">3.1.1. ICMPv4 Host Unreachable (Code 1) and ICMPv6 Address Unreachable (Code 3)</a></li>
<li><a href="#icmpv6-no-route-to-destination-code-0">3.1.2. ICMPv6 No Route to Destination (Code 0)</a></li>
<li><a href="#icmpv4-port-unreachable-code-3-and-icmpv6-port-unreachable-code-4">3.1.3. ICMPv4 Port Unreachable (Code 3) and ICMPv6 Port Unreachable (Code 4)</a></li>
<li><a href="#icmpv4-ptb-code-4">3.1.4. ICMPv4 PTB (Code 4)</a></li>
<li><a href="#icmpv6-ptb-type-2-code-0">3.1.5. ICMPv6 PTB (Type 2, Code 0)</a></li>
<li><a href="#icmpv6-beyond-scope-of-source-address-code-2">3.1.6. ICMPv6 Beyond Scope of Source Address (Code 2)</a></li>
<li><a href="#icmpv6-source-address-failed-ingressegress-policy-code-5">3.1.7. ICMPv6 Source Address Failed Ingress/Egress Policy (Code 5)</a></li>
<li><a href="#icmpv6-reject-route-to-destination-code-6">3.1.8. ICMPv6 Reject Route to Destination (Code 6)</a></li>
</ul>
</li>
<li><a href="#redirect-icmpv4-type-5-icmpv6-type-137">3.2. Redirect (ICMPv4 Type 5, ICMPv6 Type 137)</a></li>
<li><a href="#icmp-time-exceeded-icmpv4-type-11-icmpv6-type-3">3.3. ICMP Time Exceeded (ICMPv4 Type 11, ICMPv6 Type 3)</a></li>
<li><a href="#parameter-problem-icmpv4-type-12-icmpv6-type-4">3.4. Parameter Problem (ICMPv4 Type 12, ICMPv6 Type 4)</a></li>
</ul>
</li>
<li><a href="#icmp-queryinformational-messages">4. ICMP Query/Informational Messages</a>
<ul class="sectlevel2">
<li><a href="#echo-requestreply-ping-icmpv4-types-08-icmpv6-types-129128">4.1. Echo Request/Reply (ping) (ICMPv4 Types 0/8, ICMPv6 Types 129/128)</a></li>
<li><a href="#router-discovery-router-solicitation-and-advertisement-icmpv4-types-9-10">4.2. Router Discovery: Router Solicitation and Advertisement (ICMPv4 Types 9, 10)</a></li>
<li><a href="#multicast-listener-queryreportdone-icmpv6-types-130131132">4.3. Multicast Listener Query/Report/Done (ICMPv6 Types 130/131/132)</a></li>
<li><a href="#version-2-multicast-listener-discovery-mldv2-icmpv6-type-143">4.4. Version 2 Multicast Listener Discovery (MLDv2) (ICMPv6 Type 143)</a></li>
</ul>
</li>
<li><a href="#neighbor-discovery-in-ipv6">5. Neighbor Discovery in IPv6</a>
<ul class="sectlevel2">
<li><a href="#icmpv6-router-solicitation-and-advertisement-icmpv6-types-133-134">5.1. ICMPv6 Router Solicitation and Advertisement (ICMPv6 Types 133, 134)</a></li>
<li><a href="#icmpv6-neighbor-solicitation-and-advertisement-imcpv6-types-135-136">5.2. ICMPv6 Neighbor Solicitation and Advertisement (IMCPv6 Types 135, 136)</a></li>
<li><a href="#icmpv6-inverse-neighbor-discovery-solicitationadvertisement-icmpv6-types-141142">5.3. ICMPv6 Inverse Neighbor Discovery Solicitation/Advertisement (ICMPv6 Types 141/142)</a></li>
<li><a href="#neighbor-unreachability-detection-nud">5.4. Neighbor Unreachability Detection (NUD)</a></li>
<li><a href="#icmpv6-neighbor-discovery-nd-options">5.5. ICMPv6 Neighbor Discovery (ND) Options</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
</div>
</div>
<div class="sect1">
<h2 id="encapsulation-in-ipv4-and-ipv6">1. Encapsulation in IPv4 and IPv6</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/icmpv4-icmpv6-encapsulated-in-ip-packet-format.png" alt="ICMP messages are encapsulated for transmission within IP datagrams" width="45%" height="45%">
</div>
<div class="title">Figure 1. Encapsulation of ICMP messages in IPv4 and IPv6. The ICMP header contains a checksum covering the ICMP data area. In ICMPv6, the checksum also covers the Source and Destination IPv6 Address, Length, and Next Header fields in the IPv6 header.</div>
</div>
<div class="ulist">
<ul>
<li>
<p>In IPv4, a <em>Protocol</em> field value of <em>1</em> indicates that the datagram caries ICMPv4.</p>
</li>
<li>
<p>In IPv6, the ICMPv6 message may begin after zero or more extension headers. The last extension header before the ICMPv6 header includes a <em>Next Header</em> field with value <em>58</em>.</p>
</li>
<li>
<p>ICMP messages may be fragmented like other IP datagrams, although this is not common.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/icmp-message-format.png" alt="ICMPv4 and ICMPv6 messages" width="45%" height="45%">
</div>
<div class="title">Figure 2. All ICMP messages begin with 8-bit Type and Code fields, followed by a 16-bit Checksum that covers the entire message. The type and code values are different for ICMPv4 and ICMPv6.</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="icmp-messages">2. ICMP Messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ICMP messages are grouped into two major categories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>those messages relating to problems with delivering IP datagrams (called <em>error messages</em>),</p>
</li>
<li>
<p>and those related to information gathering and configuration (called <em>query</em> or <em>informational messages</em>).</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="icmpv4-messages">2.1. ICMPv4 Messages</h3>
<div class="paragraph">
<p>For ICMPv4, the informational messages include</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Echo Request</em> and <em>Echo Reply</em> (types <em>8</em> and <em>0</em>, respectively),</p>
</li>
<li>
<p>and <em>Router Advertisement</em> and <em>Router Solicitation</em> (types <em>9</em> and <em>10</em>, respectively,</p>
<div class="paragraph">
<p>together called <em>Router Discovery</em>).</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The most common error message types are</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Destination Unreachable</em> (type <em>3</em>),</p>
</li>
<li>
<p><em>Redirect</em> (type <em>5</em>),</p>
</li>
<li>
<p><em>Time Exceeded</em> (type <em>11</em>),</p>
</li>
<li>
<p>and <em>Parameter Problem</em> (type <em>12</em>).</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. The standard ICMPv4 message types, as determined by the Type field*</caption>
<colgroup>
<col style="width: 7.6923%;">
<col style="width: 23.0769%;">
<col style="width: 7.6923%;">
<col style="width: 7.6923%;">
<col style="width: 53.8462%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Official Name</th>
<th class="tableblock halign-left valign-top">Reference</th>
<th class="tableblock halign-left valign-top">E/I</th>
<th class="tableblock halign-left valign-top">Use/Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 (*)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Echo Reply</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC0792]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Echo (ping) reply; returns data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 (*)(+)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination Unreachable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC0792]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unreachable host/protocol</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source Quench</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC0792]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates congestion (deprecated)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5 (*)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC0792]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates alternate router should be used</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8 (*)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Echo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC0792]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Echo (ping) request (data optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Router Advertisement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC1256]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates router addresses/preferences</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Router Solicitation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC1256]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requests Router Advertisement</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">11 (*)(+)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time Exceeded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC0792]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource exhausted (e.g., IPv4 TTL)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">12 (*)(+)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter Problem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC0792]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Malformed packet or header</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Types marked with asterisks (*) are the most common. Those marked with a plus (+) may contain [RFC4884] extension objects. In the fourth column, E is for error messages and I indicates query/informational messages.
</td>
</tr>
</table>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Common ICMPv4 message types that use code numbers in addition to 0. Although all of these message types are relatively common, only a few of the codes are commonly used.</caption>
<colgroup>
<col style="width: 5.5555%;">
<col style="width: 5.5555%;">
<col style="width: 38.8888%;">
<col style="width: 50.0002%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Code</th>
<th class="tableblock halign-left valign-top">Official Name</th>
<th class="tableblock halign-left valign-top">Use/Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Net Unreachable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No route (at all) to destination</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 (*)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Host Unreachable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Known but unreachable host</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Protocol Unreachable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unknown (transport) protocol</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 (*)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port Unreachable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unknown/unused (transport) port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 (*)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fragmentation Needed and Don’t
Fragment Was Set (PTB message)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Needed fragmentation prohibited by DF
bit; used by PMTUD [RFC1191]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source Route Failed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Intermediary hop not reachable</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination Network Unknown</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deprecated [RFC1812]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination Host Unknown</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination does not exist</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source Host Isolated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deprecated [RFC1812]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Communication with Destination
Network Administratively
Prohibited</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deprecated [RFC1812]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Communication with Destination
Host Administratively Prohibited</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deprecated [RFC1812]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination Network Unreachable
for Type of Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of service not available (net)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination Host Unreachable for
Type of Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of service not available (host)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Communication Administratively
Prohibited</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Communication prohibited by filtering
policy</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Host Precedence Violation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Precedence disallowed for src/dest/port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Precedence Cutoff in Effect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Below minimum ToS [RFC1812]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect Datagram for the Network
(or Subnet)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates alternate router</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5 (*)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect Datagram for the Host</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates alternate router (host)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect Datagram for the Type of
Service and Network</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates alternate router (ToS/net)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect Datagram for the Type of
Service and Host</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates alternate router (ToS/host)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Normal Router Advertisement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Router&#8217;s address and configuration
information</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Does Not Route Common Traffic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">With Mobile IP [RFC5944], router does not
route ordinary packets</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">11 (*)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time to Live Exceeded in Transit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hop limit/TTL exceeded</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fragment Reassembly Time
Exceeded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not all fragments of datagram arrived
before reassembly timer expired</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">12 (*)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pointer Indicates the Error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Byte offset (pointer) indicates first problem
field</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Missing a Required Option</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Deprecated/historic</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bad Length</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Packet had invalid Total Length field</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="icmpv6-messages">2.2. ICMPv6 Messages</h3>
<div class="paragraph">
<p>Note that ICMPv6 is responsible not only for error and informational messages but also for a great deal of <em>IPv6 router and host configuration</em>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. In ICMPv6, error messages have message types from 0 to 127. Informational messages have message types from 128 to 255. The plus (+) notation indicates that the message may contain an extension structure. Reserved, unassigned, experimental, and deprecated values are not shown.</caption>
<colgroup>
<col style="width: 6.25%;">
<col style="width: 43.75%;">
<col style="width: 6.25%;">
<col style="width: 43.75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Official Name</th>
<th class="tableblock halign-left valign-top">Reference</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 (+)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination Unreachable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4443]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unreachable host, port, protocol</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Packet Too Big (PTB)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4443]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fragmentation required</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 (+)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time Exceeded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4443]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hop limit exhausted or
reassembly timed out</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parameter Problem</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4443]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Malformed packet or header</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">100,101</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for private experimentation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4443]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for experiments</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">127</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for expansion of ICMPv6
error messages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4443]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hold for more error messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">128</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Echo Request</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4443]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ping request; may contain data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">129</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Echo Reply</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4443]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ping response; returns data</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">130</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast Listener Query</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2710]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Queries multicast subscribers
(v1)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">131</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast Listener Report</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2710]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast subscriber report (v1)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">132</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast Listener Done</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2710]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast unsubscribe
message (v1)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">133</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Router Solicitation (RS)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4861]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IPv6 RS with Mobile IPv6
options</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">134</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Router Advertisement (RA)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4861]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IPv6 RA with Mobile IPv6
options</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">135</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Neighbor Solicitation (NS)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4861]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IPv6 Neighbor Discovery
(Solicit)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">136</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Neighbor Advertisement (NA)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4861]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IPv6 Neighbor Discovery
(Advertisement)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">137</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirect Message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4861]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use alternative next-hop router</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">141</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inverse Neighbor Discovery
Solicitation Message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3122]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inverse Neighbor Discovery
request: requests IPv6 addresses
given link-layer address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">142</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inverse Neighbor Discovery
Advertisement Message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3122]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inverse Neighbor Discovery
response: reports IPv6 addresses
given link-layer address</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">143</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version 2 Multicast Listener Report</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3810]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast subscriber report (v2)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">144</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Home Agent Address Discovery
Request Message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC6275]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requests Mobile IPv6 HA
address; send by mobile node</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">145</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Home Agent Address Discovery Reply
Message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC6275]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains MIPv6 HA address;
sent by eligible HA on home
network</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">146</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mobile Prefix Solicitation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC6275]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Request home prefix while away</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">147</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mobile Prefix Advertisement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC6275]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides prefix from HA to
mobile</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">148</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certification Path Solicitation Message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3971]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Secure Neighbor Discovery
(SEND) request for a
certification path</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">149</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certification Path Advertisement
Message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3971]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SEND response to certification
path request</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">151</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast Router Advertisement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4286]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provides address of multicast
router</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">152</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast Router Solicitation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4286]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requests address of multicast
router</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">153</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast Router Termination</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4286]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Done using multicast router</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">154</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FMIPv6 Messages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC5568]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MIPv6 fast handover messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">200,201</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for private experimentation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4443]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for experiments</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">255</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reserved for expansion of ICMPv6
informational messages</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4443]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hold for more informational
messages</p></td>
</tr>
</tbody>
</table>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. ICMPv6 standard message types (i.e., Destination Unreachable, Time Exceeded, and Parameter Problem)  with codes in addition to 0 assigned</caption>
<colgroup>
<col style="width: 6.25%;">
<col style="width: 6.25%;">
<col style="width: 43.75%;">
<col style="width: 43.75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Code</th>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Use/Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No Route to Destination</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Route not present</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Administratively Prohibited</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Policy (e.g., firewall) prohibited</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Beyond Scope of Source Address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination scope exceeds source&#8217;s</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Address Unreachable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used if codes 0–2 are not appropriate</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port Unreachable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No transport entity listening on port</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source Address Failed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Policy Ingress/egress policy violation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reject Route to Destination</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specific reject route to destination</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hop Limit Exceeded in Transit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hop Limit field decremented to 0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reassembly Time Exceeded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unable to reassemble in limited time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Erroneous Header Field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Found General header processing error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unrecognized Next Header</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unknown Next Header field value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unrecognized IPv6 Option</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unknown Hop-by-Hop or Destination option</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="processing-of-icmp-messages">2.3. Processing of ICMP Messages</h3>
<div class="paragraph">
<p>In ICMP, the processing of incoming messages varies from system to system.</p>
</div>
<div class="paragraph">
<p>Generally speaking, the incoming informational requests are handled automatically by the operating system, and the error messages are delivered to user processes or to a transport protocol such as TCP [RFC5461]. The processes may choose to act on them or ignore them.</p>
</div>
<div class="paragraph">
<p>Exceptions to this general rule include the Redirect message and the Destination Unreachable—Fragmentation Required messages.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The former results in an automatic update to the host&#8217;s routing table,</p>
</li>
<li>
<p>whereas the latter is used in the path MTU discovery (PMTUD) mechanism, which is generally implemented by the transport-layer protocols such as TCP.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In ICMPv6 the handling of messages has been tightened somewhat. The following rules are applied when processing incoming ICMPv6 messages [RFC4443]:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Unknown ICMPv6 error messages must be passed to the upper-layer process that produced the datagram causing the error (if possible).</p>
</li>
<li>
<p>Unknown ICMPv6 informational messages are dropped.</p>
</li>
<li>
<p>ICMPv6 error messages include as much of the original (<em>offending</em>) IPv6 datagram that caused the error as will fit without making the error message datagram exceed the minimum IPv6 MTU (1280 bytes).</p>
</li>
<li>
<p>When processing ICMPv6 error messages, the upper-layer protocol type is extracted from the original or <em>offending</em> packet (contained in the body of the ICMPv6 error message) and used to select the appropriate upper-layer process.</p>
<div class="paragraph">
<p>If this is not possible, the error message is silently dropped after any IPv6-layer processing.</p>
</div>
</li>
<li>
<p>There are special rules for handling errors.</p>
</li>
<li>
<p>An IPv6 node must limit the rate of ICMPv6 error messages it sends.</p>
<div class="paragraph">
<p>There are a variety of ways of implementing the rate-limiting function, including the <em>token bucket</em> approach mentioned.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="icmp-error-messages">3. ICMP Error Messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In particular, an ICMP error message is not to be sent in response to any of the following messages: another ICMP error message, datagrams with bad headers (e.g., bad checksum), IP-layer broadcast/multicast datagrams, datagrams encapsulated in link-layer broadcast or multicast frames, datagrams with an invalid or network zero source address, or any fragment other than the first.</p>
</div>
<div class="paragraph">
<p>The reason for imposing these restrictions on the generation of ICMP errors is to limit the creation of so-called <em>broadcast storms</em>, a scenario in which the generation of a small number of messages creates an unwanted traffic cascade (e.g., by generating error responses in response to error responses, indefinitely).</p>
</div>
<div class="paragraph">
<p>An ICMPv4 error message is never generated in response to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An ICMPv4 error message. (An ICMPv4 error message may, however, be generated in response to an ICMPv4 query message.)</p>
</li>
<li>
<p>A datagram destined for an IPv4 broadcast address or an IPv4 multicast address (formerly known as a class D address).</p>
</li>
<li>
<p>A datagram sent as a link-layer broadcast.</p>
</li>
<li>
<p>A fragment other than the first.</p>
</li>
<li>
<p>A datagram whose source address does not define a single host.</p>
<div class="paragraph">
<p>This means that the source address cannot be a zero address, a loopback address, a broadcast address, or a multicast address.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>An ICMPv6 error message is never generated in response to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An ICMPv6 error message</p>
</li>
<li>
<p>An ICMPv6 Redirect message</p>
</li>
<li>
<p>A packet destined for an IPv6 multicast address, with two exceptions:</p>
<div class="ulist">
<ul>
<li>
<p>The Packet Too Big (PTB) message</p>
</li>
<li>
<p>The Parameter Problem message (code 2)</p>
</li>
</ul>
</div>
</li>
<li>
<p>A packet sent as a link-layer multicast (with the exceptions noted previously)</p>
</li>
<li>
<p>A packet sent as a link-layer broadcast (with the exceptions noted previously)</p>
</li>
<li>
<p>A packet whose source address does not uniquely identify a single node.</p>
<div class="paragraph">
<p>This means that the source address cannot be an unspecified address, an IPv6 multicast address, or any address known by the sender to be an anycast address.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>When an ICMP error message is sent, it contains</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a copy of the full IP header from the <em>offending</em> or <em>original</em> datagram (i.e., the IP header of the datagram that caused the error to be generated, including any IP options),</p>
</li>
<li>
<p>plus any other data from the original datagram&#8217;s IP payload area</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>such that the generated IP/ ICMP datagram&#8217;s size does not exceed a specific value.</p>
</div>
<div class="paragraph">
<p>For IPv4 this value is <em>576</em> bytes, and for IPv6 it is the IPv6 minimum MTU, which is at least <em>1280</em> bytes.</p>
</div>
<div class="paragraph">
<p>Including a portion of the payload from the original IP datagram lets the receiving ICMP module associate the message with</p>
</div>
<div class="ulist">
<ul>
<li>
<p>one particular <em>protocol</em> (e.g., TCP or UDP) from the <em>Protocol</em> or <em>Next Header</em> field in the IP header</p>
</li>
<li>
<p>and one particular <em>user process</em> (from the TCP or UDP port numbers that are in the TCP or UDP header contained in the first 8 bytes of the IP datagram payload area).</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="destination-unreachable-icmpv4-type-3-icmpv6-type-1-and-packet-too-big-icmpv6-type-2">3.1. Destination Unreachable (ICMPv4 Type 3, ICMPv6 Type 1) and Packet Too Big (ICMPv6 Type 2)</h3>
<div class="paragraph">
<p>In ICMPv6, as compared with IPv4, the Fragmentation Required message has been replaced by an entirely different type (type 2), but the usage is very similar to the corresponding ICMP Destination Unreachable message.</p>
</div>
<div class="sect3">
<h4 id="icmpv4-host-unreachable-code-1-and-icmpv6-address-unreachable-code-3">3.1.1. ICMPv4 Host Unreachable (Code 1) and ICMPv6 Address Unreachable (Code 3)</h4>
<div class="paragraph">
<p>This form of the Destination Unreachable message is generated by a router or host when it is required to send an IP datagram to a host using direct delivery but for some reason cannot reach the destination.</p>
</div>
<div class="paragraph">
<p>This situation may arise, for example, because the last-hop router is attempting to</p>
</div>
<div class="ulist">
<ul>
<li>
<p>send an <em>ARP</em> request to a host that is either missing or down.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">root@node-0:~#</span><span class="w"> </span>tcpdump <span class="nt">-tenv</span> not tcp <span class="nt">-i</span> any
<span class="go">ens34 B   ifindex 3 00:0c:29:8c:df:3f ethertype ARP (0x0806), length 66: Ethernet (len 6), IPv4 (len 4), Request who-has 192.168.91.120 tell 192.168.91.128, length 46
lo    In  ifindex 1 00:00:00:00:00:00 ethertype IPv4 (0x0800), length 132: (tos 0xc0, ttl 64, id 18662, offset 0, flags [none], proto ICMP (1), length 112)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>192.168.91.128: ICMP host 192.168.91.120 unreachable, length 92
<span class="go">	(tos 0x0, ttl 64, id 33177, offset 0, flags [DF], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>192.168.91.120: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>60872, <span class="nb">seq </span>1, length 64</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-0:~$</span><span class="w"> </span>ping <span class="nt">-c</span> 1 192.168.91.120
<span class="go">PING 192.168.91.120 (192.168.91.120) 56(84) bytes of data.
From 192.168.91.128 icmp_seq=1 Destination Host Unreachable

--- 192.168.91.120 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms</span></code></pre>
</div>
</div>
</li>
<li>
<p>For ICMPv6, this message can be the result of a failure in the <em>ND</em> process.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">root@node-0:~#</span><span class="w"> </span>tcpdump <span class="nt">-tenv</span> ip6 <span class="nt">-i</span> any
<span class="gp">ens32 Out ifindex 2 00:0c:29:8c:df:3f ethertype IPv6 (0x86dd), length 92: (hlim 255, next-header ICMPv6 (58) payload length: 32) fe80::20c:29ff:fe8c:df3f &gt;</span><span class="w"> </span>ff02::1:ff8c:df50: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, neighbor solicitation, length 32, <span class="nb">who </span>has fe80::20c:29ff:fe8c:df50
<span class="go">	  source link-address option (1), length 8 (1): 00:0c:29:8c:df:3f
</span><span class="gp">lo    In  ifindex 1 00:00:00:00:00:00 ethertype IPv6 (0x86dd), length 172: (flowlabel 0xa61cc, hlim 64, next-header ICMPv6 (58) payload length: 112) fe80::20c:29ff:fe8c:df3f &gt;</span><span class="w"> </span>fe80::20c:29ff:fe8c:df3f: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, destination unreachable, unreachable address fe80::20c:29ff:fe8c:df50</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-0:~$</span><span class="w"> </span>ping <span class="nt">-c</span> 1 <span class="nt">-6</span> fe80::20c:29ff:fe8c:df50
<span class="go">PING fe80::20c:29ff:fe8c:df50(fe80::20c:29ff:fe8c:df50) 56 data bytes
From fe80::20c:29ff:fe8c:df3f%ens32 icmp_seq=1 Destination unreachable: Address unreachable

--- fe80::20c:29ff:fe8c:df50 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="icmpv6-no-route-to-destination-code-0">3.1.2. ICMPv6 No Route to Destination (Code 0)</h4>
<div class="paragraph">
<p>This message refines the Host Unreachable message from ICMPv4 to differentiate those hosts not reachable because of failure of direct delivery and those that cannot be reached because no route is present.</p>
</div>
<div class="paragraph">
<p>This message is generated only in cases where an arriving datagram must be forwarded without using direct delivery, but where no route entry exists to indicate what router to use as a next hop.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">root@node-1:~#</span><span class="w"> </span>sysctl net.ipv4.ip_forward
<span class="go">net.ipv4.ip_forward = 1
</span><span class="gp">root@node-1:~#</span><span class="w"> </span>ip r
<span class="go">192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.130
</span><span class="gp">root@node-1:~#</span><span class="w"> </span>tcpdump <span class="nt">-env</span> <span class="nt">-t</span> ip and not tcp <span class="nt">-i</span> ens32
<span class="go">tcpdump: listening on ens32, link-type EN10MB (Ethernet), capture size 262144 bytes
</span><span class="gp">00:0c:29:8c:df:3f &gt;</span><span class="w"> </span>00:0c:29:85:26:07, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 98: <span class="o">(</span>tos 0x0, ttl 64, <span class="nb">id </span>7149, offset 0, flags <span class="o">[</span>DF], proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 84<span class="o">)</span>
<span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>192.168.92.10: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>41837, <span class="nb">seq </span>1, length 64
<span class="gp">00:0c:29:85:26:07 &gt;</span><span class="w"> </span>00:0c:29:8c:df:3f, ethertype IPv4 <span class="o">(</span>0x0800<span class="o">)</span>, length 126: <span class="o">(</span>tos 0xc0, ttl 64, <span class="nb">id </span>37553, offset 0, flags <span class="o">[</span>none], proto ICMP <span class="o">(</span>1<span class="o">)</span>, length 112<span class="o">)</span>
<span class="gp">    192.168.91.130 &gt;</span><span class="w"> </span>192.168.91.128: ICMP net 192.168.92.10 unreachable, length 92
<span class="go">	(tos 0x0, ttl 64, id 7149, offset 0, flags [DF], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>192.168.92.10: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>41837, <span class="nb">seq </span>1, length 64</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="icmpv4-port-unreachable-code-3-and-icmpv6-port-unreachable-code-4">3.1.3. ICMPv4 Port Unreachable (Code 3) and ICMPv6 Port Unreachable (Code 4)</h4>
<div class="paragraph">
<p>The Port Unreachable message is generated when an incoming datagram is destined for an application that is not ready to receive it.</p>
</div>
<div class="paragraph">
<p>This occurs most commonly in conjunction with UDP, when a message is sent to a port number that is not in use by any server process. If UDP receives a datagram and the destination port does not correspond to a port that some process has in use, UDP responds with an ICMP Port Unreachable message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-0:~$</span><span class="w"> </span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"hello"</span> | nc <span class="nt">-4u</span> <span class="nt">-w0</span> 10.170.109.10 tftp</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">root@node-0:~#</span><span class="w"> </span>tcpdump <span class="nt">-nvv</span> icmp or port tftp
<span class="go">tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 262144 bytes
09:55:42.158497 IP (tos 0x0, ttl 64, id 9924, offset 0, flags [DF], proto UDP (17), length 33)
</span><span class="gp">    192.168.91.128.37775 &gt;</span><span class="w"> </span>192.168.91.130.69: <span class="o">[</span>udp <span class="nb">sum </span>ok] TFTP, length 5, tftp-#26725
<span class="go">09:55:42.158719 IP (tos 0xc0, ttl 64, id 6641, offset 0, flags [none], proto ICMP (1), length 61)
</span><span class="gp">    192.168.91.130 &gt;</span><span class="w"> </span>192.168.91.128: ICMP 192.168.91.130 udp port 69 unreachable, length 41
<span class="go">	IP (tos 0x0, ttl 64, id 9924, offset 0, flags [DF], proto UDP (17), length 33)
</span><span class="gp">    192.168.91.128.37775 &gt;</span><span class="w"> </span>192.168.91.130.69: <span class="o">[</span>udp <span class="nb">sum </span>ok] TFTP, length 5, tftp-#26725</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-0:~$</span><span class="w"> </span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"hello"</span> | nc <span class="nt">-6u</span> <span class="nt">-w0</span> fe80::20c:29ff:fe85:2607%ens32 tftp</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">root@node-0:~#</span><span class="w"> </span>tcpdump <span class="nt">-nvvv</span> <span class="nt">-s</span> 1500 icmp6 or port tftp
<span class="go">tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 1500 bytes
</span><span class="gp">10:12:51.993200 IP6 (flowlabel 0x9515e, hlim 64, next-header UDP (17) payload length: 13) fe80::20c:29ff:fe8c:df3f.42714 &gt;</span><span class="w"> </span>fe80::20c:29ff:fe85:2607.69: <span class="o">[</span>udp <span class="nb">sum </span>ok] TFTP, length 5, tftp-#26725
<span class="gp">10:12:51.993612 IP6 (flowlabel 0x7b8d5, hlim 64, next-header ICMPv6 (58) payload length: 61) fe80::20c:29ff:fe85:2607 &gt;</span><span class="w"> </span>fe80::20c:29ff:fe8c:df3f: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, destination unreachable, unreachable port, fe80::20c:29ff:fe85:2607 udp port 69</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="icmpv4-ptb-code-4">3.1.4. ICMPv4 PTB (Code 4)</h4>
<div class="paragraph">
<p>If an IPv4 router receives a datagram that it intends to forward, and if the datagram does not fit into the MTU in use on the selected outgoing network interface, the datagram must be fragmented.</p>
</div>
<div class="paragraph">
<p>If the arriving datagram has the <em>Don&#8217;t Fragment</em> bit field set in its IP header, however, it is not forwarded but instead is dropped, and this ICMPv4 Destination Unreachable (PTB) message is generated.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Because the router sending this message knows the MTU of the next hop, it is able to include the MTU value in the error message it generates.</p>
</li>
<li>
<p>This message was originally intended to be used for network diagnostics but has since been used for path MTU discovery.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>PMTUD is used to determine an appropriate packet size to use when communicating with a particular host, on the assumption that avoiding packet fragmentation is desirable. It is used most commonly with TCP.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-1:~$</span><span class="w"> </span><span class="nb">sudo </span>sysctl net.ipv4.ip_forward<span class="o">=</span>1
<span class="go">net.ipv4.ip_forward = 1

</span><span class="gp">x@node-1:~$</span><span class="w"> </span>ip <span class="nb">link </span>show ens32
<span class="gp">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span><span class="w"> </span>mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
<span class="go">    link/ether 00:0c:29:85:26:07 brd ff:ff:ff:ff:ff:ff

</span><span class="gp">x@node-1:~$</span><span class="w"> </span><span class="nb">sudo </span>ip <span class="nb">link set </span>ens32 mtu 900
<span class="go">
</span><span class="gp">x@node-1:~$</span><span class="w"> </span>ip a show ens32
<span class="gp">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span><span class="w"> </span>mtu 900 qdisc pfifo_fast state UP group default qlen 1000
<span class="go">    link/ether 00:0c:29:85:26:07 brd ff:ff:ff:ff:ff:ff
    inet 192.168.91.130/24 brd 192.168.91.255 scope global dynamic ens32
       valid_lft 1511sec preferred_lft 1511sec</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-0:~$</span><span class="w"> </span>ip r
<span class="go">default via 192.168.91.130 dev ens32
192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128
</span><span class="gp">x@node-0:~$</span><span class="w"> </span>ping <span class="nt">-c</span> 1 <span class="nt">-s</span> 1000 <span class="nt">-M</span> <span class="k">do </span>10.170.109.10
<span class="go">PING 10.170.109.10 (10.170.109.10) 1000(1028) bytes of data.
From 192.168.91.130 icmp_seq=1 Frag needed and DF set (mtu = 900)

--- 10.170.109.10 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">root@node-0:~#</span><span class="w"> </span>tcpdump <span class="nt">-nvv</span> <span class="nt">-t</span> icmp
<span class="go">tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 262144 bytes
IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto ICMP (1), length 1028)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>10.170.109.10: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>52044, <span class="nb">seq </span>1, length 1008
<span class="go">IP (tos 0xc0, ttl 64, id 58248, offset 0, flags [none], proto ICMP (1), length 576)
</span><span class="gp">    192.168.91.130 &gt;</span><span class="w"> </span>192.168.91.128: ICMP 10.170.109.10 unreachable - need to frag <span class="o">(</span>mtu 900<span class="o">)</span>, length 556
<span class="go">	IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto ICMP (1), length 1028)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>10.170.109.10: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>52044, <span class="nb">seq </span>1, length 1008</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-0:~$</span><span class="w"> </span>ping <span class="nt">-c</span> 1 <span class="nt">-s</span> 1000 <span class="nt">-M</span> <span class="k">do </span>10.170.109.10
<span class="go">PING 10.170.109.10 (10.170.109.10) 1000(1028) bytes of data.
ping: local error: message too long, mtu=900

--- 10.170.109.10 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms

</span><span class="gp">x@node-0:~$</span><span class="w"> </span>ip r show cache
<span class="go">10.170.109.10 via 192.168.91.130 dev ens32
    cache expires 559sec mtu 900

</span><span class="gp">x@node-0:~$</span><span class="w"> </span><span class="nb">sudo </span>ip r flush cache
<span class="go">
</span><span class="gp">x@node-0:~$</span><span class="w"> </span>ping <span class="nt">-c</span> 1 <span class="nt">-s</span> 1000 <span class="nt">-M</span> <span class="k">do </span>10.170.109.10
<span class="go">PING 10.170.109.10 (10.170.109.10) 1000(1028) bytes of data.
From 192.168.91.130 icmp_seq=1 Frag needed and DF set (mtu = 900)

--- 10.170.109.10 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="icmpv6-ptb-type-2-code-0">3.1.5. ICMPv6 PTB (Type 2, Code 0)</h4>
<div class="paragraph">
<p>In ICMPv6, a special message and type code combination is used to indicate that a packet is too large for the MTU of the next hop.</p>
</div>
<div class="paragraph">
<p>This message is not a Destination Unreachable message. Recall that in IPv6, packet fragmentation is performed only by the sender of a datagram and that MTU discovery is always supposed to be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="icmpv6-beyond-scope-of-source-address-code-2">3.1.6. ICMPv6 Beyond Scope of Source Address (Code 2)</h4>
<div class="paragraph">
<p>IPv6 uses addresses of different scopes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Thus, it is possible to construct a packet with source and destination addresses of different scopes.</p>
</li>
<li>
<p>Furthermore, it is possible that the destination address may not be reachable within the same scope.</p>
<div class="paragraph">
<p>For example, a packet with a source address using link-local scope may be destined for a globally scoped destination that requires traversal of more than one router.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Because the source address is of insufficient scope, the packet is dropped by a router, and this form of ICMPv6 error is produced to indicate the problem.</p>
</div>
</div>
<div class="sect3">
<h4 id="icmpv6-source-address-failed-ingressegress-policy-code-5">3.1.7. ICMPv6 Source Address Failed Ingress/Egress Policy (Code 5)</h4>
<div class="paragraph">
<p>Code 5 is a more refined version of code 1, to be used when a particular ingress or egress filtering policy is the reason for prohibiting the successful delivery of a datagram.</p>
</div>
<div class="paragraph">
<p>This might be used, for example, when a host attempts to send traffic using a source IPv6 address from an unexpected network prefix [RFC3704].</p>
</div>
</div>
<div class="sect3">
<h4 id="icmpv6-reject-route-to-destination-code-6">3.1.8. ICMPv6 Reject Route to Destination (Code 6)</h4>
<div class="paragraph">
<p>A <em>reject</em> or <em>blocking route</em> is a special routing or forwarding table entry, which indicates that matching packets should be dropped and an ICMPv6 Destination Unreachable Reject Route message should be generated.</p>
</div>
<div class="paragraph">
<p>A similar type of entry called a <em>blackhole route</em> also causes matching packets to be dropped, but usually without generating the Destination Unreachable message.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="redirect-icmpv4-type-5-icmpv6-type-137">3.2. Redirect (ICMPv4 Type 5, ICMPv6 Type 137)</h3>
<div class="paragraph">
<p>If a router receives a datagram from a host and can determine that it is not the correct next hop for the host to have used to deliver the datagram to its destination,</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the router sends a Redirect message to the host</p>
</li>
<li>
<p>and sends the datagram on to the correct router (or host).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>That is, if it can determine that</p>
</div>
<div class="ulist">
<ul>
<li>
<p>there is a better next hop than itself for the given datagram,</p>
</li>
<li>
<p>it redirects the host to update its forwarding table so that future traffic for the same destination will be directed toward the new node.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This facility provides a crude form of routing protocol by indicating to the IP forwarding function where to send its packets.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/icmp-redirect-message.png" alt="ICMP Redirect message" width="45%" height="45%">
</div>
<div class="title">Figure 3. The host incorrectly sends a datagram via R2 toward its destination. R2 realizes the host’s mistake and sends the datagram to the proper router, R1. It also informs the host of the error by sending an ICMP Redirect message. The host is expected to adjust its forwarding tables so that future datagrams to the same destination go through R1 without bothering R2.</div>
</div>
<div class="paragraph">
<p>The ICMP Redirect message includes the IP address of the router (or destination host, if it is reachable using direct delivery), a host should use as a next hop for
the destination specified in the ICMP error message.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/icmpv4-redirect-message-format.png" alt="ICMPv4 Redirect Message Format" width="45%" height="45%">
</div>
<div class="title">Figure 4. The ICMPv4 Redirect message includes the IPv4 address of the correct router to use as a next hop for the datagram included in the payload portion of the message. A host typically checks the IPv4 source address of the incoming Redirect message to verify that it is coming from the default router it is currently using.</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-0:~$</span><span class="w"> </span>ip r
<span class="go">default via 192.168.91.137 dev ens32
192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128

</span><span class="gp">x@node-0:~$</span><span class="w"> </span><span class="nb">sudo </span>sysctl net.ipv4.conf.all.accept_redirects<span class="o">=</span>1
<span class="go">net.ipv4.conf.all.accept_redirects = 1

</span><span class="gp">x@node-0:~$</span><span class="w"> </span>ping <span class="nt">-c</span> 2 10.170.109.10
<span class="go">PING 10.170.109.10 (10.170.109.10) 56(84) bytes of data.
From 192.168.91.137: icmp_seq=1 Redirect Host(New nexthop: 192.168.91.2)
64 bytes from 10.170.109.10: icmp_seq=1 ttl=128 time=1.02 ms
64 bytes from 10.170.109.10: icmp_seq=2 ttl=128 time=1.14 ms

--- 10.170.109.10 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 1.019/1.080/1.142/0.061 ms

</span><span class="gp">x@node-0:~$</span><span class="w"> </span>ip r show cache
<span class="go">10.170.109.10 via 192.168.91.2 dev ens32
</span><span class="gp">    cache &lt;redirected&gt;</span><span class="w"> </span>expires 264sec</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-1:~$</span><span class="w"> </span><span class="nb">sudo </span>sysctl net.ipv4.ip_forward
<span class="go">net.ipv4.ip_forward = 1

</span><span class="gp">x@node-1:~$</span><span class="w"> </span><span class="nb">sudo </span>sysctl net.ipv4.conf.all.send_redirects
<span class="go">net.ipv4.conf.all.send_redirects = 1

</span><span class="gp">x@node-1:~$</span><span class="w"> </span><span class="nb">sudo </span>sysctl net.ipv4.conf.ens32.send_redirects
<span class="go">net.ipv4.conf.ens32.send_redirects = 1

</span><span class="gp">x@node-1:~$</span><span class="w"> </span>ip r
<span class="go">default via 192.168.91.2 dev ens32
192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.137</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">root@node-0:~#</span><span class="w"> </span>tcpdump <span class="nt">-ntv</span> host 192.168.91.128 and icmp
<span class="go">IP (tos 0x0, ttl 64, id 4851, offset 0, flags [DF], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>10.170.109.10: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>35246, <span class="nb">seq </span>1, length 64
<span class="go">IP (tos 0xc0, ttl 64, id 43486, offset 0, flags [none], proto ICMP (1), length 112)
</span><span class="gp">    192.168.91.137 &gt;</span><span class="w"> </span>192.168.91.128: ICMP redirect 10.170.109.10 to host 192.168.91.2, length 92
<span class="go">	IP (tos 0x0, ttl 63, id 4851, offset 0, flags [DF], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>10.170.109.10: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>35246, <span class="nb">seq </span>1, length 64
<span class="go">
IP (tos 0x0, ttl 63, id 4851, offset 0, flags [DF], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>10.170.109.10: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>35246, <span class="nb">seq </span>1, length 64
<span class="go">IP (tos 0x0, ttl 128, id 23335, offset 0, flags [none], proto ICMP (1), length 84)
</span><span class="gp">    10.170.109.10 &gt;</span><span class="w"> </span>192.168.91.128: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>35246, <span class="nb">seq </span>1, length 64
<span class="go">
IP (tos 0x0, ttl 64, id 4897, offset 0, flags [DF], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>10.170.109.10: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>35246, <span class="nb">seq </span>2, length 64
<span class="go">IP (tos 0x0, ttl 128, id 23336, offset 0, flags [none], proto ICMP (1), length 84)
</span><span class="gp">    10.170.109.10 &gt;</span><span class="w"> </span>192.168.91.128: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>35246, <span class="nb">seq </span>2, length 64</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/icmpv6-redirect-message-format.png" alt="ICMPv6 Redirect Message" width="45%" height="45%">
</div>
<div class="title">Figure 5. The ICMPv6 Redirect message. The target address indicates the IPv6 address of a better next-hop router for the node identified by the destination address. This message can also be used to indicate that the destination address is an on-link neighbor to the node sending the message that induced the error message. In this case, the destination and target addresses are the same.</div>
</div>
<div class="paragraph">
<p>In ICMPv6, the Redirect message (type 137) contains the target address and the destination address, and it is defined in conjunction with the ND process.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <em>Target Address</em> field contains the correct node&#8217;s link-local IPv6 address that should be used for the next hop.</p>
</li>
<li>
<p>The <em>Destination Address</em> is the destination IPv6 address in the datagram that evoked the redirect.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="icmp-time-exceeded-icmpv4-type-11-icmpv6-type-3">3.3. ICMP Time Exceeded (ICMPv4 Type 11, ICMPv6 Type 3)</h3>
<div class="paragraph">
<p>Every IPv4 datagram has a <em>Time-to-Live (TTL)</em> field in its IPv4 header, and every IPv6 datagram has a <em>Hop Limit</em> field in its header. Any router must decrement the <em>TTL</em> field by at least 1.</p>
</div>
<div class="paragraph">
<p>ICMP Time Exceeded (<em>code 0</em>) messages are generated when a router discards a datagram because the <em>TTL</em> or <em>Hop Limit</em> field is too low (i.e., arrives with value 0 or 1 and must be forwarded).</p>
</div>
<div class="paragraph">
<p>This message is important for the proper operation of the <em>traceroute</em> tool (called <em>tracert</em> on Windows).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/icmp-time-exceeded-message-format.png" alt="ICMP Time Exceeded Message Format" width="45%" height="45%">
</div>
<div class="title">Figure 6. The ICMP Time Exceeded message format for ICMPv4 and ICMPv6. The message is standardized for both the TTL or hop count being exceeded (code 0) or the time for reassembling fragments exceeding some preconfigured threshold (code 1).</div>
</div>
<div class="paragraph">
<p>Another less common variant of this message is when a fragmented IP datagram only partially arrives at its destination (i.e., all its fragments do not arrive after a period of time).</p>
</div>
<div class="paragraph">
<p>In such cases, a variant of the ICMP Time Exceeded message (<em>code 1</em>) is used to inform the sender that its overall datagram has been discarded.</p>
</div>
<div class="paragraph">
<p>Recall that if any fragment of a datagram is dropped, the entire datagram is lost.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-0:~$</span><span class="w"> </span><span class="nb">sudo </span>traceroute <span class="nt">-I</span> <span class="nt">-m</span> 2 10.170.109.10
<span class="go">traceroute to 10.170.109.10 (10.170.109.10), 2 hops max, 60 byte packets
 1  192.168.91.130 (192.168.91.130)  0.315 ms  0.189 ms  0.160 ms
 2  192.168.91.2 (192.168.91.2)  0.190 ms  0.173 ms  0.164 ms</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">root@node-0:~#</span><span class="w"> </span>tcpdump <span class="nt">-nvv</span> <span class="nt">-t</span> icmp
<span class="go">tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 262144 bytes
IP (tos 0x0, ttl 1, id 37515, offset 0, flags [none], proto ICMP (1), length 60)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>10.170.109.10: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>6913, <span class="nb">seq </span>1, length 40
<span class="c">...
</span><span class="go">IP (tos 0x0, ttl 2, id 37518, offset 0, flags [none], proto ICMP (1), length 60)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>10.170.109.10: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>6913, <span class="nb">seq </span>4, length 40
<span class="c">...
</span><span class="go">IP (tos 0xc0, ttl 64, id 28770, offset 0, flags [none], proto ICMP (1), length 88)
</span><span class="gp">    192.168.91.130 &gt;</span><span class="w"> </span>192.168.91.128: ICMP <span class="nb">time </span>exceeded <span class="k">in</span><span class="nt">-transit</span>, length 68
<span class="go">	IP (tos 0x0, ttl 1, id 37515, offset 0, flags [none], proto ICMP (1), length 60)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>10.170.109.10: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>6913, <span class="nb">seq </span>1, length 40
<span class="c">...
</span><span class="go">IP (tos 0x0, ttl 128, id 16816, offset 0, flags [none], proto ICMP (1), length 88)
</span><span class="gp">    192.168.91.2 &gt;</span><span class="w"> </span>192.168.91.128: ICMP <span class="nb">time </span>exceeded <span class="k">in</span><span class="nt">-transit</span>, length 68
<span class="go">	IP (tos 0x0, ttl 1, id 37518, offset 0, flags [none], proto ICMP (1), length 60)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>10.170.109.10: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>6913, <span class="nb">seq </span>4, length 40
<span class="c">...</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="parameter-problem-icmpv4-type-12-icmpv6-type-4">3.4. Parameter Problem (ICMPv4 Type 12, ICMPv6 Type 4)</h3>
<div class="paragraph">
<p>ICMP Parameter Problem messages are generated by a host or router receiving an IP datagram containing some problem in its IP header that cannot be repaired.</p>
</div>
<div class="paragraph">
<p>When a datagram cannot be handled and no other ICMP message adequately describes the problem, this message acts as a sort of <em>catchall</em> error condition indicator.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="icmp-queryinformational-messages">4. ICMP Query/Informational Messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The only remaining popular ICMP query/informational messages are the Echo Request/Response messages, more commonly called <em>ping</em>, and the Router Discovery messages.</p>
</div>
<div class="paragraph">
<p>Even the Router Discovery mechanism is not in wide use with IPv4, but its analog (part of Neighbor Discovery) in IPv6 is fundamental.</p>
</div>
<div class="paragraph">
<p>In addition, ICMPv6 has been extended to support Mobile IPv6 and the discovery of multicast-capable routers.</p>
</div>
<div class="sect2">
<h3 id="echo-requestreply-ping-icmpv4-types-08-icmpv6-types-129128">4.1. Echo Request/Reply (ping) (ICMPv4 Types 0/8, ICMPv6 Types 129/128)</h3>
<div class="paragraph">
<p>One of the most commonly used ICMP message pairs is Echo Request and Echo Response (or Reply).</p>
</div>
<div class="paragraph">
<p>In ICMPv4 these are types 8 and 0, respectively, and in ICMPv6 they are types 128 and 129, respectively.</p>
</div>
<div class="paragraph">
<p>ICMP Echo Request messages may be of nearly arbitrary size (limited by the ultimate size of the encapsulating IP datagram).</p>
</div>
<div class="paragraph">
<p>With ICMP Echo Reply messages, the ICMP implementation is required to return any data received back to the sender, even if multiple IP fragments are involved.</p>
</div>
<div class="paragraph">
<p>As with other ICMP query/informational messages, the server must echo the <em>Identifier</em> and <em>Sequence Number</em> fields back in the reply.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/icmp-echo-request-reply-message-format.png" alt="Format of the ICMPv4 and ICMPv6 Echo Request and Echo Reply messages" width="45%" height="45%">
</div>
<div class="title">Figure 7. Format of the ICMPv4 and ICMPv6 Echo Request and Echo Reply messages. Any optional data included in a request must be returned in a reply. NATs use the <em>Identifier</em> field to match requests with replies.</div>
</div>
<div class="paragraph">
<p>Implementations of ping set the <em>Identifier</em> field in the ICMP message to some number that the sending host can use to demultiplex returned responses.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In UNIX-based systems, for example, the process ID of the sending process is typically placed in the <em>Identifier</em> field.</p>
<div class="paragraph">
<p>This allows the ping application to identify the returned responses if there are multiple instances of ping running at the same time on the same host, because the ICMP protocol does not have the benefit of transport-layer port numbers.</p>
</div>
</li>
<li>
<p>This field is often known as the <em>Query Identifier</em> field when referring to firewall behavior.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a new instance of the ping program is run, the <em>Sequence Number</em> field starts with the value 0 and is increased by 1 every time a new Echo Request message is sent.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>ping</em> prints the sequence number of each returned packet, allowing the user to see if packets are missing, reordered, or duplicated.</p>
<div class="paragraph">
<p>Recall that IP (and consequently ICMP) is a <em>best-effort</em> datagram delivery service, so any of these three conditions can occur.</p>
</div>
<div class="paragraph">
<p>ICMP does, however, include a data checksum not provided by IP.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <em>ping</em> program also typically includes a copy of the local time in the optional data area of outgoing echo requests.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This time, along with the rest of the contents of the data area, is returned in an Echo Response message.</p>
</li>
<li>
<p>The <em>ping</em> program notes the current time when a response is received and subtracts the time in the reply from the current time, giving an estimate of the <em>RTT</em> to reach the host that was <em>pinged</em>.</p>
</li>
<li>
<p>Because only the original sender&#8217;s notion of the current time is used, this feature does not require any synchronization between the clocks at the sender and receiver.</p>
</li>
<li>
<p>A similar approach is used by the <em>traceroute</em> tool for its <em>RTT</em> measurements.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-1:~$</span><span class="w"> </span>sysctl net.ipv4.icmp_echo_ignore_broadcasts
<span class="go">net.ipv4.icmp_echo_ignore_broadcasts = 0
</span><span class="gp">x@node-1:~$</span><span class="w"> </span>ip a s ens32
<span class="gp">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span><span class="w"> </span>mtu 900 qdisc pfifo_fast state UP group default qlen 1000
<span class="go">    link/ether 00:0c:29:85:26:07 brd ff:ff:ff:ff:ff:ff
    inet 192.168.91.130/24 brd 192.168.91.255 scope global dynamic ens32
       valid_lft 1780sec preferred_lft 1780sec</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-0:~$</span><span class="w"> </span><span class="nb">sudo </span>ip neigh flush all
<span class="go">
</span><span class="gp">x@node-0:~$</span><span class="w"> </span>ping <span class="nt">-c</span> 2 <span class="nt">-b</span> 192.168.91.255 <span class="c"># ICMPv4 Echo Request to the subnet broadcast address.</span>
<span class="go">WARNING: pinging broadcast address
PING 192.168.91.255 (192.168.91.255) 56(84) bytes of data.
64 bytes from 192.168.91.2: icmp_seq=1 ttl=128 time=0.449 ms
64 bytes from 192.168.91.130: icmp_seq=1 ttl=64 time=0.480 ms
64 bytes from 192.168.91.2: icmp_seq=2 ttl=128 time=0.436 ms

--- 192.168.91.255 ping statistics ---
2 packets transmitted, 2 received, +1 duplicates, 0% packet loss, time 1008ms
rtt min/avg/max/mdev = 0.436/0.455/0.480/0.018 ms</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">root@node-0:~#</span><span class="w"> </span>tcpdump <span class="nt">-tnv</span> icmp
<span class="go">IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>192.168.91.255: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>17779, <span class="nb">seq </span>1, length 64
<span class="go">IP (tos 0x0, ttl 128, id 17587, offset 0, flags [none], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.2 &gt;</span><span class="w"> </span>192.168.91.128: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>17779, <span class="nb">seq </span>1, length 64
<span class="go">IP (tos 0x0, ttl 64, id 55593, offset 0, flags [none], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.130 &gt;</span><span class="w"> </span>192.168.91.128: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>17779, <span class="nb">seq </span>1, length 64
<span class="go">IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.128 &gt;</span><span class="w"> </span>192.168.91.255: ICMP <span class="nb">echo </span>request, <span class="nb">id </span>17779, <span class="nb">seq </span>2, length 64
<span class="go">IP (tos 0x0, ttl 128, id 17588, offset 0, flags [none], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.2 &gt;</span><span class="w"> </span>192.168.91.128: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>17779, <span class="nb">seq </span>2, length 64
<span class="go">IP (tos 0x0, ttl 64, id 55720, offset 0, flags [none], proto ICMP (1), length 84)
</span><span class="gp">    192.168.91.130 &gt;</span><span class="w"> </span>192.168.91.128: ICMP <span class="nb">echo </span>reply, <span class="nb">id </span>17779, <span class="nb">seq </span>2, length 64</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="router-discovery-router-solicitation-and-advertisement-icmpv4-types-9-10">4.2. Router Discovery: Router Solicitation and Advertisement (ICMPv4 Types 9, 10)</h3>
<div class="paragraph">
<p><em>DHCP</em> can be used for a host to acquire an IP address and learn about the existence of nearby routers.</p>
</div>
<div class="paragraph">
<p>An alternative option for learning about routers is called <em>Router Discovery (RD)</em>.</p>
</div>
<div class="paragraph">
<p>Although specified for configuring both IPv4 and IPv6 hosts, it is not widely used with IPv4 because of widespread preference for DHCP.</p>
</div>
<div class="paragraph">
<p>Router Discovery for IPv4 is accomplished using a pair of ICMPv4 informational messages [RFC1256]: <em>Router Solicitation</em> (RS, type 10) and <em>Router Advertisement</em> (RA, type 9).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, they are periodically multicast on the local network (using TTL = 1) to the <em>All Hosts multicast address</em> (<em>224.0.0.1</em>),</p>
</li>
<li>
<p>and they are also provided to hosts on demand that ask for them using RS messages. RS messages are sent using multicast to the <em>All Routers multicast address</em> (<em>224.0.0.2</em>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The primary purpose of Router Discovery is for a host to learn about all the routers on its local subnetwork, so that it can choose a default route among them.</p>
</div>
<div class="paragraph">
<p>It is also used to discover the presence of routers that are willing to act as <em>Mobile IP home agents</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="multicast-listener-queryreportdone-icmpv6-types-130131132">4.3. Multicast Listener Query/Report/Done (ICMPv6 Types 130/131/132)</h3>
<div class="paragraph">
<p><em>Multicast Listener Discovery</em> (MLD) [RFC2710][RFC3590] provides management of multicast addresses on links using IPv6. It is similar to the <em>IGMP</em> protocol used by IPv4.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/icmpv6-mld-message-v1.png" alt="ICMPv6 MLD Message V1" width="55%" height="55%">
</div>
<div class="title">Figure 8. ICMPv6 MLD version 1 messages are all of this form.Queries (type 130) are either general or multicast-address-specific. General queries ask hosts to report which multicast addresses they have in use, and address-specific queries are used to determine if a specific address is (still) in use. The maximum response time gives the maximum number of milliseconds a host may delay sending a report in response to a query. The destination multicast address is 0 for general queries and the multicast address in question for specific reports. For Report (type 131) and Done messages (type 132), it includes the address related to the report or what address is no longer of interest, respectively.</div>
</div>
<div class="paragraph">
<p>The main purpose of MLD is for multicast routers to learn the multicast addresses used by the hosts on each link to which they are mutually attached.</p>
</div>
<div class="paragraph">
<p>MLDv2 extends this capability by allowing hosts to specify particular hosts from which they wish to (or not to) receive traffic.</p>
</div>
<div class="paragraph">
<p>Two forms of MLD queries (type 130) are sent by multicast routers: <em>general queries</em> and <em>multicast-address-specific queries</em>.</p>
</div>
<div class="paragraph">
<p>Generally, routers send the query messages and hosts respond with reports, either in response to the queries, or unsolicited if a host&#8217;s multicast address membership changes.</p>
</div>
<div class="paragraph">
<p>The <em>Maximum Response Time</em> field, nonzero only in queries, gives the maximum number of milliseconds a host may delay sending a report in response to a query.</p>
</div>
<div class="paragraph">
<p>The <em>Multicast Address</em> field is 0 for general queries and the address for which the router is interested in reports otherwise.</p>
</div>
<div class="paragraph">
<p>For MLD Report messages (type 131) and MLD Done messages (type 132) it includes the address related to the report or what address is no longer of interest, respectively.</p>
</div>
</div>
<div class="sect2">
<h3 id="version-2-multicast-listener-discovery-mldv2-icmpv6-type-143">4.4. Version 2 Multicast Listener Discovery (MLDv2) (ICMPv6 Type 143)</h3>
<div class="paragraph">
<p>MLDv2 extends the MLD Query message with additional information pertaining to specific sources. The first 24 bytes of the message are identical to the common MLD format.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="neighbor-discovery-in-ipv6">5. Neighbor Discovery in IPv6</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>Neighbor Discovery Protocol</em> in IPv6 (sometimes abbreviated as NDP or ND) [RFC4861] brings together the <em>Router Discovery</em> and <em>Redirect</em> mechanisms of ICMPv4 with the address-mapping capabilities provided by <em>ARP</em>.</p>
</div>
<div class="paragraph">
<p>It is also specified for use in supporting <em>Mobile IPv6</em>.</p>
</div>
<div class="paragraph">
<p>In contrast to ARP and IPv4, which generally use broadcast addressing (except for Router Discovery), ICMPv6 makes extensive use of multicast addressing, at both the network and link layers. (Recall that IPv6 does not even have broadcast addresses.)</p>
</div>
<div class="paragraph">
<p>ND is designed to allow nodes (routers and hosts) on the same link or segment to find each other, determine if they have bidirectional connectivity, and determine if a neighbor has become inoperative or unavailable. It also supports <em>stateless address autoconfiguration</em>. All of the ND functionality is provided by ICMPv6 at or above the network layer, making it largely independent of the particular link-layer technology employed underneath. However, ND does prefer to make use of link-layer multicast capabilities, and for this reason operation on non-broadcast- and non-multicast-capable link layers (called non-broadcast multiple access or NBMA links) may differ somewhat.</p>
</div>
<div class="paragraph">
<p>The two main parts of ND are</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Neighbor Solicitation/Advertisement (NS/NA)</em>, which provides the ARP-like function of mapping between network- and link-layer addresses,</p>
</li>
<li>
<p>and <em>Router Solicitation/Advertisement (RS/RA)</em>, which provides the functions of router discovery, Mobile IP agent discovery, and redirects, as well as some support for autoconfiguration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A secure variant of ND called SEND [RFC3971] adds authentication and special forms of addressing, primarily by introducing additional ND options.</p>
</div>
<div class="paragraph">
<p>ND messages are ICMPv6 messages sent using an IPv6 Hop Limit field value of 255. Receivers verify that incoming ND messages have this value to protect against off-link senders that may attempt to spoof local ICMPv6 messages (such messages would arrive with values less than 255).</p>
</div>
<div class="sect2">
<h3 id="icmpv6-router-solicitation-and-advertisement-icmpv6-types-133-134">5.1. ICMPv6 Router Solicitation and Advertisement (ICMPv6 Types 133, 134)</h3>
<div class="paragraph">
<p><strong>Router Advertisement (RA)</strong> messages indicate the presence and capabilities of a nearby router.</p>
</div>
<div class="paragraph">
<p>They are sent periodically by routers, or in response to a <strong>Router Solicitation (RS) message</strong>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/icmpv6-rs-message.png" alt="ICMPv6 Router Solicitation message" width="55%" height="55%">
</div>
<div class="title">Figure 9. The ICMPv6 Router Solicitation message is very simple but ordinarily contains a Source Link-Layer Address option (unlike its ICMPv4 counterpart). It may also contain an MTU option if an unusual MTU value is in use on the link.</div>
</div>
<div class="paragraph">
<p>The RS message is used to induce on-link routers to send RA messages. RS messages are sent to the <em>All Routers multicast address</em>, <em>ff02::2</em>. A Source Link-Layer Address option is supposed to be included if the sender of the message is using an IPv6 address other than the unspecified address (used during autoconfiguration). It is the only valid option for such messages as of [RFC4861].</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/icmpv6-ra-message.png" alt="ICMPv6 Router Advertisement message" width="55%" height="55%">
</div>
<div class="title">Figure 10. An ICMPv6 Router Advertisement message is sent to the All Nodes multicast address (ff02::1). Receiving nodes check to make sure that the Hop Limit field is 255, ensuring that the packet has not been forwarded through a router. The message includes three flags: M (Managed address configuration), O (Other stateful configuration), and H (Home Agent).</div>
</div>
<div class="paragraph">
<p>The Router Advertisement (RA) message is sent by routers to the <em>All Nodes multicast address</em> (<em>ff02::1</em>) or the <em>unicast address</em> of the requesting host, if the advertisement is sent in response to a solicitation. RA messages inform local hosts and other routers of configuration details relevant to the local link.</p>
</div>
</div>
<div class="sect2">
<h3 id="icmpv6-neighbor-solicitation-and-advertisement-imcpv6-types-135-136">5.2. ICMPv6 Neighbor Solicitation and Advertisement (IMCPv6 Types 135, 136)</h3>
<div class="paragraph">
<p>The <strong>Neighbor Solicitation (NS)</strong> message in ICMPv6 effectively replaces the <em>ARP Request</em> messages used with IPv4.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Its primary purpose is to convert IPv6 addresses to link-layer addresses.</p>
<div class="paragraph">
<p>When used to determine address mappings, it is sent to the <em>Solicited-Node multicast address</em> corresponding to the IPv6 address contained in the <em>Target Address</em> field (prefix <em>f02::1:f/104</em>, combined with the low-order 24 bits of the solicited IPv6 address).</p>
</div>
</li>
<li>
<p>However, it is also used for detecting whether nearby nodes can be reached, and if they can be reached bidirectionally (that is, whether the nodes can talk to each other).</p>
<div class="paragraph">
<p>When this message is used to determine connectivity to a neighbor, it is sent to that neighbor&#8217;s IPv6 unicast address instead of the Solicited-Node address.</p>
</div>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/icmpv6-ns-message.png" alt="ICMPv6 Neighbor Solicitation message" width="55%" height="55%">
</div>
<div class="title">Figure 11. The ICMPv6 Neighbor Solicitation message is similar to the RS message but contains a target IPv6 address. These messages are sent to Solicited-Node multicast addresses to provide ARP-like functionality and to unicast addresses to test reachability to other nodes. NS messages contain a Source Link-Layer Address option on links that use lower-layer addressing.</div>
</div>
<div class="paragraph">
<p>The NS message contains the IPv6 address for which the sender is trying to learn the link-layer address.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The message may contain the <em>Source Link-Layer Address</em> option.</p>
<div class="paragraph">
<p>This option must be included in networks that use link-layer addressing when the solicitation is sent to a multicast address and should be included for unicast solicitations.</p>
</div>
</li>
<li>
<p>If the sender of the message is using the unspecified address as its source address (e.g., during duplicate address detection), this option is not to be included.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/icmpv6-na-message.png" alt="ICMPv6 Neighbor Advertisement message" width="55%" height="55%">
</div>
<div class="title">Figure 12. The ICMPv6 Neighbor Advertisement message contains the following flags: <em>R</em> indicates that the sender is a router, <em>S</em> indicates that the advertisement is a response to a solicitation, and <em>O</em> indicates that the message contents should override other cached address mappings. The <em>Target Address</em> field contains the IPv6 address of the sender of the message (generally, the unicast address of the solicited node from the ND solicitation). A <em>Target Link-Layer Address</em> option is included to enable ARP-like functionality for IPv6.</div>
</div>
<div class="paragraph">
<p>The ICMPv6 Neighbor Advertisement (NA) message serves the purpose of the ARP Response message in IPv4 in addition to helping with neighbor unreachability detection .</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is either sent as a response to an NS message or sent asynchronously when a node&#8217;s IPv6 address changes.</p>
<div class="paragraph">
<p>It is sent either to</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the unicast address of the soliciting node,</p>
</li>
<li>
<p>or to the <em>All Nodes multicast address</em> if the soliciting node used the unspecified address as its source address.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The <em>R (Router)</em> field indicates that the sender of the message is a router.</p>
<div class="paragraph">
<p>This could change, for example, if a router ceases being a router and becomes only a host instead.</p>
</div>
</li>
<li>
<p>The <em>S (Solicited)</em> field indicates that the advertisement is in response to a solicitation received earlier.</p>
<div class="paragraph">
<p>This field is used to verify that bidirectional connectivity between neighbors has been achieved.</p>
</div>
</li>
<li>
<p>The <em>O (Override)</em> field indicates that information in the advertisement should override any previously cached information the receiver of the message has.</p>
<div class="paragraph">
<p>It is not supposed to be set for solicited advertisements, for anycast addresses, or in solicited proxy advertisements.</p>
</div>
<div class="paragraph">
<p>It is supposed to be set in other (solicited or unsolicited) advertisements.</p>
</div>
</li>
<li>
<p>For solicited advertisements, the <em>Target Address</em> field is the IPv6 address being looked up.</p>
<div class="paragraph">
<p>For unsolicited advertisements, it is the IPv6 address that corresponds to a link-layer address that has changed.</p>
</div>
<div class="paragraph">
<p>This message must contain the <em>Target Link-Layer Address</em> option on networks that support link-layer addressing when the advertisement was solicited via a multicast address.</p>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-0:~$</span><span class="w"> </span><span class="nb">sudo </span>ip <span class="nt">-6</span> n flush all
<span class="gp">x@node-0:~$</span><span class="w"> </span>ping <span class="nt">-c</span> 1 <span class="nt">-I</span> fe80::20c:29ff:fe8c:df3f%ens32 fe80::20c:29ff:fe85:2607
<span class="go">PING fe80::20c:29ff:fe85:2607(fe80::20c:29ff:fe85:2607) from fe80::20c:29ff:fe8c:df3f%ens32 ens32: 56 data bytes
64 bytes from fe80::20c:29ff:fe85:2607%ens32: icmp_seq=1 ttl=64 time=9.09 ms

--- fe80::20c:29ff:fe85:2607 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 9.085/9.085/9.085/0.000 ms</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">root@node-0:~#</span><span class="w"> </span>tcpdump <span class="nt">-tvvn</span> <span class="nt">-s1500</span> <span class="nt">-p</span> icmp6
<span class="go">tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 1500 bytes
</span><span class="gp">IP6 (hlim 255, next-header ICMPv6 (58) payload length: 32) fe80::20c:29ff:fe8c:df3f &gt;</span><span class="w"> </span>ff02::1:ff85:2607: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, neighbor solicitation, length 32, <span class="nb">who </span>has fe80::20c:29ff:fe85:2607
<span class="go">	  source link-address option (1), length 8 (1): 00:0c:29:8c:df:3f
	    0x0000:  000c 298c df3f
</span><span class="gp">IP6 (hlim 255, next-header ICMPv6 (58) payload length: 32) fe80::20c:29ff:fe85:2607 &gt;</span><span class="w"> </span>fe80::20c:29ff:fe8c:df3f: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, neighbor advertisement, length 32, tgt is fe80::20c:29ff:fe85:2607, Flags <span class="o">[</span>solicited, override]
<span class="go">	  destination link-address option (2), length 8 (1): 00:0c:29:85:26:07
	    0x0000:  000c 2985 2607
</span><span class="gp">IP6 (flowlabel 0x1bc9d, hlim 64, next-header ICMPv6 (58) payload length: 64) fe80::20c:29ff:fe8c:df3f &gt;</span><span class="w"> </span>fe80::20c:29ff:fe85:2607: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, <span class="nb">echo </span>request, <span class="nb">id </span>36469, <span class="nb">seq </span>1
<span class="gp">IP6 (flowlabel 0xfb479, hlim 64, next-header ICMPv6 (58) payload length: 64) fe80::20c:29ff:fe85:2607 &gt;</span><span class="w"> </span>fe80::20c:29ff:fe8c:df3f: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, <span class="nb">echo </span>reply, <span class="nb">id </span>36469, <span class="nb">seq </span>1
<span class="gp">IP6 (hlim 255, next-header ICMPv6 (58) payload length: 32) fe80::20c:29ff:fe85:2607 &gt;</span><span class="w"> </span>fe80::20c:29ff:fe8c:df3f: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, neighbor solicitation, length 32, <span class="nb">who </span>has fe80::20c:29ff:fe8c:df3f
<span class="go">	  source link-address option (1), length 8 (1): 00:0c:29:85:26:07
	    0x0000:  000c 2985 2607
</span><span class="gp">IP6 (hlim 255, next-header ICMPv6 (58) payload length: 24) fe80::20c:29ff:fe8c:df3f &gt;</span><span class="w"> </span>fe80::20c:29ff:fe85:2607: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, neighbor advertisement, length 24, tgt is fe80::20c:29ff:fe8c:df3f, Flags <span class="o">[</span>solicited]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="icmpv6-inverse-neighbor-discovery-solicitationadvertisement-icmpv6-types-141142">5.3. ICMPv6 Inverse Neighbor Discovery Solicitation/Advertisement (ICMPv6 Types 141/142)</h3>
<div class="paragraph">
<p>The <em>Inverse Neighbor Discovery</em> (IND) facility in IPv6 [RFC3122] originated from a need to determine IPv6 addresses given link-layer addresses on Frame Relay networks.</p>
</div>
<div class="paragraph">
<p>It resembles <em>reverse ARP</em>, a protocol once used with IPv4 networks primarily for supporting diskless computers.</p>
</div>
<div class="paragraph">
<p>Its main function is to ascertain the networklayer address(es) corresponding to a known link-layer address.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/icmpv6-ind-solicitation-advertisement-message.png" alt="ICMPv6 IND Message" width="45%" height="45%">
</div>
<div class="title">Figure 13. The ICMPv6 IND Solicitation (type 141) and Advertisement (type 142) messages have the same basic format. They are used to map known link-layer addresses to IPv6 addresses in environments where this is useful.</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The IND Solicitation message is sent to the <em>All Nodes multicast address</em> at the IPv6 layer but is encapsulated in a unicast link-layer address (the one being looked up).</p>
</li>
<li>
<p>It must contain both a <em>Source Link-Layer Address</em> option and a <em>Destination Link-Layer Address</em> option.</p>
</li>
<li>
<p>It may also contain a <em>Source/Target Address List</em> option and/or an <em>MTU</em> option.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="neighbor-unreachability-detection-nud">5.4. Neighbor Unreachability Detection (NUD)</h3>
<div class="paragraph">
<p>One of the important features of ND is to detect when reachability between two systems on the same link has become lost or asymmetric (i.e., is not available in both directions).</p>
</div>
<div class="paragraph">
<p>This is accomplished using the <strong>Neighbor Unreachability Detection</strong> (NUD) algorithm. It is used to manage the <em>neighbor cache</em> present on each node.</p>
</div>
<div class="paragraph">
<p>The neighbor cache is analogous to the ARP cache; it is a (conceptual) data structure that holds the IPv6-to-link-layer-address mapping information required to perform direct delivery of IPv6 datagrams to on-link neighbors as well as information regarding the state of the mapping.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/nud-neighbor-cache-states.png" alt="NUD Neighbor Cache States" width="55%" height="55%">
</div>
<div class="title">Figure 14. Neighbor Unreachability Detection helps maintain the neighbor cache consisting of several neighbor entries. Each entry is in one of five states at any given time. Confirmations of reachability are accomplished by receiving Neighbor Advertisement messages or using other higher-layer protocol information, if available. Unsolicited evidence includes unsolicited Neighbor and Router Advertisement messages.</div>
</div>
<div class="paragraph">
<p>Each mapping may be in one of five states: INCOMPLETE, REACHABLE, STALE, DELAY, or PROBE.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The transition diagram shows the initial states to be either INCOMPLETE or STALE.</p>
</li>
<li>
<p>When an IPv6 node has a unicast datagram to send to a destination, it checks its destination cache to see if an entry corresponding to the destination is present.</p>
<div class="ulist">
<ul>
<li>
<p>If so, and the destination is on-link, the neighbor cache is consulted to see if the neighbor&#8217;s state is REACHABLE.</p>
<div class="paragraph">
<p>If so, the datagram is sent using direct delivery.</p>
</div>
</li>
<li>
<p>If no neighbor cache entry is present but the destination appears to be on-link, NUD enters the INCOMPLETE state and sends an NS message.</p>
<div class="paragraph">
<p>Successful receipt of a solicited NA message provides confirmation that the node is reachable, and the entry enters the REACHABLE state.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>The STALE state corresponds to apparently valid entries that have not yet been confirmed.</p>
<div class="paragraph">
<p>This state is entered</p>
</div>
<div class="ulist">
<ul>
<li>
<p>when either an entry has not been updated for some time when it was previously REACHABLE,</p>
</li>
<li>
<p>or when unsolicited information is received (e.g., a node has changed its address and sent an unsolicited NA message).</p>
<div class="paragraph">
<p>These cases suggest that reachability is possible, but confirmation in the form of a valid NA is still required.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>The other states, DELAY and PROBE, are temporary states.</p>
<div class="ulist">
<ul>
<li>
<p>DELAY is used when a packet is sent but ND has no current evidence to suggest that reachability is possible.</p>
<div class="paragraph">
<p>The state gives upper-layer protocols an opportunity to provide additional evidence.</p>
</div>
</li>
<li>
<p>If after DELAY_FIRST_PROBE_TIME seconds (the constant 5) no evidence is received, the state changes to PROBE.</p>
</li>
<li>
<p>In the PROBE state, ND sends periodic NS messages (every RetransTimer milliseconds, with constant default value RETRANS_ TIMER equal to 1000).</p>
<div class="paragraph">
<p>If no evidence has been received after sending MAX_UNICAST_SOLICIT NS messages (default 3), the entry is supposed to be deleted.</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-0:~$</span><span class="w"> </span><span class="nb">sudo  </span>ip <span class="nt">-6</span> n flush all
<span class="go">
</span><span class="gp">x@node-0:~$</span><span class="w"> </span>ping <span class="nt">-c</span> 1 <span class="nt">-6</span> ff02::1%ens32
<span class="go">PING ff02::1%ens32(ff02::1%ens32) 56 data bytes
64 bytes from fe80::20c:29ff:fe8c:df3f%ens32: icmp_seq=1 ttl=64 time=0.022 ms

--- ff02::1%ens32 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.022/0.022/0.022/0.000 ms

</span><span class="gp">x@node-0:~$</span><span class="w"> </span>ip <span class="nt">-6</span> n
<span class="go">fe80::20c:29ff:fe85:2607 dev ens32 lladdr 00:0c:29:85:26:07 DELAY

</span><span class="gp">x@node-0:~$</span><span class="w"> </span>ip <span class="nt">-6</span> n
<span class="go">fe80::20c:29ff:fe85:2607 dev ens32 lladdr 00:0c:29:85:26:07 REACHABLE

</span><span class="gp">x@node-0:~$</span><span class="w"> </span>ip <span class="nt">-6</span> n
<span class="go">fe80::20c:29ff:fe85:2607 dev ens32 lladdr 00:0c:29:85:26:07 STALE</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">root@node-0:~#</span><span class="w"> </span>tcpdump <span class="nt">-tnvv</span> icmp6 <span class="nt">-i</span> ens32
<span class="go">tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 262144 bytes
</span><span class="gp">IP6 (flowlabel 0xc865c, hlim 1, next-header ICMPv6 (58) payload length: 64) fe80::20c:29ff:fe8c:df3f &gt;</span><span class="w"> </span>ff02::1: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, <span class="nb">echo </span>request, <span class="nb">id </span>52700, <span class="nb">seq </span>1
<span class="gp">IP6 (flowlabel 0x3ad83, hlim 64, next-header ICMPv6 (58) payload length: 64) fe80::20c:29ff:fe85:2607 &gt;</span><span class="w"> </span>fe80::20c:29ff:fe8c:df3f: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, <span class="nb">echo </span>reply, <span class="nb">id </span>52700, <span class="nb">seq </span>1
<span class="gp">IP6 (hlim 255, next-header ICMPv6 (58) payload length: 32) fe80::20c:29ff:fe85:2607 &gt;</span><span class="w"> </span>fe80::20c:29ff:fe8c:df3f: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, neighbor solicitation, length 32, <span class="nb">who </span>has fe80::20c:29ff:fe8c:df3f
<span class="go">	  source link-address option (1), length 8 (1): 00:0c:29:85:26:07
	    0x0000:  000c 2985 2607
</span><span class="gp">IP6 (hlim 255, next-header ICMPv6 (58) payload length: 24) fe80::20c:29ff:fe8c:df3f &gt;</span><span class="w"> </span>fe80::20c:29ff:fe85:2607: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, neighbor advertisement, length 24, tgt is fe80::20c:29ff:fe8c:df3f, Flags <span class="o">[</span>solicited]
<span class="gp">IP6 (hlim 255, next-header ICMPv6 (58) payload length: 32) fe80::20c:29ff:fe8c:df3f &gt;</span><span class="w"> </span>fe80::20c:29ff:fe85:2607: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, neighbor solicitation, length 32, <span class="nb">who </span>has fe80::20c:29ff:fe85:2607
<span class="go">	  source link-address option (1), length 8 (1): 00:0c:29:8c:df:3f
	    0x0000:  000c 298c df3f
</span><span class="gp">IP6 (hlim 255, next-header ICMPv6 (58) payload length: 24) fe80::20c:29ff:fe85:2607 &gt;</span><span class="w"> </span>fe80::20c:29ff:fe8c:df3f: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, neighbor advertisement, length 24, tgt is fe80::20c:29ff:fe85:2607, Flags <span class="o">[</span>solicited]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">root@node-1:~#</span><span class="w"> </span>ip a show ens32
<span class="gp">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span><span class="w"> </span>mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
<span class="go">    link/ether 00:0c:29:85:26:07 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::20c:29ff:fe85:2607/64 scope link
       valid_lft forever preferred_lft forever

</span><span class="gp">root@node-1:~#</span><span class="w"> </span>ip <span class="nb">link set </span>ens32 down <span class="o">&amp;&amp;</span> ip <span class="nb">link set </span>ens32 address 00:0c:29:85:26:10 <span class="o">&amp;&amp;</span> ip <span class="nb">link set </span>ens32 up
<span class="go">
</span><span class="gp">root@node-1:~#</span><span class="w"> </span>ip a show ens32
<span class="gp">2: ens32: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span><span class="w"> </span>mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
<span class="go">    link/ether 00:0c:29:85:26:10 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::20c:29ff:fe85:2610/64 scope link
       valid_lft forever preferred_lft forever</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">x@node-0:~$</span><span class="w"> </span>ping <span class="nt">-c</span> 1 fe80::20c:29ff:fe85:2607%ens32
<span class="go">PING fe80::20c:29ff:fe85:2607%ens32(fe80::20c:29ff:fe85:2607%ens32) 56 data bytes
From fe80::20c:29ff:fe8c:df3f%ens32 icmp_seq=1 Destination unreachable: Address unreachable

--- fe80::20c:29ff:fe85:2607%ens32 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms

</span><span class="gp">x@node-0:~$</span><span class="w"> </span>ip <span class="nt">-6</span> n
<span class="go">fe80::20c:29ff:fe85:2607 dev ens32  FAILED</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="icmpv6-neighbor-discovery-nd-options">5.5. ICMPv6 Neighbor Discovery (ND) Options</h3>
<div class="paragraph">
<p>ND messages may contain zero or more options, and some options can occur more than once. However, with certain messages some of the options are mandatory.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip/internet-control-message-protocol/nd-options-format.png" alt="ND Options" width="45%" height="45%">
</div>
<div class="title">Figure 15. ND options are variable-length and begin with a common TLV arrangement. The Length field gives the total length of the option in 8-byte units (including the Type and Length fields).</div>
</div>
<div class="ulist">
<ul>
<li>
<p>All ND options start with an 8-bit <em>Type</em> and an 8-bit <em>Length</em> field, supporting options of variable length, up to 255 bytes.</p>
</li>
<li>
<p>Options are padded to 8-byte boundaries, and the <em>Length</em> field gives the total length of the option in 8-byte units.</p>
</li>
<li>
<p>The <em>Type</em> and <em>Length</em> fields are included in the value of the <em>Length</em> field, which has a minimum value of 1.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. IPv6 ND option types, defining reference, use, and description</caption>
<colgroup>
<col style="width: 5.2631%;">
<col style="width: 26.3157%;">
<col style="width: 10.5263%;">
<col style="width: 57.8949%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Reference</th>
<th class="tableblock halign-left valign-top">Use/Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source Link-Layer Address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4861]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sender&#8217;s link-layer address; used with NS, RS,
and RA messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Target Link-Layer
Address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4861]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Target&#8217;s link-layer address; used with NA and
Redirect messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prefix Information</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4861]
[RFC6275]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An IPv6 prefix or address; used with RA
messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Redirected Header</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4861]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Portion of original IPv6 datagram; used with
Redirect messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MTU</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4861]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Recommended MTU; used with RA messages,
IND Advertisement messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NMBA Shortcut Limit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2491]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hop limit for "shortcut attempt"; used with NS
messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Advertisement Interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC6275]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sending interval of unsolicited RA messages;
used with RA messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Home Agent Information</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC6275]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Preference and lifetime to be an MIPv6 HA;
used with RA messages (H bit on)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Source Address List</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3122]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Host&#8217;s addresses; used with IND messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Target Address List</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3122]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Target addresses; used with IND messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CGA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3971]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crypto-based address; used with secure
Neighbor Discovery (SEND) messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RSA Signature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3971]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Credential for host signature (SEND)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3971]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anti-replay timestamp (SEND)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nonce</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3971]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anti-replay random number (SEND)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trust Anchor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3971]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates credential type (SEND)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Certificate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3971]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Encodes a certificate (SEND)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IP Address/Prefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC5568]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Care-of or NAR addresses; used with FMIPv6
PrRtAdv messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Link-Layer Address</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC5568]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Desired next access point or mobile node&#8217;s
address; used with FMIPv6 RtSolPr or
PrRtAdv messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Neighbor Advertisement
ACK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC5568]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tells mobile about next valid CoA; used with
RA messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">24</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Route Information</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4191]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Route prefix/preferred router list</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Recursive DNS Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC6106]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IP address of DNS server; added to RA
messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RA Flags Extension</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC5175]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expands space for RA flags</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">27</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handover Key Request</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC5269]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FMIPv6—request key using SEND</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">28</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Handover Key Reply</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC5269]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FMIPv6—key reply using SEND</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS Search List</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC6106]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS domain search names; added to RA
messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">253,
254</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Experimental</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4727]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3692]-style experiments 1/2</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references">References</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="tcp_ip_vol_1"></a>[1] Kevin Fall, W. Stevens <em>TCP/IP Illustrated: The Protocols, Volume 1</em>. 2nd edition, Addison-Wesley Professional, 2011</p>
</li>
</ul>
</div>
</div>
</div>
  </div>

  <ul class="post-navigation">
    <li>
      
      <a href="/2022/11/28/tcp-ip-dhcp-autoconfiguration/">&laquo; TCP/IP: DHCP and Autoconfiguration</a>
      
    </li>
    <li>
      
      <a href="/2022/12/05/tcp-ip-broadcasting-and-local-multicasting-igmp-and-mld/">TCP/IP: Broadcasting and Local Multicasting (IGMP and MLD) &raquo;</a>
      
    </li>
  </ul>
</article>

      </div>
    </div>

    <footer class="site-footer">
  <div class="license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details open>
    <summary>Extral Links</summary>
    <div>
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>


<!-- https://github.com/bryanbraun/anchorjs -->
<script src="/js/anchor.min.js"></script>
<script>
  anchors.add();
  anchors.remove(".site-title");
</script>




  </body>

</html>

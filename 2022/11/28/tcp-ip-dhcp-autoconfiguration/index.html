<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bing WebMaster -->
  <meta name="msvalidate.01" content="AB2FFF876C37F59D9121882CC8395DE5" />

  <title>TCP/IP: DHCP and Autoconfiguration</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://blog.codefarm.me/2022/11/28/tcp-ip-dhcp-autoconfiguration/">
  <link rel="alternate" type="application/rss+xml" title="CODE FARM" href="https://blog.codefarm.me/feed.xml">

  <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->
<script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>

  
<!-- Google Analytics Website tracking -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83971182-1', 'auto');
  ga('send', 'pageview');

</script>


  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SN88FJ18E5');
</script>



</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
    <h2 class="site-title">
      <a class="site-title" href="/">CODE FARM</a>
    </h2>

     <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
        <div class="trigger">
            <ul>
                <li><a href="/">home</a>
                <li><a href="/category">category</a>
                <li><a href="/tag">tag</a>
                <li><a href="/archive">archive</a>
                <li><a href="/about">about</a>
                <li><a href="https://resume.github.io/?qqbuby" target="_blank">R&eacute;sum&eacute;</a>
            </ul>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">TCP/IP: DHCP and Autoconfiguration</h1>
    
    
    <p class="post-meta"><time datetime="2022-11-28T08:54:54+08:00" itemprop="datePublished">Nov 28, 2022</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>To make use of the TCP/IP protocol suite, each host and router requires a certain amount of configuration information.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Every interface to be used with TCP/IP networking requires an</p>
<div class="ulist">
<ul>
<li>
<p><em>IP address</em>,</p>
</li>
<li>
<p><em>subnet mask</em>, and</p>
</li>
<li>
<p><em>broadcast address</em> (for IPv4).</p>
</li>
</ul>
</div>
</li>
<li>
<p>To engage in communication beyond the local subnet, called <em>indirect delivery</em>, a system requires a <em>routing or forwarding table</em> that indicates what router(s) are to be used for reaching various destinations.</p>
</li>
<li>
<p>To be able to use services such as the Web and e-mail, the <em>DNS</em> is used to map user-friendly domain names to the IP addresses required by the lower-protocol layers.</p>
</li>
<li>
<p>To use <em>Mobile IP</em>, a system also needs to know how to find a <em>home agent</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All in all, having an <em>IP address</em>, <em>subnet mask</em>, and the IP address of a <em>DNS server</em> and <em>router</em> are the <em>bare essentials</em> to get a system running on the Internet that is capable of using or providing popular services such as Web and e-mail.</p>
</div>
<div class="paragraph">
<p>Beyond the bare essentials, there are numerous other bits of configuration information a host or router may require, depending on the types of services it uses or provides.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>These may include the locations of <em>home agents</em>, <em>multicast routers</em>, <em>VPN gateways</em>, and <em>Session Initiation Protocol (SIP)/VoIP gateways</em>.</p>
</li>
</ul>
</div>
</div>
<div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#dynamic-host-configuration-protocol-dhcp">1. Dynamic Host Configuration Protocol (DHCP)</a>
<ul class="sectlevel2">
<li><a href="#address-pools-and-leases">1.1. Address Pools and Leases</a></li>
<li><a href="#dhcp-and-bootp-message-format">1.2. DHCP and BOOTP Message Format</a></li>
<li><a href="#dhcp-and-bootp-options">1.3. DHCP and BOOTP Options</a></li>
<li><a href="#dhcp-protocol-operation">1.4. DHCP Protocol Operation</a></li>
<li><a href="#the-dhcp-state-machine">1.5. The DHCP State Machine</a></li>
<li><a href="#dhcpv6">1.6. DHCPv6</a>
<ul class="sectlevel3">
<li><a href="#ipv6-address-lifecycle">1.6.1. IPv6 Address Lifecycle</a></li>
<li><a href="#dhcpv6-message-format">1.6.2. DHCPv6 Message Format</a></li>
<li><a href="#identity-association-ia">1.6.3. Identity Association (IA)</a></li>
<li><a href="#dhcp-unique-identifier-duid">1.6.4. DHCP Unique Identifier (DUID)</a></li>
<li><a href="#protocol-operation">1.6.5. Protocol Operation</a></li>
</ul>
</li>
<li><a href="#rapid-commit">1.7. Rapid Commit</a></li>
</ul>
</li>
<li><a href="#stateless-address-autoconfiguration-slaac">2. Stateless Address Autoconfiguration (SLAAC)</a>
<ul class="sectlevel2">
<li><a href="#dynamic-configuration-of-ipv4-link-local-addresses">2.1. Dynamic Configuration of IPv4 Link-Local Addresses</a></li>
<li><a href="#ipv6-slaac-for-link-local-addresses">2.2. IPv6 SLAAC for Link-Local Addresses</a></li>
<li><a href="#ipv6-duplicate-address-detection-dad">2.3. IPv6 Duplicate Address Detection (DAD)</a></li>
<li><a href="#ipv6-slaac-for-global-addresses">2.4. IPv6 SLAAC for Global Addresses</a></li>
</ul>
</li>
<li><a href="#ppp-over-ethernet-pppoe">3. PPP over Ethernet (PPPoE)</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>
</div>
<div class="sect1">
<h2 id="dynamic-host-configuration-protocol-dhcp">1. Dynamic Host Configuration Protocol (DHCP)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>DHCP [RFC2131] is a popular client/server protocol used to assign configuration information to hosts (and, less frequently, to routers).</p>
</div>
<div class="paragraph">
<p>DHCP is very widely used, in both enterprises and home networks.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Even the most basic home router devices support embedded DHCP servers.</p>
</li>
<li>
<p>DHCP clients are incorporated into all common client operating systems and a large number of embedded devices such as network printers and VoIP phones.</p>
<div class="paragraph">
<p>Such devices usually use DHCP to acquire their <em>IP address</em>, <em>subnet mask</em>, <em>router IP address</em>, and <em>DNS server IP address</em>.</p>
</div>
</li>
<li>
<p>Information pertaining to other services (e.g., SIP servers used with VoIP) may also be conveyed using DHCP.</p>
</li>
<li>
<p>DHCP was originally conceived for use with IPv4, IPv6 can also use a version of DHCP called DHCPv6 [RFC3315].</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The design of DHCP is based on an earlier protocol called the Internet <em>Bootstrap Protocol (BOOTP)</em> [RFC0951][RFC1542], which is now effectively obsolete.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>BOOTP provides limited configuration information to clients and does not have a mechanism to support changing that information after it has been provided.</p>
</li>
<li>
<p>DHCP extends the BOOTP model with the concept of <em>leases</em> and can provide all information required for a host to operate.</p>
<div class="paragraph">
<p>Leases allow clients to use the configuration information for an agreed-upon amount of time.</p>
</div>
<div class="paragraph">
<p>A client may request to renew the lease and continue operations, subject to agreement from the DHCP server.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>BOOTP and DHCP are backward-compatible in the sense that BOOTP-only clients can make use of DHCP servers and DHCP clients can make use of BOOTP-only servers.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>BOOTP, and therefore DHCP as well, is carried using UDP/IP. Clients use port <em>68</em> and servers use port <em>67</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>DHCP comprises two major parts: address management and delivery of configuration data.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Address management handles the dynamic allocation of IP addresses and provides address leases to clients.</p>
</li>
<li>
<p>Configuration data delivery includes the DHCP protocol&#8217;s message formats and state machines.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A DHCP server can be configured to provide three levels of address allocation: <em>automatic allocation</em>, <em>dynamic allocation</em>, and <em>manual allocation</em>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The most commonly used method is <em>dynamic allocation</em>, whereby a client is given a revocable IP address from a pool (usually a predefined range) of addresses configured at the server.</p>
</li>
<li>
<p>In <em>automatic allocation</em>, the same method is used but the address is never revoked.</p>
</li>
<li>
<p>In <em>manual allocation</em>, the DHCP protocol is used to convey the address, but the address is fixed for the requesting client (i.e., it is not part of an allocatable pool maintained by the server).</p>
</li>
<li>
<p>In this last mode, DHCP acts like BOOTP.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The differences among the three have to do with whether the addresses assigned are based on the identity of the client and whether such addresses are subject to being revoked or changed.</p>
</div>
<div class="sect2">
<h3 id="address-pools-and-leases">1.1. Address Pools and Leases</h3>
<div class="paragraph">
<p>In dynamic allocation, a DHCP client requests the allocation of an IP address.</p>
</div>
<div class="paragraph">
<p>The server responds with one address selected from a pool of available addresses.</p>
</div>
<div class="paragraph">
<p>Typically, the pool is a contiguous range of IP addresses allocated specifically for DHCP&#8217;s use.</p>
</div>
<div class="paragraph">
<p>The address given to the client is allocated for only a specific amount of time, called the <em>lease duration</em>.</p>
</div>
<div class="paragraph">
<p>The client is permitted to use the IP address until the lease expires, although it may request extension of the lease as required.</p>
</div>
<div class="paragraph">
<p>In most situations, clients are able to renew leases they wish to extend.</p>
</div>
</div>
<div class="sect2">
<h3 id="dhcp-and-bootp-message-format">1.2. DHCP and BOOTP Message Format</h3>
<div class="paragraph">
<p>DHCP extends BOOTP, DHCP&#8217;s predecessor. Compatibility is maintained between the protocols by defining the DHCP message format as an extension to BOOTP&#8217;s in such a way that BOOTP clients can be served by DHCP servers, and BOOTP <em>relay agents</em> can be used to support DHCP use, even on networks where DHCP servers do not reside.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip-dhcp-autoconfiguration/bootp-message-format.png" alt="BOOTP Message Format" width="75%" height="75%">
</div>
<div class="title">Figure 1. The BOOTP message format, including field names from [RFC0951], [RFC1542], and [RFC2131]. The BOOTP message format is used to hold DHCP messages by appropriate assignment of options. In this way, BOOTP relay agents can process DHCP messages, and BOOTP clients can use DHCP servers. The <em>Server Name</em> and <em>Boot File Name</em> fields can be used to carry DHCP options if necessary.</div>
</div>
<div class="paragraph">
<p>The message format is defined by BOOTP and DHCP in several RFCs ([RFC0951][RFC1542][RFC2131]).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <em>Op (Operation)</em> field identifies the message as either a request (<em>1</em>) or a reply (<em>2</em>).</p>
</li>
<li>
<p>The <em>HW Type (htype)</em> field is assigned based on values used with ARP and defined in the corresponding IANA ARP parameters page [IARP], with the value <em>1 (Ethernet)</em> being very common.</p>
</li>
<li>
<p>The <em>HW Len (hlen)</em> field gives the number of bytes used to hold the hardware (MAC) address and is commonly <em>6</em> for Ethernet-like networks.</p>
</li>
<li>
<p>The <em>Hops</em> field is used to store the number of relays through which the message has traveled.</p>
<div class="paragraph">
<p>The sender of the message sets this value to <em>0</em>, and it is incremented at each relay.</p>
</div>
</li>
<li>
<p>The <em>Transaction ID</em> is a (random) number chosen by the client and copied into responses by the server.</p>
<div class="paragraph">
<p>It is used to match replies with requests.</p>
</div>
</li>
<li>
<p>The <em>Secs</em> field is set by the client with the number of seconds that have elapsed since the first attempt to establish or renew an address.</p>
</li>
<li>
<p>The <em>Flags</em> field currently contains only a single defined bit called the <em>broadcast</em> flag.</p>
<div class="paragraph">
<p>Clients may set this bit in requests if they are unable or unwilling to process incoming unicast IP datagrams but can process incoming broadcast datagrams (e.g., because they do not yet have an IP address).</p>
</div>
<div class="paragraph">
<p>Setting the bit informs the server and relays that broadcast addressing should be used for replies.</p>
</div>
</li>
<li>
<p>The <em>Client IP Address (ciaddr)</em> field includes a current IP address of the requestor, if known, and is <em>0</em> otherwise.</p>
</li>
<li>
<p>The <em>Your IP Address (yiaddr)</em> field is filled in by a server when providing an address to a requesting client.</p>
</li>
<li>
<p>The <em>Next Server IP Address (siaddr)</em> field gives the IP address of the next server to use for the client&#8217;s bootstrap process (e.g., if the client needs to download an operating system image that may be accomplished from a server other than the DHCP server).</p>
</li>
<li>
<p>The <em>Gateway (or Relay) IP Address (giaddr)</em> field is filled in by a DHCP or BOOTP relay with its address when forwarding DHCP (BOOTP) messages.</p>
</li>
<li>
<p>The <em>Client Hardware Address (chaddr)</em> field holds a unique identifier of the client and can be used in various ways by the server, including arranging for the same IP address to be given each time a particular client makes an address request.</p>
<div class="paragraph">
<p>This field has traditionally held the client&#8217;s MAC address, which has been used as an identifier.</p>
</div>
<div class="paragraph">
<p>Nowadays, the Client Identifier, an option is preferred for this use.</p>
</div>
</li>
<li>
<p>The remaining fields include the <em>Server Name (sname)</em> and <em>Boot File Name (file)</em> fields.</p>
<div class="paragraph">
<p>These fields are not always filled in, but if they are, they contain 64 or 128 bytes, respectively, of ASCII characters indicating the name of the server or path to the boot file. Such strings are null-terminated, as in the C programming language.
=
They can also be used instead to hold DHCP options if space is tight.</p>
</div>
</li>
<li>
<p>The final field, originally known as the <em>Vendor Extensions</em> field in BOOTP and fixed in length, is now known as the <em>Options</em> field and is variable in length.</p>
<div class="paragraph">
<p>As we shall see, options are used extensively with DHCP and are required to distinguish DHCP messages from legacy BOOTP messages.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="dhcp-and-bootp-options">1.3. DHCP and BOOTP Options</h3>
<div class="paragraph">
<p>Given that DHCP extends BOOTP, any fields needed by DHCP that were not present when BOOTP was designed are carried as options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Options take a standard format beginning with an 8-bit tag indicating the option type.</p>
</li>
<li>
<p>For some options, a fixed number of bytes following the tag contain the option value.</p>
</li>
<li>
<p>All others consist of the tag followed by 1 byte containing the length of the option value (not including the tag or length), followed by a variable number of bytes containing the option value itself.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A large number of options are available with DHCP, some of which are also supported by BOOTP.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The current list is given by the BOOTP/DHCP parameters page.</p>
</li>
<li>
<p>The first 77 options, including the most common ones, are specified in [RFC2132].</p>
</li>
<li>
<p>Common options include <em>Pad (0)</em>, <em>Subnet Mask (1)</em>, <em>Router Address (3)</em>, <em>Domain Name Server (6)</em>, <em>Domain Name (15)</em>, <em>Requested IP Address (50)</em>, <em>Address Lease Time (51)</em>, <em>DHCP Message Type (53)</em>, <em>Server Identifier (54)</em>, <em>Parameter Request List (55)</em>, <em>DHCP Error Message (56)</em>, <em>Lease Renewal Time (58)</em>, <em>Lease Rebinding Time (59)</em>, <em>Client Identifier (61)</em>, <em>Domain Search List (119)</em>, and <em>End (255)</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The DHCP <em>Message Type option (53)</em> is a 1-byte-long option that is always used with DHCP messages and has the following possible values: <em>DHCPDISCOVER (1)</em>, <em>DHCPOFFER (2)</em>, <em>DHCPREQUEST (3)</em>, <em>DHCPDECLINE (4)</em>, <em>DHCPACK (5)</em>, <em>DHCPNAK (6)</em>, <em>DHCPRELEASE (7)</em>, <em>DHCPINFORM (8)</em>, <em>DHCPFORCERENEW (9)</em> [RFC3203], <em>DHCPLEASEQUERY (10)</em>, <em>DHCPLEASEUNASSIGNED (11)</em>, <em>DHCPLEASEUNKNOWN (12)</em>, and <em>DHCPLEASEACTIVE (13)</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="dhcp-protocol-operation">1.4. DHCP Protocol Operation</h3>
<div class="paragraph">
<p>DHCP messages are essentially BOOTP messages with a special set of options.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When a new client attaches to a network, it first discovers what DHCP servers are available and what addresses they are offering.</p>
</li>
<li>
<p>It then decides which server to use and which address it desires and requests it from the offering server (while informing all the servers of its choice).</p>
</li>
<li>
<p>Unless the server has given away the address in the meantime, it responds by acknowledging the address allocation to the requesting client.</p>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip-dhcp-autoconfiguration/dhcp-bootp-exchange.png" alt="DHCP Exchange" width="55%" height="55%">
</div>
<div class="title">Figure 2. A typical DHCP exchange. A client discovers a set of servers and addresses they are offering using broadcast messages, requests the address it desires, and receives an acknowledgment from the selected server. The transaction ID (xid) allows requests and responses to be matched up, and the server ID (an option) indicates which server is providing and committing the provided address binding with the client. If the client already knows the address it desires, the protocol can be simplified to include use of only the REQUEST and ACK messages.</div>
</div>
</li>
<li>
<p>Requesting clients set the BOOTP <em>Op</em> field to BOOTREQUEST and the first 4 bytes of the <em>Options</em> field to the decimal values 99, 130, 83, and 99, respectively (the magic cookie value from [RFC2132]).</p>
</li>
<li>
<p>Messages from client to server are sent as UDP/IP datagrams containing a BOOTP BOOTREQUEST operation and an appropriate DHCP message type (usually DHCPDISCOVER or DHCPREQUEST).</p>
<div class="paragraph">
<p>Such messages are sent from address <em>0.0.0.0</em> (port <em>68</em>) to the limited broadcast address <em>255.255.255.255</em> (port <em>67</em>).</p>
</div>
</li>
<li>
<p>Messages traveling in the other direction (from server to client) are sent from the IP address of the server and port <em>67</em> to the IP local broadcast address and port <em>68</em>.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="none">17:29:33.209909 IP (tos 0x10, ttl 16, id 0, offset 0, flags [none], proto UDP (17), length 328)
    192.168.91.254.67 &gt; 192.168.91.130.68: BOOTP/DHCP, Reply, length 300, xid 0x3de5472b, Flags [none]
          Your-IP 192.168.91.130
          Server-IP 192.168.91.254
          Client-Ethernet-Address 00:0c:29:85:26:07
          Vendor-rfc1048 Extensions
            Magic Cookie 0x63825363
            DHCP-Message Option 53, length 1: Offer
            Server-ID Option 54, length 4: 192.168.91.254
            Lease-Time Option 51, length 4: 1800
            Subnet-Mask Option 1, length 4: 255.255.255.0
            BR Option 28, length 4: 192.168.91.255
            Default-Gateway Option 3, length 4: 192.168.91.2
            Domain-Name Option 15, length 11: "localdomain"
            Domain-Name-Server Option 6, length 4: 192.168.91.2
            Netbios-Name-Server Option 44, length 4: 192.168.91.2</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is also possible to induce a system to perform the release or acquisition of DHCP configuration information by hand. For example, in Windows the following command will release the data acquired using DHCP:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">C:\&gt;</span><span class="w"> </span>ipconfig /release</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the following command will acquire it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">C:\&gt;</span><span class="w"> </span>ipconfig /renew</code></pre>
</div>
</div>
<div class="paragraph">
<p>In Linux, the following commands can be used to achieve the same results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">Linux#</span><span class="w"> </span>dhclient <span class="nt">-r</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to release a DHCP lease, and</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">Linux#</span><span class="w"> </span>dhclient</code></pre>
</div>
</div>
<div class="paragraph">
<p>to renew one.</p>
</div>
</div>
<div class="sect2">
<h3 id="the-dhcp-state-machine">1.5. The DHCP State Machine</h3>
<div class="paragraph">
<p>The DHCP protocol operates a state machine at the clients and servers. The states dictate which types of messages the protocol is expecting to process next.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip-dhcp-autoconfiguration/dhcp-client-states.png" alt="DHCP client state machine" width="45%" height="45%">
</div>
<div class="title">Figure 3. The DHCP client state machine. The boldface states and transitions are typical for a client first acquiring a leased address. The dashed line and INIT state are where the protocol begins.</div>
</div>
</div>
<div class="sect2">
<h3 id="dhcpv6">1.6. DHCPv6</h3>
<div class="paragraph">
<p>Although the IPv4 and IPv6 DHCP protocols achieve conceptually similar goals, their respective protocol designs and deployment options differ.</p>
</div>
<div class="paragraph">
<p>DHCPv6 [RFC3315] can be used in either a "<em>stateful</em>" mode, in which it works much like DHCPv4, or in a "<em>stateless</em>" mode in conjunction with stateless address autoconfiguration.</p>
</div>
<div class="paragraph">
<p>In the stateless mode, IPv6 clients are assumed to selfconfigure their IPv6 addresses but require additional information (e.g., DNS server address) obtained using DHCPv6. Another option exists for deriving the location of a DNS server using ICMPv6 Router Advertisement messages.</p>
</div>
<div class="sect3">
<h4 id="ipv6-address-lifecycle">1.6.1. IPv6 Address Lifecycle</h4>
<div class="paragraph">
<p>IPv6 hosts usually operate with <em>multiple addresses per interface</em>, and each address has a set of timers indicating how long and for what purposes the corresponding address can be used.</p>
</div>
<div class="paragraph">
<p>In IPv6, addresses are assigned with a <em>preferred lifetime</em> and <em>valid lifetime</em>.</p>
</div>
<div class="paragraph">
<p>These lifetimes are used to form timeouts that move an address from one state to another in an address’s state machine.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip-dhcp-autoconfiguration/ipv6-address-lifecycle.png" alt="IPv6 Address Lifecycle" width="55%" height="55%">
</div>
<div class="title">Figure 4. The lifecycle of an IPv6 address. Tentative addresses are used only for DAD until verified as unique. After that, they become preferred and can be used without restriction until an associated timeout changes their state to deprecated. Deprecated addresses are not to be used for initiating new connections and may not be used at all after the associated valid timeout expires.</div>
</div>
<div class="ulist">
<ul>
<li>
<p>An address is in the preferred state when it is available for general use and is available as either a source or destination IPv6 address.</p>
</li>
<li>
<p>A preferred address becomes deprecated when its preferred timeout occurs.</p>
<div class="paragraph">
<p>When it becomes deprecated, it may still be used for existing transport (e.g., TCP) connections but is not to be used for initiating new connections.</p>
</div>
</li>
<li>
<p>When an address is first selected for use, it enters a <em>tentative</em> or <em>optimistic state</em>.</p>
<div class="paragraph">
<p>When in the tentative state, it may be used only for the <em>IPv6 Neighbor Discovery protocol</em>. It is not used as a source or destination address for any other purposes. While in this state the address is being checked for duplication, to see if any other nodes on the same network are already using the address. The procedure for doing this is called <em>duplicate address detection (DAD)</em>.</p>
</div>
<div class="paragraph">
<p>An alternative to conventional DAD is called <em>optimistic DAD</em> [RFC4429], whereby a selected address is used for a limited set of purposes until DAD completes. Because an optimistic use of an address is really just a special set of rules for DAD, it is not a truly complete state itself. Optimistic addresses are treated as deprecated for most purposes. In particular, an address may be both optimistic and deprecated simultaneously, depending on the preferred and valid lifetimes.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="dhcpv6-message-format">1.6.2. DHCPv6 Message Format</h4>
<div class="paragraph">
<p>DHCPv6 messages are encapsulated as UDP/IPv6 datagrams, with client port <em>546</em> and server port <em>547</em>. Messages are sent using a <em>host&#8217;s link-scoped source address</em> to either relay agents or servers.</p>
</div>
<div class="paragraph">
<p>There are two message formats, one used directly between a client and a server, and another when a relay is used.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip-dhcp-autoconfiguration/dhcpv6-message-format.png" alt="DHCPv6 Message Format" width="75%" height="75%">
</div>
<div class="title">Figure 5. The basic DHCPv6 message format (left) and relay agent message format (right). Most interesting information in DHCPv6 is carried in options.</div>
</div>
<div class="paragraph">
<p>The format on the right is used between a DHCPv6 relay agent and a DHCPv6 server.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <em>Link Address</em> field gives the global IPv6 address used by the server to identify the link on which the client is located.</p>
</li>
<li>
<p>The <em>Peer Address</em> field contains the address of the relay agent or client from which the message to be relayed was received.</p>
</li>
<li>
<p>Note that relaying may be chained, so a relay may be relaying a message received from another relay.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The message type for messages in the format on the left include typical DHCPstyle messages (REQUEST, REPLY, etc.), whereas the message types for messages in the format on the right include RELAY-FORW and RELAY-REPL, to indicate a message forwarded from a relay or destined to a relay, respectively. The Options field for the format on the right always includes a Relay Message option, which includes the complete message being forwarded by the relay. Other options may also be included.</p>
</div>
<div class="paragraph">
<p>One of the differences between DHCPv4 and DHCPv6 is how DHCPv6 uses IPv6 multicast addressing.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Clients send requests to the All DHCP Relay Agents and Servers multicast address (<em>ff02::1:2</em>).</p>
</li>
<li>
<p>Source addresses are of link-local scope.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In IPv6, there is no legacy BOOTP message format. The message semantics, however, are similar.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. DHCPv6 message types, values, and defining standards. The approximately equivalent message types for DHCPv4 are given to the right.</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">DHCPv6 Message</th>
<th class="tableblock halign-left valign-top">DHCPv6 Value</th>
<th class="tableblock halign-left valign-top">Reference</th>
<th class="tableblock halign-left valign-top">DHCPv4 Message</th>
<th class="tableblock halign-left valign-top">Reference</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SOLICIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3315]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DISCOVER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2132]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ADVERTISE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3315]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OFFER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2132]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REQUEST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3315]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REQUEST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2132]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CONFIRM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3315]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REQUEST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2132]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RENEW</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3315]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REQUEST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2132]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REBIND</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3315]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DISCOVER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2132]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">REPLY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3315]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ACK/NAK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2132]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RELEASE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3315]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RELEASE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2132]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DECLINE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3315]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DECLINE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2132]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RECONFIGURE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3315]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FORCERENEW</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3203]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INFORMATION-REQUEST</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3315]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INFORM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC2132]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RELAY-FORW</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3315]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RELAY-REPL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">13</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC3315]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LEASEQUERY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC5007]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LEASEQUERY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4388]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LEASEQUERY-REPLY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC5007]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LEASE{UNASSIGNED,UNKNOWN,ACTIVE}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC4388]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LEASEQUERY-DONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">16</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC5460]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LEASEQUERYDONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[ID4LQ]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LEASEQUERY-DATA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">17</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[RFC5460]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BULKLEASEQUERY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">[ID4LQ]</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In DHCPv6, most interesting information, including addresses, lease times, location of services, and client and server identifiers, is carried in options. Two of the more important concepts used with these options are called the <em>Identity Association (IA)</em> and the <em>DHCP Unique Identifier (DUID)</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="identity-association-ia">1.6.3. Identity Association (IA)</h4>
<div class="paragraph">
<p>An <strong>Identity Association (IA)</strong> is an identifier used between a DHCP client and server to refer to a collection of addresses.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each IA comprises an <em>IA identifier (IAID)</em> and associated configuration information.</p>
</li>
<li>
<p>Each client interface that requests a DHCPv6-assigned address requires at least one IA.</p>
</li>
<li>
<p>Each IA can be associated with only a single interface.</p>
</li>
<li>
<p>The client chooses the IAID to uniquely identify each IA, and this value is then shared with the server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The configuration information associated with an IA includes one or more addresses and associated lease information (T1, T2, and total lease duration values).</p>
</div>
<div class="paragraph">
<p>Each address in an IA has both a preferred and a valid lifetime [RFC4862], which define the address&#8217;s lifecycle.</p>
</div>
<div class="paragraph">
<p>The types of addresses requested may be regular addresses or <em>temporary addresses</em> [RFC4941].</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Temporary addresses are derived in part from random numbers to help improve privacy by frustrating the tracking of IPv6 hosts based on IPv6 addresses.</p>
</li>
<li>
<p>Temporary addresses are ordinarily assigned at the same time nontemporary addresses are assigned but are regenerated using a different random number more frequently.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When responding to a request, a server assigns one or more addresses to a client&#8217;s IA based on a set of <em>address assignment policies</em> determined by the server&#8217;s administrator.</p>
</div>
<div class="paragraph">
<p>Generally, such policies depend on the link on which the request arrived, standard information about the client, and other information supplied by the client in DHCP options.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip-dhcp-autoconfiguration/dhcpv6-ia-format.png" alt="DHCPv6 IA format" width="75%" height="75%">
</div>
<div class="title">Figure 6. The format for a DHCPv6 IA for nontemporary addresses (left) and temporary addresses (right). Each option may include additional options describing particular IPv6 addresses and corresponding leases.</div>
</div>
</div>
<div class="sect3">
<h4 id="dhcp-unique-identifier-duid">1.6.4. DHCP Unique Identifier (DUID)</h4>
<div class="paragraph">
<p>A <strong>DHCP Unique Identifier (DUID)</strong> identifies a single DHCPv6 client or server and is designed to be persistent over time.</p>
</div>
<div class="paragraph">
<p>It is used by servers to identify clients for the selection of addresses (as part of IAs) and configuration information, and by clients to identify the server in which they are interested.</p>
</div>
<div class="paragraph">
<p>DUIDs are variable in length and are treated as opaque values by both clients and servers for most purposes.</p>
</div>
<div class="paragraph">
<p>DUIDs are supposed to be globally unique yet easy to generate.</p>
</div>
<div class="paragraph">
<p>To satisfy these concerns simultaneously, [RFC3315] defines three different types of possible DUIDs but also mentions that these are not the only three types that might ever be created. The three types of DUIDs are as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>DUID-LLT: a DUID based on link-layer address plus time</p>
</li>
<li>
<p>DUID-EN: a DUID based on enterprise number and vendor assignment</p>
</li>
<li>
<p>DUID-LL: a DUID based on link-layer address only</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="protocol-operation">1.6.5. Protocol Operation</h4>
<div class="paragraph">
<p>The DHCPv6 protocol operates much like its DHCPv4 counterpart.</p>
</div>
<div class="paragraph">
<p>Whether or not a client initiates the use of DHCP is dependent on configuration options carried in an <em>ICMPv6 Router Advertisement</em> message the host receives.</p>
</div>
<div class="paragraph">
<p>Router advertisements include two important bit fields.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <em>M</em> field is the <em>Managed Address Configuration</em> flag and indicates that IPv6 addresses can be obtained using DHCPv6.</p>
</li>
<li>
<p>The <em>O</em> field is the <em>Other Configuration</em> flag and indicates that information other than IPv6 addresses is available using DHCPv6.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both fields, along with several others, are specified in [RFC5175].</p>
</div>
<div class="paragraph">
<p>Any combination of the <em>M</em> and <em>O</em> bit fields is possible, although having <em>M</em> on and <em>O</em> off is probably the least useful combination.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If both are off, DHCPv6 is not used, and address assignment takes place using stateless address autoconfiguration.</p>
</li>
<li>
<p>Having <em>M</em> off and <em>O</em> on indicates that clients should use stateless DHCPv6 and obtain their addresses using stateless address autoconfiguration.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip-dhcp-autoconfiguration/dhcpv6-operations.png" alt="DHCPv6 Operation" width="55%" height="55%">
</div>
<div class="title">Figure 7. Basic operation of DHCPv6. A client determines whether or not to use DHCPv6 from information carried in ICMPv6 router advertisements. If used, DHCPv6 operations are similar to those in DHCPv4 but differ significantly in the details.</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Typically, a client starting out first determines what link-local address to use and performs an <em>ICMPv6 Router Discovery</em> operation to determine if there is a router on the attached network.</p>
</li>
<li>
<p>A <em>router advertisement</em> includes the <em>M</em> and <em>O</em> bit fields mentioned previously.</p>
</li>
<li>
<p>If DHCPv6 is in use, at least the <em>M</em> bit field is set and the client multicasts the <em>DHCPSOLICIT</em> message to find DHCPv6 servers.</p>
</li>
<li>
<p>A response comes in the form of one or more <em>DHCPADVERTISE</em> messages, indicating the presence of at least one DHCPv6 server.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These messages constitute two of the so-called <em>four-message exchange</em> operations of DHCPv6.</p>
</div>
<div class="paragraph">
<p>In cases where the location of a DHCPv6 server is already known or an address need not be allocated (e.g., stateless DHCPv6 or the Rapid Commit option is being used), the four-message exchange can be shortened to become a two-message exchange, in which case only the REQUEST and REPLY messages are used.</p>
</div>
<div class="paragraph">
<p>A DHCPv6 server commits a binding formed from the combination of a DUID, IA type (temporary, nontemporary, or prefix), and IAID. The IAID is a 32-bit number chosen by the client.</p>
</div>
<div class="paragraph">
<p>Each binding can have one or more leases, and one or more bindings can be manipulated using a single DHCPv6 transaction.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DAD for the client system’s link-local address is a <em>Neighbor Solicitation</em> for its own IPv6 address.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">00:0c:29:85:26:11 &gt;</span><span class="w"> </span>33:33:ff:85:26:11, ethertype IPv6 <span class="o">(</span>0x86dd<span class="o">)</span>, length 86: <span class="o">(</span>hlim 255, next-header ICMPv6 <span class="o">(</span>58<span class="o">)</span> payload length: 32<span class="o">)</span> :: <span class="o">&gt;</span> ff02::1:ff85:2611: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, neighbor solicitation, length 32, <span class="nb">who </span>has fe80::20c:29ff:fe85:2611
<span class="go">      unknown option (14), length 8 (1):
        0x0000:  93d1 208a 5c73</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The packet is sent to the corresponding solicited-node address <em>ff02::1:ff85:2611</em>. It optimistically assumes that this address is not otherwise in use on the link, so it continues on immediately with a <em>Router Solicitation (RS)</em>.</p>
</div>
</li>
<li>
<p>The <em>Router Solicitation</em> induces a nearby router to provide a <em>Router Advertisement</em>.</p>
<div class="paragraph">
<p>The solicitation message is sent to the <em>All Routers address</em> (<em>ff02::2</em>). It induces each router on the network to respond with a <em>Router Advertisement (RA)</em>, which carries the important <em>M</em> and <em>O</em> bits the client requires to determine what to do next.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">00:0c:29:85:26:11 &gt;</span><span class="w"> </span>33:33:00:00:00:02, ethertype IPv6 <span class="o">(</span>0x86dd<span class="o">)</span>, length 70: <span class="o">(</span>hlim 255, next-header ICMPv6 <span class="o">(</span>58<span class="o">)</span> payload length: 16<span class="o">)</span> fe80::20c:29ff:fe85:2611 <span class="o">&gt;</span> ff02::2: <span class="o">[</span>icmp6 <span class="nb">sum </span>ok] ICMP6, router solicitation, length 16
<span class="go">      source link-address option (1), length 8 (1): 00:0c:29:85:26:11
        0x0000:  000c 2985 2611</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="rapid-commit">1.7. Rapid Commit</h3>
<div class="paragraph">
<p>The DHCP <em>Rapid Commit</em> option [RFC4039] allows a DHCP server to respond to the DHCPDISCOVER message with a DHCPACK, effectively skipping the DHCPREQUEST message and ultimately using a two-message exchange instead of a four-message exchange.</p>
</div>
<div class="paragraph">
<p>The motivation for this option is to quickly configure hosts that may change their point of network attachment frequently (i.e., mobile hosts).</p>
</div>
<div class="paragraph">
<p>When only a single DHCP server is available and addresses are plentiful, this option should be of no significant concern.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="stateless-address-autoconfiguration-slaac">2. Stateless Address Autoconfiguration (SLAAC)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While most routers have their addresses configured manually, hosts can be assigned addresses manually, using an assignment protocol like DHCP, or automatically using some sort of algorithm.</p>
</div>
<div class="paragraph">
<p>There are two forms of automatic assignment, depending on what type of address is being formed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For addresses that are to be used only on a single link (link-local addresses), a host need only find some appropriate address not already in use on the link.</p>
</li>
<li>
<p>For addresses that are to be used for global connectivity, however, some portion of the address must generally be managed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are mechanisms in both IPv4 and IPv6 for link-local address autoconfiguration, whereby a host determines its address(es) largely without help. This is called <em>stateless address autoconfiguration (SLAAC)</em>.</p>
</div>
<div class="sect2">
<h3 id="dynamic-configuration-of-ipv4-link-local-addresses">2.1. Dynamic Configuration of IPv4 Link-Local Addresses</h3>
<div class="paragraph">
<p>In cases where a host without a manually configured address attaches to a network lacking a DHCP server, IP-based communication is unable to take place unless the host somehow generates an IP address to use.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>[RFC3927] describes a mechanism whereby a host can automatically generate its own IPv4 address from the link-local range <em>169.254.1.1</em> through <em>169.254.254.254</em> using the 16-bit subnet mask <em>255.255.0.0</em> (see [RFC5735]).</p>
<div class="paragraph">
<p>This method is known as dynamic link-local address configuration or <em>Automatic Private IP Addressing (APIPA)</em>.</p>
</div>
</li>
<li>
<p>In essence, a host selects a random address in the range to use and checks to see if that address is already in use by some other system on the subnetwork.</p>
<div class="paragraph">
<p>This check is implemented using <em>IPv4 ACD</em>.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="ipv6-slaac-for-link-local-addresses">2.2. IPv6 SLAAC for Link-Local Addresses</h3>
<div class="paragraph">
<p>The goal of IPv6 SLAAC is to allow nodes to automatically (and autonomously) self-assign link-local IPv6 addresses.</p>
</div>
<div class="paragraph">
<p>IPv6 SLAAC is described in [RFC4862]. It involves three major steps: obtaining a link-local address, obtaining a global address using stateless autoconfiguration, and detecting whether the link-local address is already in use on the link.</p>
</div>
<div class="paragraph">
<p>Stateless autoconfiguration can be used without routers, in which case only link-local addresses are assigned.</p>
</div>
<div class="paragraph">
<p>When routers are present, a global address is formed using a combination of the prefix advertised by a router and locally generated information.</p>
</div>
<div class="paragraph">
<p>SLAAC can also be used in conjunction with DHCPv6 (or manual address assignment) to allow a host to obtain information in addition to its address (called <em>stateless</em> DHCPv6).</p>
</div>
<div class="paragraph">
<p>Hosts that perform SLAAC can be used on the same network as those configured using stateful or stateless DHCPv6.</p>
</div>
<div class="paragraph">
<p>Generally, stateful DHCPv6 is used when finer control is required in assigning address to hosts, but it is expected that stateless DHCPv6 in combination with SLAAC will be the most common deployment option.</p>
</div>
<div class="paragraph">
<p>In IPv6, tentative (or optimistic) link-local addresses are selected using procedures specified in [RFC4291] and [RFC4941]. They apply only to multicast-capable networks and are assigned infinite preferred and valid lifetimes once established.</p>
</div>
<div class="paragraph">
<p>To form the numeric address, a unique number is appended to the well-known link-local prefix <em>fe80::0</em> (of appropriate length). This is accomplished by setting the right-most <em>N</em> bits of the address to be equal to the (N-bit-long) number, the left-most bits equal to the 10-bit link-local prefix <em>1111111010</em>, and the rest to <em>0</em>. The resulting address is placed into the tentative (or optimistic) state and checked for duplicates.</p>
</div>
</div>
<div class="sect2">
<h3 id="ipv6-duplicate-address-detection-dad">2.3. IPv6 Duplicate Address Detection (DAD)</h3>
<div class="paragraph">
<p>IPv6 DAD uses ICMPv6 <em>Neighbor Solicitation</em> and <em>Neighbor Advertisement</em> messages to determine if a particular (tentative or optimistic) IPv6 address is already in use on the attached link.</p>
</div>
<div class="paragraph">
<p>If a duplicate address is discovered, the procedure causes the tentative address to not be used.</p>
</div>
<div class="paragraph">
<p>If DAD succeeds, the tentative address transitions to the preferred state and can be used without restriction.</p>
</div>
<div class="paragraph">
<p>DAD is performed as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A node first joins the <em>All Nodes multicast address</em> and the <em>Solicited-Node multicast address</em> of the tentative address.</p>
</li>
<li>
<p>To check for use of an address duplicate, a node sends one or more ICMPv6 <em>Neighbor Solicitation</em> messages.</p>
<div class="paragraph">
<p>The source and destination IPv6 addresses of these messages are the unspecified address and <em>Solicited-Node address</em> of the target address being checked, respectively.</p>
</div>
<div class="paragraph">
<p>The <em>Target Address</em> field is set to the address being checked (the tentative address).</p>
</div>
</li>
<li>
<p>If a <em>Neighbor Advertisement</em> message is received in response, DAD has failed, and the address being checked is abandoned.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>As a consequence of joining multicast groups, <em>MLD</em> messages are sent, but their transmission is delayed by a random interval according to [RFC4862] to avoid congesting the network when many nodes simultaneously join the <em>All Hosts group</em> (e.g., after a restoration of power). For DAD, these MLD messages are used to inform MLD-snooping switches to forward multicast traffic as necessary.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When an address has not yet successfully completed DAD, any received neighbor solicitations for it are treated in a special way, as this is indicative of some other host&#8217;s intention to use the same address. If such messages are received, they are dropped, the current tentative address is abandoned, and DAD fails.</p>
</div>
<div class="paragraph">
<p>If DAD fails, by receiving a similar neighbor solicitation from another node or a neighbor advertisement for the target address, the address is not assigned to an interface and does not become a preferred address. If the address is a link-local address being configured based on an interface identifier derived from a local MAC address, it is unlikely that the same procedure will ultimately produce a nonconflicting address, so the use of this address is abandoned and administrator input is required. If the address is based on a different form of interface identifier, IPv6 operations may be retried using another address based on an alternative tentative address.</p>
</div>
</div>
<div class="sect2">
<h3 id="ipv6-slaac-for-global-addresses">2.4. IPv6 SLAAC for Global Addresses</h3>
<div class="paragraph">
<p>Once a node has acquired a link-local address, it is likely to require one or more global addresses as well.</p>
</div>
<div class="paragraph">
<p>Global addresses are formed using a process similar to that for link-local SLAAC but using a prefix provided by a router.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Such prefixes are carried in the <em>Prefix</em> option of a router advertisement, and a flag indicates whether the prefix should be used in forming global addresses with SLAAC.</p>
</li>
<li>
<p>If so, the prefix is combined with an interface identifier (e.g., the same one used in forming a link-local address if the privacy extension is not being used) to form a global address.</p>
</li>
<li>
<p>The preferred and valid lifetimes of such addresses are also determined by information present in the <em>Prefix</em> option.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ppp-over-ethernet-pppoe">3. PPP over Ethernet (PPPoE)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For most LANs and some WAN connections, DHCP provides the most common method for configuring client systems.</p>
</div>
<div class="paragraph">
<p>For WAN connections such as DSL, another method based on PPP is often used instead.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This method involves carrying PPP on Ethernet and is called <em>PPP over Ethernet</em> (<em>PPPoE</em>).</p>
</li>
<li>
<p>PPPoE is used in cases where the WAN connection device (e.g., DSL modem) acts as a switch or bridge instead of a router.</p>
</li>
<li>
<p>PPP is preferred as a basis for establishing connectivity by some ISPs because it may provide finer-grain configuration control and audit logs than other configuration options such as DHCP.</p>
</li>
<li>
<p>To provide Internet connectivity, some device such as a user&#8217;s PC must implement the IP routing and addressing functions.</p>
<div class="imageblock">
<div class="content">
<img src="/assets/tcp-ip-dhcp-autoconfiguration/pppoe-dsl-home-lan.png" alt="PPPoE DSL" width="45%" height="45%">
</div>
<div class="title">Figure 8. A simplified view of DSL service using PPPoE as provided to a customer. The home PC implements the PPPoE protocol and authenticates the subscriber with the ISP. It may also act as a router, DHCP server, DNS server, and/or NAT device for the home LAN.</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>DSL provides a point-to-point digital link that can operate simultaneously with a conventional analog telephone line (called <em>plain old telephone service</em> or <em>POTS</em>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This simultaneous use of the customer&#8217;s physical phone wires is accomplished using <em>frequency division multiplexing</em>—the DSL information is carried on higher frequencies than POTS.</p>
</li>
<li>
<p>A <em>filter</em> is required when attaching conventional telephone handsets to avoid interference from the higher DSL frequencies.</p>
</li>
<li>
<p>The DSL modem effectively provides a bridged service to a PPP port on the ISP&#8217;s <em>access concentrator</em> (<em>AC</em>), which interconnects the customer&#8217;s modem line and the ISP&#8217;s networking equipment.</p>
</li>
<li>
<p>The modem and AC also support the PPPoE protocol, which the user has elected in this example to configure on a home PC attached to the DSL modem using a point-to-point Ethernet network (i.e., an Ethernet LAN using only a single cable).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references">References</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="tcp_ip_vol_1"></a>[1] Kevin Fall, W. Stevens <em>TCP/IP Illustrated: The Protocols, Volume 1</em>. 2nd edition, Addison-Wesley Professional, 2011</p>
</li>
</ul>
</div>
</div>
</div>
  </div>

  <ul class="post-navigation">
    <li>
      
      <a href="/2022/11/24/oracle-database-architecture/">&laquo; Oracle Database Architecture</a>
      
    </li>
    <li>
      
      <a href="/2022/11/30/tcp-ip-internet-control-message-protocol/">TCP/IP: Internet Control Message Protocol &raquo;</a>
      
    </li>
  </ul>
</article>

      </div>
    </div>

    <footer class="site-footer">
  <div class="license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details open>
    <summary>Extral Links</summary>
    <div>
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>


<!-- https://github.com/bryanbraun/anchorjs -->
<script src="/js/anchor.min.js"></script>
<script>
  anchors.add();
  anchors.remove(".site-title");
</script>




  </body>

</html>

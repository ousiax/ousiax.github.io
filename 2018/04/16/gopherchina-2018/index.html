<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bing WebMaster -->
  <meta name="msvalidate.01" content="AB2FFF876C37F59D9121882CC8395DE5" />

  <title>GopherChina 2018</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://blog.codefarm.me/2018/04/16/gopherchina-2018/">
  <link rel="alternate" type="application/rss+xml" title="CODE FARM" href="https://blog.codefarm.me/feed.xml">

  <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->
<script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>

  
<!-- Google Analytics Website tracking -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83971182-1', 'auto');
  ga('send', 'pageview');

</script>


  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SN88FJ18E5');
</script>



</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
    <h2 class="site-title">
      <a class="site-title" href="/">CODE FARM</a>
    </h2>

     <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
        <div class="trigger">
            <ul>
                <li><a href="/">home</a>
                <li><a href="/category">category</a>
                <li><a href="/tag">tag</a>
                <li><a href="/archive">archive</a>
                <li><a href="/about">about</a>
                <li><a href="https://resume.github.io/?qqbuby" target="_blank">R&eacute;sum&eacute;</a>
            </ul>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">GopherChina 2018</h1>
    
    
    <p class="post-meta"><time datetime="2018-04-16T11:03:16+08:00" itemprop="datePublished">Apr 16, 2018</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <ul id="markdown-toc">
  <li><a href="#11-基于go构建滴滴核心业务平台的实践" id="markdown-toc-11-基于go构建滴滴核心业务平台的实践">1.1 基于Go构建滴滴核心业务平台的实践</a></li>
  <li><a href="#12-go在grab地理服务中的实践" id="markdown-toc-12-go在grab地理服务中的实践">1.2 Go在Grab地理服务中的实践</a></li>
  <li><a href="#13-rethinking-errors-for-go-2" id="markdown-toc-13-rethinking-errors-for-go-2">1.3 Rethinking Errors for Go 2</a></li>
  <li><a href="#14-go在区块链的发展和演进" id="markdown-toc-14-go在区块链的发展和演进">1.4 Go在区块链的发展和演进</a></li>
  <li><a href="#15-badger_-fast-key-value-db-in-go" id="markdown-toc-15-badger_-fast-key-value-db-in-go">1.5 Badger_ Fast Key-Value DB in Go</a></li>
  <li><a href="#16-golang在阿里巴巴调度系统sigma中的实践" id="markdown-toc-16-golang在阿里巴巴调度系统sigma中的实践">1.6 Golang在阿里巴巴调度系统Sigma中的实践</a></li>
  <li><a href="#17-罗辑思维go语言微服务改造实践" id="markdown-toc-17-罗辑思维go语言微服务改造实践">1.7 罗辑思维Go语言微服务改造实践</a></li>
  <li><a href="#18-golang打造下一代互联网-ipfs全解析" id="markdown-toc-18-golang打造下一代互联网-ipfs全解析">1.8 Golang打造下一代互联网-IPFS全解析</a></li>
  <li><a href="#21-composition-in-go" id="markdown-toc-21-composition-in-go">2.1 Composition In Go</a></li>
  <li><a href="#23-bazel-build-go" id="markdown-toc-23-bazel-build-go">2.3 Bazel build Go</a></li>
  <li><a href="#24-基于go-ethereum构建dpos机制下的区块链" id="markdown-toc-24-基于go-ethereum构建dpos机制下的区块链">2.4 基于Go-Ethereum构建DPOS机制下的区块链</a></li>
  <li><a href="#25-深入cgo编程" id="markdown-toc-25-深入cgo编程">2.5 深入CGO编程</a></li>
  <li><a href="#26-go与虚拟化容器-runvkata" id="markdown-toc-26-go与虚拟化容器-runvkata">2.6 Go与虚拟化容器 runV/Kata</a></li>
  <li><a href="#27-go-toolchain-internals-and-implementation-based-on-arm64" id="markdown-toc-27-go-toolchain-internals-and-implementation-based-on-arm64">2.7 Go toolchain internals and implementation based on arm64</a></li>
  <li><a href="#28-go在探探后端的工程实践" id="markdown-toc-28-go在探探后端的工程实践">2.8 Go在探探后端的工程实践</a></li>
</ul>

<hr />

<h3 id="11-基于go构建滴滴核心业务平台的实践">1.1 基于Go构建滴滴核心业务平台的实践</h3>

<p># 服务治理</p>

<ul>
  <li>异常定位
    <ul>
      <li>日志格式混乱
        <ul>
          <li>大量 adaptor</li>
          <li>人工配置与分析</li>
          <li>处理性能低，资源消耗大</li>
        </ul>
      </li>
      <li>服务串联困难
        <ul>
          <li>上下游定位困难</li>
          <li>跨业务定位效率低</li>
          <li>缺乏服务调用拓扑关系</li>
        </ul>
      </li>
      <li>链路难以分析
        <ul>
          <li>日志孤立</li>
          <li>性能要素缺失</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>链路优化
    <ul>
      <li>全链路压测</li>
    </ul>
  </li>
  <li>服务迁移
    <ul>
      <li>接口一致性兼容/代理/切流(旁路引流/流量切换/线上观察)</li>
    </ul>
  </li>
</ul>

<hr />

<ul>
  <li>日志规范化, 服务日志规范/通信接口规范/日志组件
    <ul>
      <li>数据结构化
        <ul>
          <li>DLTAG</li>
          <li>Key/Value</li>
        </ul>
      </li>
      <li>请求串联
        <ul>
          <li>TraceId</li>
        </ul>
      </li>
      <li>链路可视化
        <ul>
          <li>SpanId</li>
        </ul>
      </li>
      <li>处理统一化, 处理系统/日志统一处理
        <ul>
          <li>采集/计算/存储</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<hr />

<p># GC</p>
<ul>
  <li>对象数量过多，GC 三色算法耗费较多 CPU
    <ul>
      <li>减少对象分配？用值类型代替对象类型？</li>
      <li>多用栈，少用堆？Goroutine 拷贝栈扩展？</li>
    </ul>
  </li>
</ul>

<h3 id="12-go在grab地理服务中的实践">1.2 Go在Grab地理服务中的实践</h3>

<p># Nearby Service</p>
<ul>
  <li>Node.js + PostGIS
    <ul>
      <li>R-Tree
        <ul>
          <li>空间数据存储 一种平衡树</li>
          <li>高频写 触发频繁再平衡</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Golang + Geohash + Redis
    <ul>
      <li>Geohash
        <ul>
          <li>一维字符串表示二维坐标数据(wtw6j89guz9y -&gt; [31.292494, 121.533371])</li>
          <li>具有相同前缀的 Geohash 字符串地理位置相近</li>
          <li>基于 SortedSet 做 Range 查询</li>
        </ul>
      </li>
      <li>CPU/IO 非常高，内存非常低</li>
      <li>不能横向(水平)扩展</li>
    </ul>
  </li>
  <li>Sharding 扩展
    <ul>
      <li>司机空间索引 -&gt; Shard -&gt; Node</li>
      <li>空间索引
        <ul>
          <li>地球平面网格划分 Grid (Shard)</li>
          <li>分层Grid              (Cell)</li>
          <li>Shard -&gt; Cell (0,1,2,…N) / Cell -&gt; (LRU Queue)</li>
        </ul>
      </li>
      <li>一致性哈希
        <ul>
          <li>Ketema algorithm</li>
          <li>Replica supported</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>分布式
    <ul>
      <li>最终一致性 AP</li>
      <li>Serf
        <ul>
          <li>基于 Gossip 的 Membership</li>
          <li>故障检测</li>
        </ul>
      </li>
      <li>SWIM
        <ul>
          <li>Scable Weakly-consistent Infection-style process group Memmbership protocol
            <ul>
              <li>可扩展性一致性感染型进程组成员协议</li>
              <li>Scable
                <ul>
                  <li>随着结点的增多 故障检测耗时不会大幅度增加
                    <ul>
                      <li>如 heart-beating 机制 消息通信呈指数级</li>
                    </ul>
                  </li>
                </ul>
              </li>
              <li>Weakly
                <ul>
                  <li>在某一时刻不同的结点看到不同的系统状态</li>
                  <li>最终会收敛到相同的状态</li>
                </ul>
              </li>
              <li>Infection-style
                <ul>
                  <li>Gossip</li>
                  <li>每个结点持有部分结点信息 每个结点与其子结点交换信息</li>
                  <li>最终所有结点通过‘八卦’别人的信息获取全局信息</li>
                </ul>
              </li>
              <li>Membership
                <ul>
                  <li>找到其他网络结点</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="13-rethinking-errors-for-go-2">1.3 Rethinking Errors for Go 2</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"log"</span>
        <span class="s">"os"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s">"let.go"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"oops: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">defer</span> <span class="n">r</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
<span class="p">}</span>
<span class="c">// Output</span>
<span class="c">// 2018/04/16 14:19:51 oops: open let.go: no such file or directory</span>
</code></pre></div></div>

<p># Go 2 Draft</p>
<ul>
  <li>handle err { … }</li>
  <li>defer err { … }</li>
  <li>try <expr></expr></li>
</ul>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">writeToGS</span><span class="p">(</span><span class="n">c</span> <span class="n">net</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">bkt</span><span class="p">,</span> <span class="n">dst</span> <span class="kt">string</span><span class="p">,</span> <span class="n">r</span> <span class="n">io</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span> <span class="p">(</span><span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">w</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bkt</span><span class="p">)</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="o">.</span><span class="n">NewWriter</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">errPanicking</span>
        <span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                        <span class="n">_</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">CloseWithError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">err</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">Close</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"oops: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
                <span class="p">}</span>
        <span class="p">}()</span>
        <span class="k">if</span> <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"oops: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">var</span> <span class="n">errPanicking</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"panicking"</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">func</span> <span class="n">writeToGS</span><span class="p">(</span><span class="n">c</span> <span class="n">context</span><span class="p">,</span> <span class="n">bkt</span><span class="p">,</span> <span class="n">dst</span> <span class="kt">string</span><span class="p">,</span> <span class="n">r</span> <span class="n">io</span><span class="o">.</span><span class="n">Reader</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="n">handle</span> <span class="n">err</span> <span class="p">{</span> <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">Wrap</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">w</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">bkt</span><span class="p">)</span><span class="o">.</span><span class="n">Object</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span><span class="o">.</span><span class="n">NewWriter</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">defer</span> <span class="n">err</span> <span class="p">{</span> <span class="n">try</span> <span class="n">w</span><span class="o">.</span><span class="n">CloseWithError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">try</span> <span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="14-go在区块链的发展和演进">1.4 Go在区块链的发展和演进</h3>
<p># 区块链是什么</p>
<ul>
  <li>去中心化系统 (多中心化?)</li>
  <li>数字化账本</li>
  <li>不可篡改</li>
  <li>确定性的可复制状态机</li>
</ul>

<p># 区块链的特点</p>
<ul>
  <li>去中心化、弱中心化</li>
  <li>弱信任、对等的写入权限的数据库</li>
  <li>共识信任机制，信任来自规则，非第三方</li>
  <li>不可篡改</li>
  <li>加密安全、强规则</li>
  <li>可编程</li>
  <li>匿名性</li>
  <li>跨平台</li>
</ul>

<p># 区块链开发的特点</p>
<ul>
  <li>分布式
    <ul>
      <li>网络编程
        <ul>
          <li>多线程</li>
        </ul>
      </li>
      <li>使用大量的算法和数据结构</li>
      <li>强规则
        <ul>
          <li>密码学</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p># Go 的优势</p>
<ul>
  <li>部署简单，直接编译成机器码</li>
  <li>语言级并发支持</li>
  <li>性能高</li>
  <li>良好的 C 语言的支持</li>
  <li>自动垃圾回收</li>
  <li>Go 是工程上设计良好的语言，比如代码风格一致，自带工具链</li>
  <li>代码简洁</li>
  <li>静态类型</li>
  <li>丰富的标准库</li>
  <li>跨平台编译</li>
</ul>

<p># Go 思维</p>
<ul>
  <li>全面简单
    <ul>
      <li>简洁</li>
      <li>类型推断</li>
      <li>GC</li>
      <li>25个 keyword</li>
      <li>package</li>
    </ul>
  </li>
  <li>正交组合
    <ul>
      <li>interface 与其实现之间无显示关联</li>
      <li>通过组合架构让程序静态结构</li>
      <li>垂直组合 (类型组合, type embedding)</li>
      <li>水平组合, 通过 interface 进行组合</li>
    </ul>
  </li>
  <li>偏好并发
    <ul>
      <li>goroutines</li>
      <li>select</li>
      <li>channels
        <ul>
          <li>模块之间解耦</li>
          <li>并发锁</li>
          <li>消息通信</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p># 共识协议</p>
<ul>
  <li>POW / POS / DPOS / DBFT / DAG / …</li>
</ul>

<h3 id="15-badger_-fast-key-value-db-in-go">1.5 Badger_ Fast Key-Value DB in Go</h3>

<ul>
  <li>Cgo is not Go</li>
  <li>RocksDB / BoltDB</li>
  <li>LSM trees / B+ trees</li>
</ul>

<h3 id="16-golang在阿里巴巴调度系统sigma中的实践">1.6 Golang在阿里巴巴调度系统Sigma中的实践</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="s">"fmt"</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">m</span> <span class="o">:=</span> <span class="k">map</span><span class="p">[</span><span class="kt">int</span><span class="p">][]</span><span class="kt">byte</span><span class="p">{</span>
                <span class="m">0xc4200761c0</span><span class="o">:</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="m">228</span><span class="p">,</span> <span class="m">189</span><span class="p">,</span> <span class="m">160</span><span class="p">,</span> <span class="m">229</span><span class="p">,</span> <span class="m">165</span><span class="p">,</span> <span class="m">189</span><span class="p">,</span> <span class="m">229</span><span class="p">,</span> <span class="m">147</span><span class="p">,</span> <span class="m">135</span><span class="p">},</span>
                <span class="m">0xc4200761c8</span><span class="o">:</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="m">230</span><span class="p">,</span> <span class="m">189</span><span class="p">,</span> <span class="m">152</span><span class="p">,</span> <span class="m">233</span><span class="p">,</span> <span class="m">147</span><span class="p">,</span> <span class="m">129</span><span class="p">,</span> <span class="m">230</span><span class="p">,</span> <span class="m">159</span><span class="p">,</span> <span class="m">177</span><span class="p">},</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">m</span> <span class="p">{</span>
                <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%p -&gt; %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="c">// Output 1</span>
<span class="c">// 0xc420090020 -&gt; 潘铁柱</span>
<span class="c">// 0xc420090020 -&gt; 你好哇</span>
<span class="c">// </span>
<span class="c">// Output 2</span>
<span class="c">// 0xc420092020 -&gt; 你好哇</span>
<span class="c">// 0xc420092020 -&gt; 潘铁柱</span>
</code></pre></div></div>

<h3 id="17-罗辑思维go语言微服务改造实践">1.7 罗辑思维Go语言微服务改造实践</h3>

<h3 id="18-golang打造下一代互联网-ipfs全解析">1.8 Golang打造下一代互联网-IPFS全解析</h3>

<ul>
  <li><a href="https://medium.com/@mycoralhealth/code-your-own-blockchain-in-less-than-200-lines-of-go-e296282bcffc">Code your own blockchain in less than 200 lines of Go!</a></li>
  <li><a href="https://medium.com/@mycoralhealth/learn-to-securely-share-files-on-the-blockchain-with-ipfs-219ee47df54c">Learn to securely share files on the blockchain with IPFS!</a></li>
</ul>

<h3 id="21-composition-in-go">2.1 Composition In Go</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Reader is the interface that wraps the basic Read method.</span>
<span class="k">type</span> <span class="n">Reader</span> <span class="k">interface</span> <span class="p">{</span>
        <span class="n">Read</span><span class="p">(</span><span class="n">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="kt">int</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Writer is the interface that wraps the basic Write method.</span>
<span class="k">type</span> <span class="n">Writer</span> <span class="k">interface</span> <span class="p">{</span>
        <span class="n">Write</span><span class="p">(</span><span class="n">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="n">n</span> <span class="kt">int</span><span class="p">,</span> <span class="n">err</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// ReadWriter is the interface that groups the basic Read and Write methods.</span>
<span class="k">type</span> <span class="n">ReadWriter</span> <span class="k">interface</span> <span class="p">{</span>
        <span class="n">Reader</span>
        <span class="n">Writer</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="23-bazel-build-go">2.3 Bazel build Go</h3>

<p>// <a href="https://bazel.build">https://bazel.build</a></p>

<p>// <a href="https://github.com/golang/go/wiki/vgo">vgo · golang/go Wiki</a></p>

<p>// <a href="https://github.com/golang/dep">golang/dep: Go dependency management tool</a></p>

<h3 id="24-基于go-ethereum构建dpos机制下的区块链">2.4 基于Go-Ethereum构建DPOS机制下的区块链</h3>

<p>// <a href="https://www.ethereum.org/">Ethereum Project</a></p>

<p># 以太坊技术协议，以太坊客户端</p>
<ul>
  <li>Geth (Go)</li>
  <li>Parity (Rust)</li>
  <li>cpp-ethereum (c++)</li>
  <li>ethereumj (java)</li>
</ul>

<p># 以太坊核心组件</p>
<ul>
  <li>Solidity, a new language for smart contracts, 智能合约</li>
  <li>Web3.js</li>
</ul>

<p># 以太坊相关工具组</p>
<ul>
  <li>Truffle</li>
  <li>Metamask</li>
  <li>mist</li>
</ul>

<p># 以太坊外部存储</p>
<ul>
  <li>IPFS (Go)</li>
  <li>Swarm (Go)</li>
</ul>

<p># 共识机制对比</p>
<ul>
  <li>POW
    <ul>
      <li>消耗计算力</li>
      <li>出块速度慢，确认慢</li>
      <li>TPS 极低，10~20</li>
      <li>确认1分支+</li>
    </ul>
  </li>
  <li>DPOS
    <ul>
      <li>代理人模式</li>
      <li>出块速度快，确认块</li>
      <li>TPS 700~1000</li>
      <li>平均确认1~3秒</li>
    </ul>
  </li>
</ul>

<h3 id="25-深入cgo编程">2.5 深入CGO编程</h3>

<p>// <a href="https://dave.cheney.net/2016/01/18/cgo-is-not-go">cgo is not Go | Dave Cheney</a></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="c">/*
#include &lt;stdio.h&gt;

static void _(const char* s) {
    printf("%s\n", s);
}
*/</span>
<span class="k">import</span> <span class="s">"C"</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">bytes</span> <span class="o">:=</span> <span class="o">*</span><span class="nb">new</span><span class="p">([]</span><span class="kt">byte</span><span class="p">)</span>
    <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">72</span><span class="p">)</span>
    <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">101</span><span class="p">,</span> <span class="m">121</span><span class="p">)</span>
    <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">32</span><span class="p">,</span> <span class="m">230</span><span class="p">,</span> <span class="m">159</span><span class="p">)</span>
    <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">177</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">33</span><span class="p">)</span>
    <span class="n">C</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">CString</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">bytes</span><span class="p">)))</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go build <span class="nt">-x</span> hello.go
<span class="nv">WORK</span><span class="o">=</span>/tmp/go-build276115419
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$WORK</span>/b001/
<span class="nb">cd</span> /tmp
<span class="nv">CGO_LDFLAGS</span><span class="o">=</span><span class="s1">'"-g" "-O2"'</span> /usr/local/go/pkg/tool/linux_amd64/cgo <span class="nt">-objdir</span> ./go-build276115419/b001/ <span class="nt">-importpath</span> command-line-arguments <span class="nt">--</span> <span class="nt">-I</span> ./go-build276115419/b001/ <span class="nt">-g</span> <span class="nt">-O2</span> ./hello.go
<span class="nb">cd</span> <span class="nv">$WORK</span>
gcc <span class="nt">-fno-caret-diagnostics</span> <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
</span>gcc <span class="nt">-Qunused-arguments</span> <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
</span>gcc <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">a</span><span class="o">=</span>b <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
</span>gcc <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
cd</span> <span class="nv">$WORK</span>/b001
gcc <span class="nt">-I</span> /tmp <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-I</span> ./ <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-o</span> ./_x001.o <span class="nt">-c</span> _cgo_export.c
gcc <span class="nt">-I</span> /tmp <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-I</span> ./ <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-o</span> ./_x002.o <span class="nt">-c</span> hello.cgo2.c
gcc <span class="nt">-I</span> /tmp <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-I</span> ./ <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-o</span> ./_cgo_main.o <span class="nt">-c</span> _cgo_main.c
<span class="nb">cd</span> /tmp
gcc <span class="nt">-I</span> <span class="nb">.</span> <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-o</span> ./go-build276115419/b001/_cgo_.o ./go-build276115419/b001/_cgo_main.o ./go-build276115419/b001/_x001.o ./go-build276115419/b001/_x002.o <span class="nt">-g</span> <span class="nt">-O2</span>
/usr/local/go/pkg/tool/linux_amd64/cgo <span class="nt">-dynpackage</span> main <span class="nt">-dynimport</span> ./go-build276115419/b001/_cgo_.o <span class="nt">-dynout</span> ./go-build276115419/b001/_cgo_import.go
<span class="nb">cat</span> <span class="o">&gt;</span><span class="nv">$WORK</span>/b001/importcfg <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">' # internal
# import config
packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a
packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a
packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
</span><span class="no">EOF
</span>/usr/local/go/pkg/tool/linux_amd64/compile <span class="nt">-o</span> ./go-build276115419/b001/_pkg_.a <span class="nt">-trimpath</span> ./go-build276115419/b001 <span class="nt">-p</span> main <span class="nt">-buildid</span> mh6f74THdmFYkLXlaEeI/mh6f74THdmFYkLXlaEeI <span class="nt">-goversion</span> go1.10.1 <span class="nt">-D</span> _/tmp <span class="nt">-importcfg</span> ./go-build276115419/b001/importcfg <span class="nt">-pack</span> <span class="nt">-c</span><span class="o">=</span>4 ./go-build276115419/b001/_cgo_gotypes.go ./go-build276115419/b001/hello.cgo1.go ./go-build276115419/b001/_cgo_import.go
/usr/local/go/pkg/tool/linux_amd64/pack r ./go-build276115419/b001/_pkg_.a ./go-build276115419/b001/_x001.o ./go-build276115419/b001/_x002.o <span class="c"># internal</span>
/usr/local/go/pkg/tool/linux_amd64/buildid <span class="nt">-w</span> <span class="nv">$WORK</span>/b001/_pkg_.a <span class="c"># internal</span>
<span class="nb">cp</span> <span class="nv">$WORK</span>/b001/_pkg_.a /home/x/.cache/go-build/5f/5fbfbbfb3d3561c7d7f9b6eb2595c5b5c662c609289b0928d54557b768cf6c31-d <span class="c"># internal</span>
<span class="nb">cat</span> <span class="o">&gt;</span><span class="nv">$WORK</span>/b001/importcfg.link <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">' # internal
packagefile command-line-arguments=</span><span class="nv">$WORK</span><span class="sh">/b001/_pkg_.a
packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a
packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a
packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a
packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a
packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a
packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a
packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a
</span><span class="no">EOF
</span><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$WORK</span>/b001/exe/
<span class="nb">cd</span> <span class="nb">.</span>
/usr/local/go/pkg/tool/linux_amd64/link <span class="nt">-o</span> <span class="nv">$WORK</span>/b001/exe/a.out <span class="nt">-importcfg</span> <span class="nv">$WORK</span>/b001/importcfg.link <span class="nt">-buildmode</span><span class="o">=</span>exe <span class="nt">-buildid</span><span class="o">=</span>IDPnrZESvB0RYrGsJZll/mh6f74THdmFYkLXlaEeI/_kgrX-BOL__ZqaG2o79P/IDPnrZESvB0RYrGsJZll <span class="nt">-extld</span><span class="o">=</span>gcc <span class="nv">$WORK</span>/b001/_pkg_.a
/usr/local/go/pkg/tool/linux_amd64/buildid <span class="nt">-w</span> <span class="nv">$WORK</span>/b001/exe/a.out <span class="c"># internal</span>
<span class="nb">mv</span> <span class="nv">$WORK</span>/b001/exe/a.out hello
<span class="nb">rm</span> <span class="nt">-r</span> <span class="nv">$WORK</span>/b001/
</code></pre></div></div>

<h3 id="26-go与虚拟化容器-runvkata">2.6 Go与虚拟化容器 runV/Kata</h3>

<p>// <a href="https://github.com/hyperhq/runv">hyperhq/runv: Hypervisor-based Runtime for OCI</a></p>

<p># Secure as VM, Fast as Container</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">arr</span> <span class="o">:=</span> <span class="p">[]</span><span class="k">struct</span><span class="p">{</span> <span class="n">v</span> <span class="kt">int</span> <span class="p">}{{</span><span class="m">1</span><span class="p">},</span> <span class="p">{</span><span class="n">v</span><span class="o">:</span> <span class="m">2</span><span class="p">},</span> <span class="p">{</span><span class="m">3</span><span class="p">}}</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">e</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">arr</span> <span class="p">{</span>
                <span class="n">e</span><span class="o">.</span><span class="n">v</span><span class="o">++</span>
        <span class="p">}</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">arr</span> <span class="p">{</span>
                <span class="n">arr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="o">++</span>
        <span class="p">}</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Output</span>
<span class="c">// [{1} {2} {3}]</span>
<span class="c">// [{2} {3} {4}]</span>
</code></pre></div></div>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
        <span class="s">"fmt"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">s0</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">}</span>
        <span class="n">s1</span> <span class="o">:=</span> <span class="n">s0</span><span class="p">[</span><span class="o">:</span><span class="m">2</span><span class="p">]</span>              <span class="c">// len=2, cap=4, [1, 2]</span>
        <span class="n">s2</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span>       <span class="c">// len=3, cap=4, [1, 2, 5]</span>
        <span class="n">s3</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">7</span><span class="p">)</span>    <span class="c">// len=4, cap=4, [1, 2, 6, 7]</span>
        <span class="n">s4</span> <span class="o">:=</span> <span class="nb">append</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">9</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span> <span class="c">// len=5, cap=8, [1, 2, 8, 9, 0]</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">s3</span><span class="p">)</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">s4</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Output</span>
<span class="c">// [1 2 6 7]</span>
<span class="c">// [1 2]</span>
<span class="c">// [1 2 6]</span>
<span class="c">// [1 2 6 7]</span>
<span class="c">// [1 2 8 9 0]</span>
</code></pre></div></div>

<h3 id="27-go-toolchain-internals-and-implementation-based-on-arm64">2.7 Go toolchain internals and implementation based on arm64</h3>

<p>// <a href="https://dave.cheney.net/2013/10/15/how-does-the-go-build-command-work">How does the go build command work ? | Dave Cheney</a></p>

<p># Go toolchain overview</p>

<p>A toolchain is a package composed of the compiler and ancillary tools, libraries and runtime for a language which together allow you to build and run code written in that language.</p>

<ul>
  <li><strong>gc</strong>: evolved from the <a href="https://en.wikipedia.org/wiki/Plan_9_from_Bell_Labs">Plan 9</a> toolchain and includes its own compiler, assembler, linker and tools, as well as the Go runtime and standard library.</li>
  <li><strong>gccgo</strong>: extends the <a href="https://gcc.gnu.org/">gcc</a> project to support Go.</li>
  <li><strong>llgo</strong>: built on top of the LLVM compiler infrastructure.</li>
</ul>

<p># Go toolchain example</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="s">"fmt"</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">bytes</span> <span class="o">:=</span> <span class="o">*</span><span class="nb">new</span><span class="p">([]</span><span class="kt">byte</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">72</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">101</span><span class="p">,</span> <span class="m">121</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">32</span><span class="p">,</span> <span class="m">230</span><span class="p">,</span> <span class="m">159</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">177</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">33</span><span class="p">)</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go build <span class="nt">-x</span> hello.go
<span class="nv">WORK</span><span class="o">=</span>/tmp/go-build173481643
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$WORK</span>/b001/
<span class="nb">cat</span> <span class="o">&gt;</span><span class="nv">$WORK</span>/b001/importcfg <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">' # internal
# import config
packagefile fmt=/usr/local/go/pkg/linux_amd64/fmt.a
packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
</span><span class="no">EOF
</span><span class="nb">cd</span> /tmp
/usr/local/go/pkg/tool/linux_amd64/compile <span class="nt">-o</span> ./go-build173481643/b001/_pkg_.a <span class="nt">-trimpath</span> ./go-build173481643/b001 <span class="nt">-p</span> main <span class="nt">-complete</span> <span class="nt">-buildid</span> 8sirXYvMbbfw92k19xYW/8sirXYvMbbfw92k19xYW <span class="nt">-goversion</span> go1.10.1 <span class="nt">-D</span> _/tmp <span class="nt">-importcfg</span> ./go-build173481643/b001/importcfg <span class="nt">-pack</span> <span class="nt">-c</span><span class="o">=</span>4 ./hello.go
/usr/local/go/pkg/tool/linux_amd64/buildid <span class="nt">-w</span> <span class="nv">$WORK</span>/b001/_pkg_.a <span class="c"># internal</span>
<span class="nb">cp</span> <span class="nv">$WORK</span>/b001/_pkg_.a /home/x/.cache/go-build/30/30c2c39b4791f0cd3ff6f312df7ef17888d3eb206e0c11fac21287cff9e0cf3b-d <span class="c"># internal</span>
<span class="nb">cat</span> <span class="o">&gt;</span><span class="nv">$WORK</span>/b001/importcfg.link <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">' # internal
packagefile command-line-arguments=</span><span class="nv">$WORK</span><span class="sh">/b001/_pkg_.a
packagefile fmt=/usr/local/go/pkg/linux_amd64/fmt.a
packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
packagefile errors=/usr/local/go/pkg/linux_amd64/errors.a
packagefile io=/usr/local/go/pkg/linux_amd64/io.a
packagefile math=/usr/local/go/pkg/linux_amd64/math.a
packagefile os=/usr/local/go/pkg/linux_amd64/os.a
packagefile reflect=/usr/local/go/pkg/linux_amd64/reflect.a
packagefile strconv=/usr/local/go/pkg/linux_amd64/strconv.a
packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a
packagefile unicode/utf8=/usr/local/go/pkg/linux_amd64/unicode/utf8.a
packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a
packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a
packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a
packagefile internal/cpu=/usr/local/go/pkg/linux_amd64/internal/cpu.a
packagefile internal/poll=/usr/local/go/pkg/linux_amd64/internal/poll.a
packagefile internal/testlog=/usr/local/go/pkg/linux_amd64/internal/testlog.a
packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a
packagefile time=/usr/local/go/pkg/linux_amd64/time.a
packagefile unicode=/usr/local/go/pkg/linux_amd64/unicode.a
packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a
</span><span class="no">EOF
</span><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$WORK</span>/b001/exe/
<span class="nb">cd</span> <span class="nb">.</span>
/usr/local/go/pkg/tool/linux_amd64/link <span class="nt">-o</span> <span class="nv">$WORK</span>/b001/exe/a.out <span class="nt">-importcfg</span> <span class="nv">$WORK</span>/b001/importcfg.link <span class="nt">-buildmode</span><span class="o">=</span>exe <span class="nt">-buildid</span><span class="o">=</span>Vbu61g9AuYzF2ufqINOR/8sirXYvMbbfw92k19xYW/iWFW984BSmpZp9MnLdjK/Vbu61g9AuYzF2ufqINOR <span class="nt">-extld</span><span class="o">=</span>gcc <span class="nv">$WORK</span>/b001/_pkg_.a
/usr/local/go/pkg/tool/linux_amd64/buildid <span class="nt">-w</span> <span class="nv">$WORK</span>/b001/exe/a.out <span class="c"># internal</span>
<span class="nb">mv</span> <span class="nv">$WORK</span>/b001/exe/a.out hello
<span class="nb">rm</span> <span class="nt">-r</span> <span class="nv">$WORK</span>/b001/
</code></pre></div></div>

<hr />

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="c">/*
 #include &lt;stdio.h&gt;

 static void _(const char* s) {
     printf("%s\n", s);
 }
*/</span>
<span class="k">import</span> <span class="s">"C"</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">bytes</span> <span class="o">:=</span> <span class="o">*</span><span class="nb">new</span><span class="p">([]</span><span class="kt">byte</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">72</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">101</span><span class="p">,</span> <span class="m">121</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">32</span><span class="p">,</span> <span class="m">230</span><span class="p">,</span> <span class="m">159</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="m">177</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">33</span><span class="p">,</span> <span class="m">33</span><span class="p">)</span>
        <span class="n">C</span><span class="o">.</span><span class="n">_</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">CString</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">bytes</span><span class="p">)))</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go build <span class="nt">-x</span> hello.go
<span class="nv">WORK</span><span class="o">=</span>/tmp/go-build142064459
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$WORK</span>/b001/
<span class="nb">cd</span> /tmp
<span class="nv">CGO_LDFLAGS</span><span class="o">=</span><span class="s1">'"-g" "-O2"'</span> /usr/local/go/pkg/tool/linux_amd64/cgo <span class="nt">-objdir</span> ./go-build142064459/b001/ <span class="nt">-importpath</span> command-line-arguments <span class="nt">--</span> <span class="nt">-I</span> ./go-build142064459/b001/ <span class="nt">-g</span> <span class="nt">-O2</span> ./hello.go
<span class="nb">cd</span> <span class="nv">$WORK</span>
gcc <span class="nt">-fno-caret-diagnostics</span> <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
</span>gcc <span class="nt">-Qunused-arguments</span> <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
</span>gcc <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">a</span><span class="o">=</span>b <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
</span>gcc <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-c</span> <span class="nt">-x</span> c - <span class="o">||</span> <span class="nb">true
cd</span> <span class="nv">$WORK</span>/b001
gcc <span class="nt">-I</span> /tmp <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-I</span> ./ <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-o</span> ./_x001.o <span class="nt">-c</span> _cgo_export.c
gcc <span class="nt">-I</span> /tmp <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-I</span> ./ <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-o</span> ./_x002.o <span class="nt">-c</span> hello.cgo2.c
gcc <span class="nt">-I</span> /tmp <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-I</span> ./ <span class="nt">-g</span> <span class="nt">-O2</span> <span class="nt">-o</span> ./_cgo_main.o <span class="nt">-c</span> _cgo_main.c
<span class="nb">cd</span> /tmp
gcc <span class="nt">-I</span> <span class="nb">.</span> <span class="nt">-fPIC</span> <span class="nt">-m64</span> <span class="nt">-pthread</span> <span class="nt">-fmessage-length</span><span class="o">=</span>0 <span class="nt">-fdebug-prefix-map</span><span class="o">=</span><span class="nv">$WORK</span>/b001<span class="o">=</span>/tmp/go-build <span class="nt">-gno-record-gcc-switches</span> <span class="nt">-o</span> ./go-build142064459/b001/_cgo_.o ./go-build142064459/b001/_cgo_main.o ./go-build142064459/b001/_x001.o ./go-build142064459/b001/_x002.o <span class="nt">-g</span> <span class="nt">-O2</span>
/usr/local/go/pkg/tool/linux_amd64/cgo <span class="nt">-dynpackage</span> main <span class="nt">-dynimport</span> ./go-build142064459/b001/_cgo_.o <span class="nt">-dynout</span> ./go-build142064459/b001/_cgo_import.go
<span class="nb">cat</span> <span class="o">&gt;</span><span class="nv">$WORK</span>/b001/importcfg <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">' # internal
# import config
packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a
packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a
packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
</span><span class="no">EOF
</span>/usr/local/go/pkg/tool/linux_amd64/compile <span class="nt">-o</span> ./go-build142064459/b001/_pkg_.a <span class="nt">-trimpath</span> ./go-build142064459/b001 <span class="nt">-p</span> main <span class="nt">-buildid</span> WZbBGQxOraNbiT0WofcS/WZbBGQxOraNbiT0WofcS <span class="nt">-goversion</span> go1.10.1 <span class="nt">-D</span> _/tmp <span class="nt">-importcfg</span> ./go-build142064459/b001/importcfg <span class="nt">-pack</span> <span class="nt">-c</span><span class="o">=</span>4 ./go-build142064459/b001/_cgo_gotypes.go ./go-build142064459/b001/hello.cgo1.go ./go-build142064459/b001/_cgo_import.go
/usr/local/go/pkg/tool/linux_amd64/pack r ./go-build142064459/b001/_pkg_.a ./go-build142064459/b001/_x001.o ./go-build142064459/b001/_x002.o <span class="c"># internal</span>
/usr/local/go/pkg/tool/linux_amd64/buildid <span class="nt">-w</span> <span class="nv">$WORK</span>/b001/_pkg_.a <span class="c"># internal</span>
<span class="nb">cp</span> <span class="nv">$WORK</span>/b001/_pkg_.a /home/x/.cache/go-build/5b/5bedc3923cfc8c06c00e1d8446bf5dd68c35f112d221a1589a8e4ec2fa4b9b11-d <span class="c"># internal</span>
<span class="nb">cat</span> <span class="o">&gt;</span><span class="nv">$WORK</span>/b001/importcfg.link <span class="o">&lt;&lt;</span> <span class="sh">'</span><span class="no">EOF</span><span class="sh">' # internal
packagefile command-line-arguments=</span><span class="nv">$WORK</span><span class="sh">/b001/_pkg_.a
packagefile runtime/cgo=/usr/local/go/pkg/linux_amd64/runtime/cgo.a
packagefile syscall=/usr/local/go/pkg/linux_amd64/syscall.a
packagefile runtime=/usr/local/go/pkg/linux_amd64/runtime.a
packagefile internal/race=/usr/local/go/pkg/linux_amd64/internal/race.a
packagefile sync=/usr/local/go/pkg/linux_amd64/sync.a
packagefile runtime/internal/atomic=/usr/local/go/pkg/linux_amd64/runtime/internal/atomic.a
packagefile runtime/internal/sys=/usr/local/go/pkg/linux_amd64/runtime/internal/sys.a
packagefile sync/atomic=/usr/local/go/pkg/linux_amd64/sync/atomic.a
</span><span class="no">EOF
</span><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$WORK</span>/b001/exe/
<span class="nb">cd</span> <span class="nb">.</span>
/usr/local/go/pkg/tool/linux_amd64/link <span class="nt">-o</span> <span class="nv">$WORK</span>/b001/exe/a.out <span class="nt">-importcfg</span> <span class="nv">$WORK</span>/b001/importcfg.link <span class="nt">-buildmode</span><span class="o">=</span>exe <span class="nt">-buildid</span><span class="o">=</span>4aUladWsuR7j-eqT9vPE/WZbBGQxOraNbiT0WofcS/8tvmjI0-hde6HLKu2J8F/4aUladWsuR7j-eqT9vPE <span class="nt">-extld</span><span class="o">=</span>gcc <span class="nv">$WORK</span>/b001/_pkg_.a
/usr/local/go/pkg/tool/linux_amd64/buildid <span class="nt">-w</span> <span class="nv">$WORK</span>/b001/exe/a.out <span class="c"># internal</span>
<span class="nb">mv</span> <span class="nv">$WORK</span>/b001/exe/a.out hello
<span class="nb">rm</span> <span class="nt">-r</span> <span class="nv">$WORK</span>/b001/
</code></pre></div></div>

<p># Go toolchian overflow</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go tool
addr2line
asm
buildid
cgo
compile
cover
dist
doc
fix
<span class="nb">link
</span>nm
objdump
pack
pprof
test2json
tour
trace
vet
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">*.go</code> – compile –&gt; $WORK/b001/<em>pkg</em>.a</li>
  <li><code class="language-plaintext highlighter-rouge">*.s</code>  – asm –&gt; <code class="language-plaintext highlighter-rouge">*.o</code> – pack –&gt; runtime=$WORK/b002/<em>pkg</em>.a</li>
  <li>internal/bytealg=$WORK/b003/<em>pkg</em>.a</li>
  <li>. . .</li>
</ul>

<hr />

<ul>
  <li><code class="language-plaintext highlighter-rouge">*.a</code> – link –&gt; hello</li>
</ul>

<h3 id="28-go在探探后端的工程实践">2.8 Go在探探后端的工程实践</h3>

  </div>

  <ul class="post-navigation">
    <li>
      
      <a href="/2018/04/09/partition-format-mount-disk-driver-linux/">&laquo; Partition, format and mount driver on Linux</a>
      
    </li>
    <li>
      
      <a href="/2018/04/20/firewall-netfilter-iptables/">Linux firewall, netfilter and iptables &raquo;</a>
      
    </li>
  </ul>
</article>

      </div>
    </div>

    <footer class="site-footer">
  <div class="license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details open>
    <summary>Extral Links</summary>
    <div>
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>


<!-- https://github.com/bryanbraun/anchorjs -->
<script src="/js/anchor.min.js"></script>
<script>
  anchors.add();
  anchors.remove(".site-title");
</script>




  </body>

</html>

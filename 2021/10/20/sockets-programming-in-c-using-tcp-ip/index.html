<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bing WebMaster -->
  <meta name="msvalidate.01" content="AB2FFF876C37F59D9121882CC8395DE5" />

  <title>Sockets Programming in C using TCP/IP</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://blog.codefarm.me/2021/10/20/sockets-programming-in-c-using-tcp-ip/">
  <link rel="alternate" type="application/rss+xml" title="CODE FARM" href="https://blog.codefarm.me/feed.xml">

  <!-- https://cdn.jsdelivr.net/gh/lurongkai/anti-baidu/js/anti-baidu-latest.min.js -->
<script type="text/javascript" src="/js/anti-baidu.min.js" charset="UTF-8"></script>

  
<!-- Google Analytics Website tracking -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83971182-1', 'auto');
  ga('send', 'pageview');

</script>


  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SN88FJ18E5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SN88FJ18E5');
</script>



</head>


  <body>

    <header class="site-header">

  <div class="wrapper">
    <h2 class="site-title">
      <a class="site-title" href="/">CODE FARM</a>
    </h2>

     <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
        <div class="trigger">
            <ul>
                <li><a href="/">home</a>
                <li><a href="/category">category</a>
                <li><a href="/tag">tag</a>
                <li><a href="/archive">archive</a>
                <li><a href="/about">about</a>
                <li><a href="https://resume.github.io/?qqbuby" target="_blank">R&eacute;sum&eacute;</a>
            </ul>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Sockets Programming in C using TCP/IP</h1>
    
    
    <p class="post-meta"><time datetime="2021-10-20T13:13:54+08:00" itemprop="datePublished">Oct 20, 2021</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <div id="toc" class="toc">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#berkley-sockets">1. Berkley Sockets</a>
<ul class="sectlevel2">
<li><a href="#sockets">1.1. Sockets</a></li>
</ul>
</li>
<li><a href="#socket-programming">2. Socket Programming</a>
<ul class="sectlevel2">
<li><a href="#client-server-communication">2.1. Client-Server communication</a></li>
<li><a href="#sockets-procedures">2.2. Sockets - Procedures</a></li>
<li><a href="#client-server-communication-unix">2.3. Client - Server Communication - Unix</a></li>
<li><a href="#example-echo">2.4. Example - Echo</a></li>
</ul>
</li>
<li><a href="#references">3. References</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="berkley-sockets">1. Berkley Sockets</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Universally known as <strong>Sockets</strong></p>
</li>
<li>
<p>It is an abstraction through which an application may send and receive data</p>
</li>
<li>
<p>Provide generic accessto <em>interprocess communication</em> services</p>
<div class="ulist">
<ul>
<li>
<p>e.g. IPX/SPX, Appletalk, TCP/IP</p>
</li>
</ul>
</div>
</li>
<li>
<p>Standard API for networking</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="sockets">1.1. Sockets</h3>
<div class="ulist">
<ul>
<li>
<p>Uniquely identified by</p>
<div class="ulist">
<ul>
<li>
<p>an <code>internet address</code></p>
</li>
<li>
<p>an end-to-end <code>protocol</code> (e.g. TCP or UDP)</p>
</li>
<li>
<p>a <code>port number</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Two types of (TCP/IP) sockets</p>
<div class="ulist">
<ul>
<li>
<p><strong>Stream</strong> sockets (e.g. uses TCP)</p>
<div class="ulist">
<ul>
<li>
<p>provide reliable byte-stream service</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Datagram</strong> sockets (e.g. uses UDP)</p>
<div class="ulist">
<ul>
<li>
<p>provide best-effort datagram service</p>
</li>
<li>
<p>messages up to 65.500 bytes</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Socket extend the convectional UNIX I/O facilities</p>
<div class="ulist">
<ul>
<li>
<p>file descriptors for network communication</p>
</li>
<li>
<p>extended the read and write system calls</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="socket-programming">2. Socket Programming</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="client-server-communication">2.1. Client-Server communication</h3>
<div class="ulist">
<ul>
<li>
<p>Server</p>
<div class="ulist">
<ul>
<li>
<p>passively waits for and responds to clients</p>
</li>
<li>
<p><strong>passive</strong> socket</p>
</li>
</ul>
</div>
</li>
<li>
<p>Client</p>
<div class="ulist">
<ul>
<li>
<p>initiates the communication</p>
</li>
<li>
<p>must know the address and the port of the server</p>
</li>
<li>
<p><strong>active</strong> socket</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="sockets-procedures">2.2. Sockets - Procedures</h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Sockets - Procedures</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Primitive</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Socket</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Create a new commnunication endpoint</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bind</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Attach a local address to a socket</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Listen</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Announce willingness to accept connections</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Accept</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Block caller until a connection request arrives</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connect</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Actively attempt to establish a connection</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send some date over the connection</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Receive</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Receive some date over the connection</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shutdown</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shut down part of a full-duplex connection</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Close</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Release the connection</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="client-server-communication-unix">2.3. Client - Server Communication - Unix</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="man">SOCKET(2)                  Linux Programmer's Manual                 SOCKET(2)

NAME
       socket - create an endpoint for communication

SYNOPSIS
       #include &lt;sys/types.h&gt;          /* See NOTES */
       #include &lt;sys/socket.h&gt;

       int socket(int domain, int type, int protocol);

DESCRIPTION
       socket()  creates  an endpoint for communication and returns a file de‐
       scriptor that refers to that endpoint.  The file descriptor returned by
       a  successful call will be the lowest-numbered file descriptor not cur‐
       rently open for the process.</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Client - Server Communication - Unix</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="3">Stream (e.g. TCP)</th>
<th class="tableblock halign-left valign-top" colspan="3">Datagram (e.g. UDP)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Server</strong></p></td>
<td class="tableblock halign-left valign-top" rowspan="4"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Client</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Server</strong></p></td>
<td class="tableblock halign-left valign-top" rowspan="5"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Client</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">socket()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">socket()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">socket()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">socket()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bind()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;bind()&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bind()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bind()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">listen()</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top" rowspan="2"></td>
<td class="tableblock halign-left valign-top" rowspan="2"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">accept()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>syn point</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connect()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">recv()</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">send()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">recvfrom()</p></td>
<td class="tableblock halign-left valign-top" rowspan="2"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sendto()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">send()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">recv()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sendto()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">recvfrom()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">close()</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">close()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">close()</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">close()</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="socket-creation-in-c-socket">2.3.1. Socket creation in C: <code>socket()</code></h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>int sockid = socket(family, type, protocol);</code></p>
<div class="ulist">
<ul>
<li>
<p><code>sockid</code>: socket descriptor, an integer (like a file-handle)</p>
</li>
<li>
<p><code>family</code>: integer, communication domain, e.g.,</p>
<div class="ulist">
<ul>
<li>
<p>PF_INET, IPv4 protocols, Internet addresses (typically used)</p>
</li>
<li>
<p>PF_UNIX, Local communication, File addresses</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>type</code>: communication type</p>
<div class="ulist">
<ul>
<li>
<p>SOCK_STREAM - reliable, 2-way, connection-based service</p>
</li>
<li>
<p>SOCK_DGRAM - unreliable, connectionless, messages of maximum length</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>protocol</code>: specifies protocol</p>
<div class="ulist">
<ul>
<li>
<p>IPPROTO_TCP IPPROTO_UDP</p>
</li>
<li>
<p>usually set to 0 (i.e., use default protocol)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>upon failure returns -1</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>Note:</strong> socket call does not specify where data will be coming from, nor where it will be going to – it just creates the interface!
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="socket-close-in-c-close">2.3.2. Socket close in C: <code>close()</code></h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">close</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>When finished using a socket, the socket should be closed</p>
<div class="ulist">
<ul>
<li>
<p><code>status= close(sockid);</code></p>
<div class="ulist">
<ul>
<li>
<p><code>sockid</code>: the file descriptor (socket being closed)</p>
</li>
<li>
<p><code>status</code>: 0 if successful, -1 if error</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Closing a socket</p>
<div class="ulist">
<ul>
<li>
<p>closes a connection (for stream socket)</p>
</li>
<li>
<p>frees up the port used by the socket</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="assign-address-to-socket-bind">2.3.3. Assign address to socket: <code>bind()</code></h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="c1">          /* See NOTES */</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">bind</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
         <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>associates and reserves a port for use by the socket</p>
</li>
<li>
<p><code>int status = bind(sockid, &amp;addrport, size);</code></p>
<div class="ulist">
<ul>
<li>
<p><code>sockid</code>: integer, socket descriptor</p>
</li>
<li>
<p><code>addrport</code>: struct sockaddr, the (IP) address and port of the machine</p>
<div class="ulist">
<ul>
<li>
<p>for TCP/IP server, internet address is usually set to INADDR_ANY, i.e., chooses any incoming interface</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>size</code>: the size (in bytes) of the addrport structure</p>
</li>
<li>
<p><code>status</code>: upon failure -1 is returned</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="specifying-addresses">2.3.3.1. Specifying Addresses</h5>
<div class="ulist">
<ul>
<li>
<p>Socket API defines a generic data type for addresses:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">struct</span> <span class="n">sockaddr</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sa_family</span><span class="p">;</span> <span class="cm">/* Address family (e.g. AF_INET) */</span>
    <span class="kt">char</span> <span class="n">sa_data</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>         <span class="cm">/* Family-specific address information */</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Particular form of the <code>sockaddr</code> used for TCP/IP addresses:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="k">struct</span> <span class="n">in_addr</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s_addr</span><span class="p">;</span>      <span class="cm">/* Internet address (32 bits) */</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sin_family</span><span class="p">;</span> <span class="cm">/* Internet protocol (AF_INET) */</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sin_port</span><span class="p">;</span>   <span class="cm">/* Address port (16 bits) */</span>
    <span class="k">struct</span> <span class="n">in_addr</span> <span class="n">sin_addr</span><span class="p">;</span>   <span class="cm">/* Internet address (32 bits) */</span>
    <span class="kt">char</span> <span class="n">sin_zero</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>          <span class="cm">/* Not used */</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<strong>Important:</strong> <code>sockaddr_in</code> can be casted to a <code>sockaddr</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="bind-example-with-tcp">2.3.3.2. <code>bind()</code> - Example with TCP</h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="kt">int</span> <span class="n">sockid</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addrport</span><span class="p">;</span>
<span class="n">sockid</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">addrport</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
<span class="n">addrport</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">5100</span><span class="p">);</span>
<span class="n">addrport</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">sockid</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addrport</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addrport</span><span class="p">))</span><span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// …</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="skipping-the-bind">2.3.3.3. Skipping the <code>bind()</code></h5>
<div class="ulist">
<ul>
<li>
<p>bind can be skipped for both types of sockets</p>
<div class="ulist">
<ul>
<li>
<p>Datagram socket:</p>
<div class="ulist">
<ul>
<li>
<p>if only sending, no need to bind. The OS finds a port each timethe socket sends a packet</p>
</li>
<li>
<p>if receiving, need to bind</p>
</li>
</ul>
</div>
</li>
<li>
<p>Stream socket:</p>
<div class="ulist">
<ul>
<li>
<p>destination determined during connection setup</p>
</li>
<li>
<p>don&#8217;t need to know port sending from (during connection setup, receiving end is informed of port)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="assign-address-to-socket-listen">2.3.4. Assign address to socket: <code>listen()</code></h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">listen</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Instructs TCP protocol implementation to listen for connections</p>
</li>
<li>
<p><code>int status = listen(sockid, queueLimit);</code></p>
<div class="ulist">
<ul>
<li>
<p><code>sockid</code>: integer, socket descriptor</p>
</li>
<li>
<p><code>queueLimit</code>: integer, # of active participants that can "wait" for a connection</p>
</li>
<li>
<p><code>status</code>: 0 if listening, -1 if error</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>listen()</code> is <strong>non-blocking</strong>: returns immediately</p>
</li>
<li>
<p>The listening socket (<code>sockid</code>)</p>
<div class="ulist">
<ul>
<li>
<p>is never used for sending and receiving</p>
</li>
<li>
<p>is used by the server only as a way to get new sockets</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="establish-connection-connect">2.3.5. Establish Connection: <code>connect()</code></h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">connect</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
            <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The client establishes a connection with the server by calling <code>connect()</code></p>
</li>
<li>
<p><code>int status = connect(sockid, &amp;foreignAddr, addrlen);</code></p>
<div class="ulist">
<ul>
<li>
<p><code>sockid</code>: integer, socket to be used in connection</p>
</li>
<li>
<p><code>foreignAddr</code>: struct sockaddr: address of the passive participant</p>
</li>
<li>
<p><code>addrlen</code>: integer, sizeof(foreignAddr)</p>
</li>
<li>
<p><code>status</code>: 0 if successful connect, -1 otherwise</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>connect()</code> is <strong>blocking</strong></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="incoming-connection-accept">2.3.6. Incoming Connection: <code>accept()</code></h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">accept</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The server gets a socket for an incoming client connection by calling <code>accept()</code></p>
</li>
<li>
<p><code>int s = accept(sockid, &amp;clientAddr, &amp;addrLen);</code></p>
<div class="ulist">
<ul>
<li>
<p><code>s</code>: integer, the new socket (used for <em>data-transfer</em>)</p>
</li>
<li>
<p><code>sockid</code>: integer, the orig. socket (being listened on)</p>
</li>
<li>
<p><code>clientAddr</code>: struct sockaddr, address of the active participant</p>
<div class="ulist">
<ul>
<li>
<p>filled in upon return</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>addrLen</code>: sizeof(clientAddr): value/result parameter</p>
<div class="ulist">
<ul>
<li>
<p>must be set appropriately before call</p>
</li>
<li>
<p>adjusted upon return</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p><code>accept()</code></p>
<div class="ulist">
<ul>
<li>
<p>is <strong>blocking</strong>: waits for connection before returning</p>
</li>
<li>
<p>dequeues the next connection on the queue for socket (<code>sockid</code>)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="exchanging-data-with-stream-socket">2.3.7. Exchanging data with stream socket</h4>
<div class="ulist">
<ul>
<li>
<p><code>int count = send(sockid, msg, msgLen, flags);</code></p>
<div class="ulist">
<ul>
<li>
<p><code>msg</code>: const void[], message to be transmitted</p>
</li>
<li>
<p><code>msgLen</code>: integer, length of message (in bytes) to transmit</p>
</li>
<li>
<p><code>flags</code>: integer, special options, usually just 0</p>
</li>
<li>
<p><code>count</code>: # bytes transmitted (-1 if error)</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>int count = recv(sockid, recvBuf, bufLen, flags);</code></p>
<div class="ulist">
<ul>
<li>
<p><code>recvBuf</code>: void[], stores received bytes</p>
</li>
<li>
<p><code>bufLen</code>: # bytes received</p>
</li>
<li>
<p><code>flags</code>: integer, special options, usually just 0</p>
</li>
<li>
<p><code>count</code>: # bytes received (-1 if error)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Calls are <strong>blocking</strong></p>
<div class="ulist">
<ul>
<li>
<p>returns only after data is sent / received</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="exchanging-data-with-datagram-socket">2.3.8. Exchanging data with datagram socket</h4>
<div class="ulist">
<ul>
<li>
<p><code>int count = sendto(sockid, msg, msgLen, flags, &amp;foreignAddr, addrlen);</code></p>
<div class="ulist">
<ul>
<li>
<p><code>msg</code>, <code>msgLen</code>, <code>flags</code>, <code>count</code>: same with <code>send()</code></p>
</li>
<li>
<p><code>foreignAddr</code>: struct sockaddr, address of the destination</p>
</li>
<li>
<p><code>addrLen</code>: sizeof(foreignAddr)</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>int count = recvfrom(sockid, recvBuf, bufLen, flags, &amp;clientAddr, addrlen);</code></p>
<div class="ulist">
<ul>
<li>
<p><code>recvBuf</code>, <code>bufLen</code>, <code>flags</code>, <code>count</code>: same with <code>recv()</code></p>
</li>
<li>
<p><code>clientAddr</code>: struct sockaddr, address of the client</p>
</li>
<li>
<p><code>addrLen</code>: sizeof(clientAddr)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Calls are <strong>blocking</strong></p>
<div class="ulist">
<ul>
<li>
<p>returns only after data is sent / received</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="example-echo">2.4. Example - Echo</h3>
<div class="ulist">
<ul>
<li>
<p>A client communicates with an "echo" server</p>
</li>
<li>
<p>The server simply echoes whatever it receives back to the client</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cm">/* die_with_error.h */</span>

<span class="kt">void</span> <span class="nf">die_with_error</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cm">/* die_with_error.c */</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">die_with_error</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">errsv</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errsv</span><span class="p">),</span> <span class="n">error</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="echo-using-stream-socket">2.4.1. Echo using stream socket</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cm">/* tcp_server.c */</span>
<span class="cp">#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"die_with_error.h"</span><span class="cp">
</span>
<span class="cp">#define MAXPENDING 1024
#define RCVBUFSIZE 4096
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Create a TCP socket */</span>
    <span class="cm">/* Create socket for incoming connections */</span>
    <span class="kt">int</span> <span class="n">serv_sock</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">serv_sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">die_with_error</span><span class="p">(</span><span class="s">"socket() failed"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Assign a port to socket */</span>
    <span class="kt">int</span> <span class="n">serv_port</span> <span class="o">=</span> <span class="mi">5100</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">serv_addr</span><span class="p">;</span>
    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>                 <span class="cm">/* Internet address family */</span>
    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>  <span class="cm">/* Any incoming interface */</span>
    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">serv_port</span><span class="p">);</span>           <span class="cm">/* Local port */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">serv_sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">serv_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serv_addr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">die_with_error</span><span class="p">(</span><span class="s">"bind() failed"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Set socket to listen */</span>
    <span class="cm">/* Mark the socket so it will listen for incoming connections */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">serv_sock</span><span class="p">,</span> <span class="n">MAXPENDING</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">die_with_error</span><span class="p">(</span><span class="s">"listen() failed"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Repeatedly: */</span>
    <span class="cm">/* Run forever */</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="cm">/* Accept new connectionb */</span>
        <span class="cm">/* Server is now blocked waiting for connection from a client */</span>
        <span class="kt">int</span> <span class="n">client_sock</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">client_addr</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">addr_len</span><span class="p">;</span>
        <span class="n">addr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">client_sock</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">serv_sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr_len</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">die_with_error</span><span class="p">(</span><span class="s">"accept() failed"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">c_addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_addr</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">c_ip_addr</span><span class="p">[</span><span class="n">INET6_ADDRSTRLEN</span><span class="p">];</span>
        <span class="n">inet_ntop</span><span class="p">(</span><span class="n">c_addr</span> <span class="o">-&gt;</span> <span class="n">sin_family</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">c_addr</span> <span class="o">-&gt;</span> <span class="n">sin_addr</span><span class="p">),</span> <span class="n">c_ip_addr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">c_port</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">c_addr</span> <span class="o">-&gt;</span> <span class="n">sin_port</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%s:%d =&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">c_ip_addr</span><span class="p">,</span> <span class="n">c_port</span><span class="p">);</span>

        <span class="cm">/* Receive mesage from client */</span>
        <span class="kt">int</span> <span class="n">recv_msg_size</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">echo_buf</span><span class="p">[</span><span class="n">RCVBUFSIZE</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">recv_msg_size</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">echo_buf</span><span class="p">,</span> <span class="n">RCVBUFSIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">die_with_error</span><span class="p">(</span><span class="s">"first recv() failed"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* Send received string and receive again until end of transmission */</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">recv_msg_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* zero indicates end of transmission */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">send</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">echo_buf</span><span class="p">,</span> <span class="n">recv_msg_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">recv_msg_size</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">die_with_error</span><span class="p">(</span><span class="s">"repeat send() failed"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">printf</span><span class="p">(</span><span class="n">echo_buf</span><span class="p">);</span>
            <span class="n">memset</span><span class="p">(</span><span class="n">echo_buf</span><span class="p">,</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="n">RCVBUFSIZE</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">recv_msg_size</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">echo_buf</span><span class="p">,</span> <span class="n">RCVBUFSIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">die_with_error</span><span class="p">(</span><span class="s">"recv() failed"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="cm">/* Close the connection */</span>
        <span class="n">close</span><span class="p">(</span><span class="n">client_sock</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%s:%d &lt;=</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">c_ip_addr</span><span class="p">,</span> <span class="n">c_port</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><span class="cm">/* tcp_client.c */</span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">"die_with_error.h"</span><span class="cp">
</span>
<span class="cp">#define RCVBUFSIZE 4096
</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Create a TCP socket */</span>
    <span class="cm">/* Create a reliable, stream socket using TCP */</span>
    <span class="kt">int</span> <span class="n">client_sock</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">client_sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="n">IPPROTO_TCP</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">die_with_error</span><span class="p">(</span><span class="s">"socket() failed"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Establish connection */</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">serv_ip</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">serv_port</span> <span class="o">=</span> <span class="mi">5100</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">serv_addr</span><span class="p">;</span>
    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>                     <span class="cm">/* Internet address family */</span>
    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="n">serv_ip</span><span class="p">);</span>     <span class="cm">/* Server IP address*/</span>
    <span class="n">serv_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">serv_port</span><span class="p">);</span>              <span class="cm">/* Server port */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">serv_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serv_addr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">die_with_error</span><span class="p">(</span><span class="s">"connect() failed"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Communicate */</span>
    <span class="kt">int</span> <span class="n">read_len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">read_buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">RCVBUFSIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
    <span class="kt">int</span> <span class="n">recv_msg_size</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">echo_buf</span><span class="p">[</span><span class="n">RCVBUFSIZE</span><span class="p">];</span>
    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">read_buf</span> <span class="o">=</span> <span class="n">fgets</span><span class="p">(</span><span class="n">read_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">read_buf</span><span class="p">),</span> <span class="n">stdin</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">read_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">read_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">read_buf</span><span class="p">);</span> <span class="cm">/* Determine input length *//* Send the string to the server */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">send</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">read_buf</span><span class="p">,</span> <span class="n">read_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">read_len</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">die_with_error</span><span class="p">(</span><span class="s">"send() sent a different number of bytes than expected"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* Receive mesage from server */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">recv_msg_size</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">echo_buf</span><span class="p">,</span> <span class="n">RCVBUFSIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">die_with_error</span><span class="p">(</span><span class="s">"recv() failed"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">fputs</span><span class="p">(</span><span class="n">echo_buf</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">read_buf</span><span class="p">,</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="n">RCVBUFSIZE</span><span class="p">);</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">echo_buf</span><span class="p">,</span> <span class="sc">'\0'</span><span class="p">,</span> <span class="n">RCVBUFSIZE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Close the connection */</span>
    <span class="n">close</span><span class="p">(</span><span class="n">client_sock</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>gcc die_with_error.h die_with_error.c tcp_server.c <span class="nt">-o</span> tcp_server
<span class="gp">$</span><span class="w"> </span>./tcp_server
<span class="gp">127.0.0.1:45934 =&gt;</span><span class="w">
</span><span class="go">Hello world!
127.0.0.1:45934 &lt;=
^C</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="console"><span class="gp">$</span><span class="w"> </span>gcc die_with_error.h die_with_error.c tcp_client.c <span class="nt">-o</span> tcp_client
<span class="gp">$</span><span class="w"> </span><span class="nb">echo</span> <span class="s1">'Hello world!'</span> | ./tcp_client
<span class="go">Hello world!</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="references">3. References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://www.csd.uoc.gr/~hy556/material.html" class="bare">https://www.csd.uoc.gr/~hy556/material.html</a></p>
</li>
</ul>
</div>
</div>
</div>
  </div>

  <ul class="post-navigation">
    <li>
      
      <a href="/2021/10/15/http-strict-transport-security/">&laquo; HTTP Strict-Transport-Security</a>
      
    </li>
    <li>
      
      <a href="/2021/10/28/forwarded-http-extension-ingress-nginx-spring/">Forwarded Headers and Kubernetes Ingress Nginx &raquo;</a>
      
    </li>
  </ul>
</article>

      </div>
    </div>

    <footer class="site-footer">
  <div class="license">
    <span>Article licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></span>
  </div>
  
  <details open>
    <summary>Extral Links</summary>
    <div>
      
      <a href="https://jekyllrb.com/">Jekyll</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://shopify.github.io/">Liquid</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://docs.asciidoctor.org/">Asciidoctor</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="https://github.com/qqbuby/">GitHub</a>
      
      &nbsp;.&nbsp;
      
      
      <a href="/feed.xml">RSS</a>
      
      
    </div>
  </details>
  
</footer>


<!-- https://github.com/bryanbraun/anchorjs -->
<script src="/js/anchor.min.js"></script>
<script>
  anchors.add();
  anchors.remove(".site-title");
</script>




  </body>

</html>

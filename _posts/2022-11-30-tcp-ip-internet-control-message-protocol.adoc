= TCP/IP: Internet Control Message Protocol
:page-layout: post
:page-categories: ['networking']
:page-tags: ['netwoking', 'icmp']
:page-date: 2022-11-30 11:44:23 +0800
:page-revdate: 2022-11-30 11:44:23 +0800
:toc: preamble
:sectnums:

The IP protocol alone provides no direct way for an end system to learn the fate of IP packets that fail to make it to their destinations.

In addition, IP provides no direct way of obtaining diagnostic information (e.g., which routers are used along a path or a method to estimate the round-trip time).

To address these deficiencies, a special protocol called the *Internet Control Message Protocol* (*ICMP*) [RFC0792] [RFC4443] is used in conjunction with IP to provide _diagnostics_ and _control_ information related to the configuration of the IP protocol layer and the disposition of IP packets.

ICMP is often considered part of the IP layer itself, and it is required to be present with any IP implementation. It uses the IP protocol for transport.

ICMP provides for the delivery of error and control messages that may require attention.

* ICMP messages are usually acted on by the IP layer itself, by higher-layer transport protocols (e.g., TCP or UDP), and in some cases by user applications.

* Note that ICMP does not provide reliability for IP.
+
Rather, it indicates certain classes of failures and configuration information.

* The most common cause of packet drops (buffer overrun at a router) does not elicit any ICMP information.
+
Other protocols, such as TCP, handle such situations.

Because of the ability of ICMP to affect the operation of important system functions and obtain configuration information, hackers have used ICMP messages in a large number of attacks. As a result of concerns about such attacks, network administrators often arrange to _block ICMP messages with firewalls_, especially at border routers. If ICMP is blocked, however, a number of common diagnostic utilities (e.g., _ping_, _traceroute_) do not work properly [RFC4890].

In IPv6, ICMPv6 is used for several purposes beyond simple error reporting and signaling.

* It is used for _Neighbor Discovery (ND)_ [RFC4861], which plays the same role as _ARP_ does for IPv4.
* It also includes the _Router Discovery_ function used for configuring hosts and _multicast address management_.
* Finally, it is also used to help manage handoffs in _Mobile IPv6_.

== Encapsulation in IPv4 and IPv6

.Encapsulation of ICMP messages in IPv4 and IPv6. The ICMP header contains a checksum covering the ICMP data area. In ICMPv6, the checksum also covers the Source and Destination IPv6 Address, Length, and Next Header fields in the IPv6 header.
image::/assets/tcp-ip/internet-control-message-protocol/icmpv4-icmpv6-encapsulated-in-ip-packet-format.png[ICMP messages are encapsulated for transmission within IP datagrams,45%,45%]

* In IPv4, a _Protocol_ field value of _1_ indicates that the datagram caries ICMPv4.

* In IPv6, the ICMPv6 message may begin after zero or more extension headers. The last extension header before the ICMPv6 header includes a _Next Header_ field with value _58_.

* ICMP messages may be fragmented like other IP datagrams, although this is not common.

.All ICMP messages begin with 8-bit Type and Code fields, followed by a 16-bit Checksum that covers the entire message. The type and code values are different for ICMPv4 and ICMPv6.
image::/assets/tcp-ip/internet-control-message-protocol/icmp-message-format.png[ICMPv4 and ICMPv6 messages,45%,45%]

= TCP/IP: Internet Control Message Protocol
:page-layout: post
:page-categories: ['networking']
:page-tags: ['netwoking', 'icmp']
:page-date: 2022-11-30 11:44:23 +0800
:page-revdate: 2022-11-30 11:44:23 +0800
:toc: preamble
:toclevels: 4
:sectnums:

The IP protocol alone provides no direct way for an end system to learn the fate of IP packets that fail to make it to their destinations.

In addition, IP provides no direct way of obtaining diagnostic information (e.g., which routers are used along a path or a method to estimate the round-trip time).

To address these deficiencies, a special protocol called the *Internet Control Message Protocol* (*ICMP*) [RFC0792] [RFC4443] is used in conjunction with IP to provide _diagnostics_ and _control_ information related to the configuration of the IP protocol layer and the disposition of IP packets.

ICMP is often considered part of the IP layer itself, and it is required to be present with any IP implementation. It uses the IP protocol for transport.

ICMP provides for the delivery of error and control messages that may require attention.

* ICMP messages are usually acted on by the IP layer itself, by higher-layer transport protocols (e.g., TCP or UDP), and in some cases by user applications.

* Note that ICMP does not provide reliability for IP.
+
Rather, it indicates certain classes of failures and configuration information.

* The most common cause of packet drops (buffer overrun at a router) does not elicit any ICMP information.
+
Other protocols, such as TCP, handle such situations.

Because of the ability of ICMP to affect the operation of important system functions and obtain configuration information, hackers have used ICMP messages in a large number of attacks. As a result of concerns about such attacks, network administrators often arrange to _block ICMP messages with firewalls_, especially at border routers. If ICMP is blocked, however, a number of common diagnostic utilities (e.g., _ping_, _traceroute_) do not work properly [RFC4890].

In IPv6, ICMPv6 is used for several purposes beyond simple error reporting and signaling.

* It is used for _Neighbor Discovery (ND)_ [RFC4861], which plays the same role as _ARP_ does for IPv4.
* It also includes the _Router Discovery_ function used for configuring hosts and _multicast address management_.
* Finally, it is also used to help manage handoffs in _Mobile IPv6_.

== Encapsulation in IPv4 and IPv6

.Encapsulation of ICMP messages in IPv4 and IPv6. The ICMP header contains a checksum covering the ICMP data area. In ICMPv6, the checksum also covers the Source and Destination IPv6 Address, Length, and Next Header fields in the IPv6 header.
image::/assets/tcp-ip/internet-control-message-protocol/icmpv4-icmpv6-encapsulated-in-ip-packet-format.png[ICMP messages are encapsulated for transmission within IP datagrams,45%,45%]

* In IPv4, a _Protocol_ field value of _1_ indicates that the datagram caries ICMPv4.

* In IPv6, the ICMPv6 message may begin after zero or more extension headers. The last extension header before the ICMPv6 header includes a _Next Header_ field with value _58_.

* ICMP messages may be fragmented like other IP datagrams, although this is not common.

.All ICMP messages begin with 8-bit Type and Code fields, followed by a 16-bit Checksum that covers the entire message. The type and code values are different for ICMPv4 and ICMPv6.
image::/assets/tcp-ip/internet-control-message-protocol/icmp-message-format.png[ICMPv4 and ICMPv6 messages,45%,45%]

== ICMP Messages

ICMP messages are grouped into two major categories:

* those messages relating to problems with delivering IP datagrams (called _error messages_),
* and those related to information gathering and configuration (called _query_ or _informational messages_).

=== ICMPv4 Messages

For ICMPv4, the informational messages include

* _Echo Request_ and _Echo Reply_ (types _8_ and _0_, respectively),
* and _Router Advertisement_ and _Router Solicitation_ (types _9_ and _10_, respectively,
+
together called _Router Discovery_).

The most common error message types are

* _Destination Unreachable_ (type _3_),
* _Redirect_ (type _5_),
* _Time Exceeded_ (type _11_),
* and _Parameter Problem_ (type _12_).

.The standard ICMPv4 message types, as determined by the Type field*
[%header,cols="1,3,1,1,7"]
|===
|Type
|Official Name
|Reference
|E/I
|Use/Comment

|0 (*) 
|Echo Reply
|[RFC0792]
|I
|Echo (ping) reply; returns data

|3 (*)(+)
|Destination Unreachable
|[RFC0792]
|E
|Unreachable host/protocol

|4
|Source Quench
|[RFC0792]
|E
|Indicates congestion (deprecated)

|5 (*)
|Redirect
|[RFC0792]
|E
|Indicates alternate router should be used

|8 (*)
|Echo
|[RFC0792]
|I
|Echo (ping) request (data optional)

|9
|Router Advertisement
|[RFC1256]
|I
|Indicates router addresses/preferences

|10
|Router Solicitation
|[RFC1256]
|I
|Requests Router Advertisement

|11 (*)(+)
|Time Exceeded
|[RFC0792]
|E
|Resource exhausted (e.g., IPv4 TTL)

|12 (*)(+)
|Parameter Problem
|[RFC0792]
|E
|Malformed packet or header

|===

TIP: Types marked with asterisks (*) are the most common. Those marked with a plus (+) may contain [RFC4884] extension objects. In the fourth column, E is for error messages and I indicates query/informational messages.

.Common ICMPv4 message types that use code numbers in addition to 0. Although all of these message types are relatively common, only a few of the codes are commonly used.
[%header,cols="1,1,7,9"]
|===
|Type
|Code
|Official Name
|Use/Comment

|3
|0
|Net Unreachable
|No route (at all) to destination

|3 (*)
|1
|Host Unreachable
|Known but unreachable host

|3
|2
|Protocol Unreachable
|Unknown (transport) protocol

|3 (*)
|3
|Port Unreachable
|Unknown/unused (transport) port

|3 (*)
|4
|Fragmentation Needed and Don’t
Fragment Was Set (PTB message)
|Needed fragmentation prohibited by DF
bit; used by PMTUD [RFC1191]

|3
|5
|Source Route Failed
|Intermediary hop not reachable

|3
|6
|Destination Network Unknown
|Deprecated [RFC1812]

|3
|7
|Destination Host Unknown
|Destination does not exist

|3
|8
|Source Host Isolated
|Deprecated [RFC1812]

|3
|9
|Communication with Destination
Network Administratively
Prohibited
|Deprecated [RFC1812]

|3
|10
|Communication with Destination
Host Administratively Prohibited
|Deprecated [RFC1812]

|3
|11
|Destination Network Unreachable
for Type of Service
|Type of service not available (net)

|3
|12
|Destination Host Unreachable for
Type of Service
|Type of service not available (host)

|3
|13
|Communication Administratively
Prohibited
|Communication prohibited by filtering
policy

|3
|14
|Host Precedence Violation
|Precedence disallowed for src/dest/port

|3
|15
|Precedence Cutoff in Effect
|Below minimum ToS [RFC1812]

|5
|0
|Redirect Datagram for the Network
(or Subnet)
|Indicates alternate router

|5 (*)
|1
|Redirect Datagram for the Host
|Indicates alternate router (host)

|5
|2
|Redirect Datagram for the Type of
Service and Network
|Indicates alternate router (ToS/net)

|5
|3
|Redirect Datagram for the Type of
Service and Host
|Indicates alternate router (ToS/host)

|9
|0
|Normal Router Advertisement
|Router's address and configuration
information

|9
|16
|Does Not Route Common Traffic
|With Mobile IP [RFC5944], router does not
route ordinary packets

|11 (*)
|0
|Time to Live Exceeded in Transit
|Hop limit/TTL exceeded

|11
|1
|Fragment Reassembly Time
Exceeded
|Not all fragments of datagram arrived
before reassembly timer expired

|12 (*)
|0
|Pointer Indicates the Error
|Byte offset (pointer) indicates first problem
field

|12
|1
|Missing a Required Option
|Deprecated/historic

|12
|2
|Bad Length
|Packet had invalid Total Length field

|===

=== ICMPv6 Messages

Note that ICMPv6 is responsible not only for error and informational messages but also for a great deal of _IPv6 router and host configuration_.

.In ICMPv6, error messages have message types from 0 to 127. Informational messages have message types from 128 to 255. The plus (+) notation indicates that the message may contain an extension structure. Reserved, unassigned, experimental, and deprecated values are not shown.
[%header,cols="1,7,1,7"]
|===
|Type
|Official Name
|Reference
|Description

|1 (+)
|Destination Unreachable
|[RFC4443]
|Unreachable host, port, protocol

|2
|Packet Too Big (PTB)
|[RFC4443]
|Fragmentation required

|3 (+)
|Time Exceeded
|[RFC4443]
|Hop limit exhausted or
reassembly timed out

|4
|Parameter Problem
|[RFC4443]
|Malformed packet or header

|100,101
|Reserved for private experimentation
|[RFC4443]
|Reserved for experiments

|127
|Reserved for expansion of ICMPv6
error messages
|[RFC4443]
|Hold for more error messages

|128
|Echo Request
|[RFC4443]
|ping request; may contain data

|129
|Echo Reply
|[RFC4443]
|ping response; returns data

|130
|Multicast Listener Query
|[RFC2710]
|Queries multicast subscribers
(v1)

|131
|Multicast Listener Report
|[RFC2710]
|Multicast subscriber report (v1)

|132
|Multicast Listener Done
|[RFC2710]
|Multicast unsubscribe
message (v1)

|133
|Router Solicitation (RS)
|[RFC4861]
|IPv6 RS with Mobile IPv6
options

|134
|Router Advertisement (RA)
|[RFC4861]
|IPv6 RA with Mobile IPv6
options

|135
|Neighbor Solicitation (NS)
|[RFC4861]
|IPv6 Neighbor Discovery
(Solicit)

|136
|Neighbor Advertisement (NA)
|[RFC4861]
|IPv6 Neighbor Discovery
(Advertisement)

|137
|Redirect Message
|[RFC4861]
|Use alternative next-hop router

|141
|Inverse Neighbor Discovery
Solicitation Message
|[RFC3122]
|Inverse Neighbor Discovery
request: requests IPv6 addresses
given link-layer address

|142
|Inverse Neighbor Discovery
Advertisement Message
|[RFC3122]
|Inverse Neighbor Discovery
response: reports IPv6 addresses
given link-layer address

|143
|Version 2 Multicast Listener Report
|[RFC3810]
|Multicast subscriber report (v2)

|144
|Home Agent Address Discovery
Request Message
|[RFC6275]
|Requests Mobile IPv6 HA
address; send by mobile node

|145
|Home Agent Address Discovery Reply
Message
|[RFC6275]
|Contains MIPv6 HA address;
sent by eligible HA on home
network

|146
|Mobile Prefix Solicitation
|[RFC6275]
|Request home prefix while away

|147
|Mobile Prefix Advertisement
|[RFC6275]
|Provides prefix from HA to
mobile

|148
|Certification Path Solicitation Message
|[RFC3971]
|Secure Neighbor Discovery
(SEND) request for a
certification path

|149
|Certification Path Advertisement
Message
|[RFC3971]
|SEND response to certification
path request

|151
|Multicast Router Advertisement
|[RFC4286]
|Provides address of multicast
router

|152
|Multicast Router Solicitation
|[RFC4286]
|Requests address of multicast
router

|153
|Multicast Router Termination
|[RFC4286]
|Done using multicast router

|154
|FMIPv6 Messages
|[RFC5568]
|MIPv6 fast handover messages

|200,201
|Reserved for private experimentation
|[RFC4443]
|Reserved for experiments

|255
|Reserved for expansion of ICMPv6
informational messages
|[RFC4443]
|Hold for more informational
messages

|===

.ICMPv6 standard message types (i.e., Destination Unreachable, Time Exceeded, and Parameter Problem)  with codes in addition to 0 assigned
[%header,cols="1,1,7,7"]
|===
|Type
|Code
|Name
|Use/Comment

|1 
|0
|No Route to Destination
|Route not present

|1
|1
|Administratively Prohibited
|Policy (e.g., firewall) prohibited

|1
|2
|Beyond Scope of Source Address
|Destination scope exceeds source's

|1
|3
|Address Unreachable
|Used if codes 0–2 are not appropriate

|1
|4
|Port Unreachable
|No transport entity listening on port

|1
|5
|Source Address Failed
|Policy Ingress/egress policy violation

|1
|6
|Reject Route to Destination
|Specific reject route to destination

|3
|0
|Hop Limit Exceeded in Transit
|Hop Limit field decremented to 0

|3
|1
|Reassembly Time Exceeded
|Unable to reassemble in limited time

|4
|0
|Erroneous Header Field
|Found General header processing error

|4
|1
|Unrecognized Next Header
|Unknown Next Header field value

|4
|2
|Unrecognized IPv6 Option
|Unknown Hop-by-Hop or Destination option

|===

=== Processing of ICMP Messages

In ICMP, the processing of incoming messages varies from system to system.

Generally speaking, the incoming informational requests are handled automatically by the operating system, and the error messages are delivered to user processes or to a transport protocol such as TCP [RFC5461]. The processes may choose to act on them or ignore them.

Exceptions to this general rule include the Redirect message and the Destination Unreachable—Fragmentation Required messages.

* The former results in an automatic update to the host's routing table,
* whereas the latter is used in the path MTU discovery (PMTUD) mechanism, which is generally implemented by the transport-layer protocols such as TCP.

In ICMPv6 the handling of messages has been tightened somewhat. The following rules are applied when processing incoming ICMPv6 messages [RFC4443]:

. Unknown ICMPv6 error messages must be passed to the upper-layer process that produced the datagram causing the error (if possible).

. Unknown ICMPv6 informational messages are dropped.

. ICMPv6 error messages include as much of the original (_offending_) IPv6 datagram that caused the error as will fit without making the error message datagram exceed the minimum IPv6 MTU (1280 bytes).

. When processing ICMPv6 error messages, the upper-layer protocol type is extracted from the original or _offending_ packet (contained in the body of the ICMPv6 error message) and used to select the appropriate upper-layer process.
+
If this is not possible, the error message is silently dropped after any IPv6-layer processing.

. There are special rules for handling errors.

. An IPv6 node must limit the rate of ICMPv6 error messages it sends.
+
There are a variety of ways of implementing the rate-limiting function, including the _token bucket_ approach mentioned.

== ICMP Error Messages

In particular, an ICMP error message is not to be sent in response to any of the following messages: another ICMP error message, datagrams with bad headers (e.g., bad checksum), IP-layer broadcast/multicast datagrams, datagrams encapsulated in link-layer broadcast or multicast frames, datagrams with an invalid or network zero source address, or any fragment other than the first.

The reason for imposing these restrictions on the generation of ICMP errors is to limit the creation of so-called _broadcast storms_, a scenario in which the generation of a small number of messages creates an unwanted traffic cascade (e.g., by generating error responses in response to error responses, indefinitely).

An ICMPv4 error message is never generated in response to:

* An ICMPv4 error message. (An ICMPv4 error message may, however, be generated in response to an ICMPv4 query message.)
* A datagram destined for an IPv4 broadcast address or an IPv4 multicast address (formerly known as a class D address).
* A datagram sent as a link-layer broadcast.
* A fragment other than the first.
* A datagram whose source address does not define a single host.
+
This means that the source address cannot be a zero address, a loopback address, a broadcast address, or a multicast address.

An ICMPv6 error message is never generated in response to:

* An ICMPv6 error message
* An ICMPv6 Redirect message
* A packet destined for an IPv6 multicast address, with two exceptions:
** The Packet Too Big (PTB) message
** The Parameter Problem message (code 2)
* A packet sent as a link-layer multicast (with the exceptions noted previously)
* A packet sent as a link-layer broadcast (with the exceptions noted previously)
* A packet whose source address does not uniquely identify a single node.
+
This means that the source address cannot be an unspecified address, an IPv6 multicast address, or any address known by the sender to be an anycast address.

When an ICMP error message is sent, it contains

* a copy of the full IP header from the _offending_ or _original_ datagram (i.e., the IP header of the datagram that caused the error to be generated, including any IP options),
* plus any other data from the original datagram's IP payload area

such that the generated IP/ ICMP datagram's size does not exceed a specific value.

For IPv4 this value is _576_ bytes, and for IPv6 it is the IPv6 minimum MTU, which is at least _1280_ bytes.

Including a portion of the payload from the original IP datagram lets the receiving ICMP module associate the message with

* one particular _protocol_ (e.g., TCP or UDP) from the _Protocol_ or _Next Header_ field in the IP header
* and one particular _user process_ (from the TCP or UDP port numbers that are in the TCP or UDP header contained in the first 8 bytes of the IP datagram payload area).

=== Destination Unreachable (ICMPv4 Type 3, ICMPv6 Type 1) and Packet Too Big (ICMPv6 Type 2)

In ICMPv6, as compared with IPv4, the Fragmentation Required message has been replaced by an entirely different type (type 2), but the usage is very similar to the corresponding ICMP Destination Unreachable message.

==== ICMPv4 Host Unreachable (Code 1) and ICMPv6 Address Unreachable (Code 3)

This form of the Destination Unreachable message is generated by a router or host when it is required to send an IP datagram to a host using direct delivery but for some reason cannot reach the destination.

This situation may arise, for example, because the last-hop router is attempting to

* send an _ARP_ request to a host that is either missing or down.
+
[source,console]
----
root@node-0:~# tcpdump -tenv not tcp -i any
ens34 B   ifindex 3 00:0c:29:8c:df:3f ethertype ARP (0x0806), length 66: Ethernet (len 6), IPv4 (len 4), Request who-has 192.168.91.120 tell 192.168.91.128, length 46
lo    In  ifindex 1 00:00:00:00:00:00 ethertype IPv4 (0x0800), length 132: (tos 0xc0, ttl 64, id 18662, offset 0, flags [none], proto ICMP (1), length 112)
    192.168.91.128 > 192.168.91.128: ICMP host 192.168.91.120 unreachable, length 92
	(tos 0x0, ttl 64, id 33177, offset 0, flags [DF], proto ICMP (1), length 84)
    192.168.91.128 > 192.168.91.120: ICMP echo request, id 60872, seq 1, length 64
----
+
[source,console]
----
x@node-0:~$ ping -c 1 192.168.91.120
PING 192.168.91.120 (192.168.91.120) 56(84) bytes of data.
From 192.168.91.128 icmp_seq=1 Destination Host Unreachable

--- 192.168.91.120 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms
----

* For ICMPv6, this message can be the result of a failure in the _ND_ process.
+
[source,console]
----
root@node-0:~# tcpdump -tenv ip6 -i any
ens32 Out ifindex 2 00:0c:29:8c:df:3f ethertype IPv6 (0x86dd), length 92: (hlim 255, next-header ICMPv6 (58) payload length: 32) fe80::20c:29ff:fe8c:df3f > ff02::1:ff8c:df50: [icmp6 sum ok] ICMP6, neighbor solicitation, length 32, who has fe80::20c:29ff:fe8c:df50
	  source link-address option (1), length 8 (1): 00:0c:29:8c:df:3f
lo    In  ifindex 1 00:00:00:00:00:00 ethertype IPv6 (0x86dd), length 172: (flowlabel 0xa61cc, hlim 64, next-header ICMPv6 (58) payload length: 112) fe80::20c:29ff:fe8c:df3f > fe80::20c:29ff:fe8c:df3f: [icmp6 sum ok] ICMP6, destination unreachable, unreachable address fe80::20c:29ff:fe8c:df50
----
+
[source,console]
----
x@node-0:~$ ping -c 1 -6 fe80::20c:29ff:fe8c:df50
PING fe80::20c:29ff:fe8c:df50(fe80::20c:29ff:fe8c:df50) 56 data bytes
From fe80::20c:29ff:fe8c:df3f%ens32 icmp_seq=1 Destination unreachable: Address unreachable

--- fe80::20c:29ff:fe8c:df50 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms
----

==== ICMPv6 No Route to Destination (Code 0)

This message refines the Host Unreachable message from ICMPv4 to differentiate those hosts not reachable because of failure of direct delivery and those that cannot be reached because no route is present.

This message is generated only in cases where an arriving datagram must be forwarded without using direct delivery, but where no route entry exists to indicate what router to use as a next hop.

[source,console]
----
root@node-1:~# sysctl net.ipv4.ip_forward
net.ipv4.ip_forward = 1
root@node-1:~# ip r
192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.130 
root@node-1:~# tcpdump -env -t ip and not tcp -i ens32 
tcpdump: listening on ens32, link-type EN10MB (Ethernet), capture size 262144 bytes
00:0c:29:8c:df:3f > 00:0c:29:85:26:07, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 7149, offset 0, flags [DF], proto ICMP (1), length 84)
    192.168.91.128 > 192.168.92.10: ICMP echo request, id 41837, seq 1, length 64
00:0c:29:85:26:07 > 00:0c:29:8c:df:3f, ethertype IPv4 (0x0800), length 126: (tos 0xc0, ttl 64, id 37553, offset 0, flags [none], proto ICMP (1), length 112)
    192.168.91.130 > 192.168.91.128: ICMP net 192.168.92.10 unreachable, length 92
	(tos 0x0, ttl 64, id 7149, offset 0, flags [DF], proto ICMP (1), length 84)
    192.168.91.128 > 192.168.92.10: ICMP echo request, id 41837, seq 1, length 64
----

==== ICMPv4 Port Unreachable (Code 3) and ICMPv6 Port Unreachable (Code 4)

The Port Unreachable message is generated when an incoming datagram is destined for an application that is not ready to receive it.

This occurs most commonly in conjunction with UDP, when a message is sent to a port number that is not in use by any server process. If UDP receives a datagram and the destination port does not correspond to a port that some process has in use, UDP responds with an ICMP Port Unreachable message.

[source,console]
----
x@node-0:~$ echo -n "hello" | nc -4u -w0 10.170.109.10 tftp
----

[source,console]
----
root@node-0:~# tcpdump -nvv icmp or port tftp
tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 262144 bytes
09:55:42.158497 IP (tos 0x0, ttl 64, id 9924, offset 0, flags [DF], proto UDP (17), length 33)
    192.168.91.128.37775 > 192.168.91.130.69: [udp sum ok] TFTP, length 5, tftp-#26725
09:55:42.158719 IP (tos 0xc0, ttl 64, id 6641, offset 0, flags [none], proto ICMP (1), length 61)
    192.168.91.130 > 192.168.91.128: ICMP 192.168.91.130 udp port 69 unreachable, length 41
	IP (tos 0x0, ttl 64, id 9924, offset 0, flags [DF], proto UDP (17), length 33)
    192.168.91.128.37775 > 192.168.91.130.69: [udp sum ok] TFTP, length 5, tftp-#26725
----

[source,console]
----
x@node-0:~$ echo -n "hello" | nc -6u -w0 fe80::20c:29ff:fe85:2607%ens32 tftp
----

[source,console]
----
root@node-0:~# tcpdump -nvvv -s 1500 icmp6 or port tftp
tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 1500 bytes
10:12:51.993200 IP6 (flowlabel 0x9515e, hlim 64, next-header UDP (17) payload length: 13) fe80::20c:29ff:fe8c:df3f.42714 > fe80::20c:29ff:fe85:2607.69: [udp sum ok] TFTP, length 5, tftp-#26725
10:12:51.993612 IP6 (flowlabel 0x7b8d5, hlim 64, next-header ICMPv6 (58) payload length: 61) fe80::20c:29ff:fe85:2607 > fe80::20c:29ff:fe8c:df3f: [icmp6 sum ok] ICMP6, destination unreachable, unreachable port, fe80::20c:29ff:fe85:2607 udp port 69
----

==== ICMPv4 PTB (Code 4)

If an IPv4 router receives a datagram that it intends to forward, and if the datagram does not fit into the MTU in use on the selected outgoing network interface, the datagram must be fragmented.

If the arriving datagram has the _Don't Fragment_ bit field set in its IP header, however, it is not forwarded but instead is dropped, and this ICMPv4 Destination Unreachable (PTB) message is generated.

* Because the router sending this message knows the MTU of the next hop, it is able to include the MTU value in the error message it generates.

* This message was originally intended to be used for network diagnostics but has since been used for path MTU discovery.

PMTUD is used to determine an appropriate packet size to use when communicating with a particular host, on the assumption that avoiding packet fragmentation is desirable. It is used most commonly with TCP.

[source,console]
----
x@node-1:~$ sudo sysctl net.ipv4.ip_forward=1
net.ipv4.ip_forward = 1

x@node-1:~$ ip link show ens32 
2: ens32: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
    link/ether 00:0c:29:85:26:07 brd ff:ff:ff:ff:ff:ff

x@node-1:~$ sudo ip link set ens32 mtu 900

x@node-1:~$ ip a show ens32 
2: ens32: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 900 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:85:26:07 brd ff:ff:ff:ff:ff:ff
    inet 192.168.91.130/24 brd 192.168.91.255 scope global dynamic ens32
       valid_lft 1511sec preferred_lft 1511sec
----

[source,console]
----
x@node-0:~$ ip r
default via 192.168.91.130 dev ens32 
192.168.91.0/24 dev ens32 proto kernel scope link src 192.168.91.128 
x@node-0:~$ ping -c 1 -s 1000 -M do 10.170.109.10
PING 10.170.109.10 (10.170.109.10) 1000(1028) bytes of data.
From 192.168.91.130 icmp_seq=1 Frag needed and DF set (mtu = 900)

--- 10.170.109.10 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms
----

[source,console]
----
root@node-0:~# tcpdump -nvv -t icmp
tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 262144 bytes
IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto ICMP (1), length 1028)
    192.168.91.128 > 10.170.109.10: ICMP echo request, id 52044, seq 1, length 1008
IP (tos 0xc0, ttl 64, id 58248, offset 0, flags [none], proto ICMP (1), length 576)
    192.168.91.130 > 192.168.91.128: ICMP 10.170.109.10 unreachable - need to frag (mtu 900), length 556
	IP (tos 0x0, ttl 64, id 0, offset 0, flags [DF], proto ICMP (1), length 1028)
    192.168.91.128 > 10.170.109.10: ICMP echo request, id 52044, seq 1, length 1008
----

[source,console]
----
x@node-0:~$ ping -c 1 -s 1000 -M do 10.170.109.10
PING 10.170.109.10 (10.170.109.10) 1000(1028) bytes of data.
ping: local error: message too long, mtu=900

--- 10.170.109.10 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms

x@node-0:~$ ip r show cache
10.170.109.10 via 192.168.91.130 dev ens32 
    cache expires 559sec mtu 900 

x@node-0:~$ sudo ip r flush cache

x@node-0:~$ ping -c 1 -s 1000 -M do 10.170.109.10
PING 10.170.109.10 (10.170.109.10) 1000(1028) bytes of data.
From 192.168.91.130 icmp_seq=1 Frag needed and DF set (mtu = 900)

--- 10.170.109.10 ping statistics ---
1 packets transmitted, 0 received, +1 errors, 100% packet loss, time 0ms
----

==== ICMPv6 PTB (Type 2, Code 0)

In ICMPv6, a special message and type code combination is used to indicate that a packet is too large for the MTU of the next hop.

This message is not a Destination Unreachable message. Recall that in IPv6, packet fragmentation is performed only by the sender of a datagram and that MTU discovery is always supposed to be used.

==== ICMPv6 Beyond Scope of Source Address (Code 2)

IPv6 uses addresses of different scopes.

* Thus, it is possible to construct a packet with source and destination addresses of different scopes.
* Furthermore, it is possible that the destination address may not be reachable within the same scope.
+
For example, a packet with a source address using link-local scope may be destined for a globally scoped destination that requires traversal of more than one router.

Because the source address is of insufficient scope, the packet is dropped by a router, and this form of ICMPv6 error is produced to indicate the problem.

==== ICMPv6 Source Address Failed Ingress/Egress Policy (Code 5)

Code 5 is a more refined version of code 1, to be used when a particular ingress or egress filtering policy is the reason for prohibiting the successful delivery of a datagram.

This might be used, for example, when a host attempts to send traffic using a source IPv6 address from an unexpected network prefix [RFC3704].

==== ICMPv6 Reject Route to Destination (Code 6)

A _reject_ or _blocking route_ is a special routing or forwarding table entry, which indicates that matching packets should be dropped and an ICMPv6 Destination Unreachable Reject Route message should be generated.

A similar type of entry called a _blackhole route_ also causes matching packets to be dropped, but usually without generating the Destination Unreachable message.

=== Redirect (ICMPv4 Type 5, ICMPv6 Type 137)

If a router receives a datagram from a host and can determine that it is not the correct next hop for the host to have used to deliver the datagram to its destination,

* the router sends a Redirect message to the host
* and sends the datagram on to the correct router (or host).

That is, if it can determine that

* there is a better next hop than itself for the given datagram,
* it redirects the host to update its forwarding table so that future traffic for the same destination will be directed toward the new node.

This facility provides a crude form of routing protocol by indicating to the IP forwarding function where to send its packets.

.The host incorrectly sends a datagram via R2 toward its destination. R2 realizes the host’s mistake and sends the datagram to the proper router, R1. It also informs the host of the error by sending an ICMP Redirect message. The host is expected to adjust its forwarding tables so that future datagrams to the same destination go through R1 without bothering R2.
image::/assets/tcp-ip/internet-control-message-protocol/icmp-redirect-message.png[ICMP Redirect message,45%,45%]

The ICMP Redirect message includes the IP address of the router (or destination host, if it is reachable using direct delivery), a host should use as a next hop for
the destination specified in the ICMP error message.

.The ICMPv4 Redirect message includes the IPv4 address of the correct router to use as a next hop for the datagram included in the payload portion of the message. A host typically checks the IPv4 source address of the incoming Redirect message to verify that it is coming from the default router it is currently using.
image::/assets/tcp-ip/internet-control-message-protocol/icmpv4-redirect-message-format.png[ICMPv4 Redirect Message Format,45%,45%]

[source,console]
----
C:\>netstat -rn
Network Destination        Netmask          Gateway       Interface  Metric
          0.0.0.0          0.0.0.0   10.170.109.254    10.170.109.10     35

C:\> route delete 0.0.0.0 &:: delete default
C:\> route add 0.0.0.0 mask 0.0.0.0 10.170.109.112 &:: add new
C:\>ping -n 1 ds1.eecs.berkeley.edu &:: sends thru 10.170.109.112

Pinging ds1.eecs.berkeley.edu [169.229.60.105] with 32 bytes of data:
Reply from 169.229.60.105: bytes=32 time=32ms TTL=50

Ping statistics for 169.229.60.105:
    Packets: Sent = 1, Received = 1, Lost = 0 (0% loss),
Approximate round trip times in milli-seconds:
    Minimum = 32ms, Maximum = 32ms, Average = 32ms
----

[source,console]
---
Linux# tcpdump host 10.170.109.10
1 20:27:00.759340 IP 10.170.109.10 > ds1.eecs.berkeley.edu: icmp 40:
                    echo request seq 15616
2 20:27:00.759445 IP 10.170.109.112 > 10.170.109.10: icmp 68:
                    redirect ds1.eecs.berkeley.edu to host 10.170.109.254
---

.The ICMPv6 Redirect message. The target address indicates the IPv6 address of a better next-hop router for the node identified by the destination address. This message can also be used to indicate that the destination address is an on-link neighbor to the node sending the message that induced the error message. In this case, the destination and target addresses are the same.
image::/assets/tcp-ip/internet-control-message-protocol/icmpv6-redirect-message-format.png[ICMPv6 Redirect Message,45%,45%]

In ICMPv6, the Redirect message (type 137) contains the target address and the destination address, and it is defined in conjunction with the ND process.

* The _Target Address_ field contains the correct node's link-local IPv6 address that should be used for the next hop.
* The _Destination Address_ is the destination IPv6 address in the datagram that evoked the redirect.

=== ICMP Time Exceeded (ICMPv4 Type 11, ICMPv6 Type 3)

Every IPv4 datagram has a _Time-to-Live (TTL)_ field in its IPv4 header, and every IPv6 datagram has a _Hop Limit_ field in its header. Any router must decrement the _TTL_ field by at least 1.

ICMP Time Exceeded (_code 0_) messages are generated when a router discards a datagram because the _TTL_ or _Hop Limit_ field is too low (i.e., arrives with value 0 or 1 and must be forwarded).

This message is important for the proper operation of the _traceroute_ tool (called _tracert_ on Windows).

.The ICMP Time Exceeded message format for ICMPv4 and ICMPv6. The message is standardized for both the TTL or hop count being exceeded (code 0) or the time for reassembling fragments exceeding some preconfigured threshold (code 1).
image::/assets/tcp-ip/internet-control-message-protocol/icmp-time-exceeded-message-format.png[ICMP Time Exceeded Message Format,45%,45%]

Another less common variant of this message is when a fragmented IP datagram only partially arrives at its destination (i.e., all its fragments do not arrive after a period of time).

In such cases, a variant of the ICMP Time Exceeded message (_code 1_) is used to inform the sender that its overall datagram has been discarded.

Recall that if any fragment of a datagram is dropped, the entire datagram is lost.

[source,console]
----
x@node-0:~$ sudo traceroute -I -m 2 10.170.109.10
traceroute to 10.170.109.10 (10.170.109.10), 2 hops max, 60 byte packets
 1  192.168.91.130 (192.168.91.130)  0.315 ms  0.189 ms  0.160 ms
 2  192.168.91.2 (192.168.91.2)  0.190 ms  0.173 ms  0.164 ms
----

[source,console]
----
root@node-0:~# tcpdump -nvv -t icmp
tcpdump: listening on ens32, link-type EN10MB (Ethernet), snapshot length 262144 bytes
IP (tos 0x0, ttl 1, id 37515, offset 0, flags [none], proto ICMP (1), length 60)
    192.168.91.128 > 10.170.109.10: ICMP echo request, id 6913, seq 1, length 40
...
IP (tos 0x0, ttl 2, id 37518, offset 0, flags [none], proto ICMP (1), length 60)
    192.168.91.128 > 10.170.109.10: ICMP echo request, id 6913, seq 4, length 40
...
IP (tos 0xc0, ttl 64, id 28770, offset 0, flags [none], proto ICMP (1), length 88)
    192.168.91.130 > 192.168.91.128: ICMP time exceeded in-transit, length 68
	IP (tos 0x0, ttl 1, id 37515, offset 0, flags [none], proto ICMP (1), length 60)
    192.168.91.128 > 10.170.109.10: ICMP echo request, id 6913, seq 1, length 40
...
IP (tos 0x0, ttl 128, id 16816, offset 0, flags [none], proto ICMP (1), length 88)
    192.168.91.2 > 192.168.91.128: ICMP time exceeded in-transit, length 68
	IP (tos 0x0, ttl 1, id 37518, offset 0, flags [none], proto ICMP (1), length 60)
    192.168.91.128 > 10.170.109.10: ICMP echo request, id 6913, seq 4, length 40
...
----

=== Parameter Problem (ICMPv4 Type 12, ICMPv6 Type 4)

ICMP Parameter Problem messages are generated by a host or router receiving an IP datagram containing some problem in its IP header that cannot be repaired.

When a datagram cannot be handled and no other ICMP message adequately describes the problem, this message acts as a sort of _catchall_ error condition indicator.

== ICMP Query/Informational Messages

The only remaining popular ICMP query/informational messages are the Echo Request/Response messages, more commonly called _ping_, and the Router Discovery messages.

Even the Router Discovery mechanism is not in wide use with IPv4, but its analog (part of Neighbor Discovery) in IPv6 is fundamental.

In addition, ICMPv6 has been extended to support Mobile IPv6 and the discovery of multicast-capable routers.
